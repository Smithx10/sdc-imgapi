#!/usr/bin/env node
// -*- mode: js -*-
// Copyright (c) 2013, Joyent, Inc. All rights reserved.

//
// This file adds a new public key to the admin user on UFDS in preparation for
// manta support on IMGAPI. The IMGAPI zone will use the admin user on UFDS when
// authenticating to manta, so we need to add this zone's ssh keys to it
//

var exec = require('child_process').exec;
var path = require('path');
var fs = require('fs');
var assert = require('assert');

var sdc = require('sdc-clients');
var UFDS;
var ADMIN = 'admin';


function addPublicKey(cb) {
    var key = process.env.HOME + '/.ssh/id_rsa.pub';

    fs.readFile(key, 'ascii', function (err, contents) {
        if (err) {
            console.error(err, 'failed to read SSH public key %s', key);
            return cb(err);
        }

        UFDS.addKey(ADMIN, contents, function (suberr) {
            if (suberr && suberr.restCode !== 'InvalidArgument') {
                console.error(suberr, 'failed to add SSH public key for admin');
                return cb(suberr);
            } else if (suberr) {
                assert.ok(suberr.restCode === 'InvalidArgument');
                console.warn(suberr, 'failed to add SSH public key for admin');
            }

            return cb(null);
        });
    });
}


function main() {
    assert.ok(process.env.UFDS_ADMIN_IP, 'env.UFDS_ADMIN_IP');
    assert.ok(process.env.UFDS_LDAP_ROOT_DN, 'env.UFDS_LDAP_ROOT_DN');
    assert.ok(process.env.UFDS_LDAP_ROOT_PW, 'env.UFDS_LDAP_ROOT_PW');

    UFDS = new sdc.UFDS({
        url: 'ldaps://' + process.env.UFDS_ADMIN_IP,
        bindDN: process.env.UFDS_LDAP_ROOT_DN,
        bindPassword: process.env.UFDS_LDAP_ROOT_PW
    });

    addPublicKey(function (addErr) {
        if (addErr) {
            process.exit(1);
        }

        console.log('SSH public key added for admin');
        process.exit(0);
    });
}

main();
