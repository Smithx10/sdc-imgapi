---
title: Image API (IMGAPI)
markdown2extras: wiki-tables, code-friendly, cuddled-lists, link-patterns
markdown2linkpatternsfile: link-patterns.txt
apisections: Images, Channels, Miscellaneous API
---

# Image API (IMGAPI)

The Image API (or Images API, or IMGAPI) is the SDC7 replacement for the Dataset
API (DSAPI) in earlier versions of SDC. Along with the SmartOS `imgadm`
tool, various instances of the IMGAPI manage images in the SDC and SmartOS
ecosystem.


# Introduction

An "image" is virtual machine image content (e.g. a zfs dataset for a
SmartOS zone or a KVM machine image) plus [the metadata for the image (called
the "manifest")](#image-manifest-data). The following API instances and tools
are relevant for managing images in and for SmartOS and SDC.

<!-- #ifdef PRIVATE -->
The old Datasets API (DSAPI, e.g. https://datasets.joyent.com) will live
until all SDC 6 instances are done. This provides Joyent-vetted images
(a.k.a. datasets) for use in SDC 6 standups. In SDC 6, MAPI (the Master API)
running inside each datacenter manages datasets within that datacenter.
MAPI's "/datasets" endpoints provide a subset of the DSAPI API.
<!-- #endif -->

The joyent IMGAPI (https://images.joyent.com) is the central repository
of Joyent-vetted base images for usage in SmartOS. (Images from software
vendors may exist here, but are still vetted by Joyent.) All images here are
public -- no read auth, no private images. SmartOS' `imgadm` version 2
is configured to use this image repository by default. SDC's operator portal
(a.k.a. adminui) is configured by default to list this repository from which
to import images.

<!-- #ifdef PRIVATE -->
Administration of https://images.joyent.com is via the `joyent-imgadm`
tool (currently available in `git@git.joyent.com:imgapi-cli.git`).

There is an IMGAPI in each SDC datacenter that manages images available in
that datacenter. "IMGAPI" without scoping typically refers to this IMGAPI
in a given datacenter. This is the authority for which images are available
for provisioning in that DC. The provisioning process will lazily
`zfs receive` images on CNs as necessary -- streaming from the IMGAPI
(`imgadm` on that machine handles that). IMGAPI supports private images,
customer-owned images, etc. Cloud API speaks to IMGAPI for its
['/images'](https://mo.joyent.com/docs/cloudapi/master/#images) and legacy
['/datasets'](https://mo.joyent.com/docs/cloudapi/master/#datasets)
endpoints.

See [Use Cases](#use-cases) for details on how IMGAPI is (designed to be)
used.
<!-- #endif -->



<!-- #ifdef PRIVATE -->
# Current Status

- Good: The 'imgapi' zone is available and running in sdc with most endpoints
  implemented (see [API Summary](#api-summary)).

- Good: `sdc-imgadm` is available in SDC GZs for managing the datacenter's
  IMGAPI from the command-line.

- Good: `imgadm` v2 for SmartOS (imgadm v2) is in.

- Good: Manta as a storage backend support is in.

- Good: SDC 6.5 backward compatibility, i.e. providing images to 6.5 CNs
  with IMGAPI, is working fine in JPC now.

- Bad: The full process for a user creating a custom image (IMGAPI-93)
  in incomplete. See [Custom Image Management
  Roadmap](#custom-image-management-roadmap) below.

- Bad: Notably unimplemented is MigrateImage for copying images
  between datacenters in the same SDC cloud.


# Custom Image Management Roadmap

From a discussion with Trent, Bryan and Carlos 3 Jun 2013, the MVP image mgmt
plan is to:

- wait until we fully implement support for both zones and KVM (common case
  in JPC is custom KVM images);
- implement incremental images (because we need a manta for storage of
  customer images, we only have the Manta in us-east, we want image mgmt in
  other DCs so we'll pull images across the WAN, incr images will help a
  *lot* here, also a great differentiator);

Top-level ticket (FWIW) is IMGAPI-93.

## M1: basics

*Done.* (1-2 weeks) First, getting the basic full stack creation of non-KVM
images, walking up the stack from the platform level:

- [done, IMGAPI-95, trent, platform] `imgadm create` and `imgadm publish`
  'create' is just for non-KVM VMs so far
- [done, OS-2323, andres] bug in 'imgadm create' work that breaks
  'imgadm import'
- [done, AGENT-605] machine_image_create task for custom image creation
- [done, CNAPI-259] [https://mo.joyent.com/docs/cnapi/master/#VmImagesCreate]
- [done, IMGAPI-191, andres] CreateImageFromVm
- [done, PUBAPI-591, trent/pedro] CreateImageFromMachine
- [done, RELENG-491, trent]: sdc-system-tests tests for this. Create an image
  from cloudapi and use it from cloudapi.
- [done, PUBAPI-639, trent] Cloud API docs for CreateImageFromMachine.
  Hidden behind a guard so only at
  <https://mo.joyent.com/docs/cloudapi/master/#CreateImageFromMachine> for now.
- [done, PUBAPI-653, trent] enable cloudapi img mgmt endpoints for whitelist of users


## M2: incremental images

*Done.* Incremental images. Plan is that all custom images created via
cloudapi are incremental.

- [done, IMGAPI-124] incremental images support: manifest fields, CreateImage,
  AdminImportImage
- [done, OS-2401] incremental images support in 'imgadm create', 'imgadm
  install', 'imgadm import'
- [done, PUBAPI-655, trent] Get cloudapi to pass incremental:true


## M3: Working with mixed CNs

*Done.* Working with mixed CNs: some with sufficient support, some not.
This means documenting usage in a DC (e.g. JPC) for a subset of packages for
proto VMs.

- [done, DAPI-143, marsell] add handling for a min_platform package field
- [done, PAPI-22, pedro] add min_platform package field. As long as JPC is
  not switched over the PAPI, this ticket doesn't need to be completed.
- [done, IMAGE-318, carlos]: spec small set of packages using min_platform for
  use for VMs for image creation
  SYSOPS-6061 to add these to us-east-1.
- [done, IMGAPI-251, trent] add requirements.min_platform to created incremental
  images to the platform with OS-2401
- [done, AGENT-644, orlando] *6.5* provisioner agent support for incremental images
- [done, RELENG-496, john] Set up staging to more closely reflect JPC
- [done, RELENG-497, john] sdc-system-tests tests for image
  creation in the mixed CN environment in staging
- [done, IMGAPI-262, trent/ops] Add a 'img_mgmt: true' trait on the seed
  packages and the designated CNs for image creation: to ensure that CN is
  *only* used for image creation.


## M4: more basics

*Done.* The remaining scraps from M1 to help clarify required remaining work.

- [done, IMGAPI-250, andres]: state=error|creating|... for better UX for
  cloudapi's CreateImageFromMachine
- [done, IMGAPI-256, andres] imgapi zone should tune TCP for talking to Manta
- [done, IMGAPI-252, andres] placeholder images shall have a one week lifespan
- [done, IMGAPI-257, andres] get $dcname in the Manta storage of images
- [done, PUBAPI-675, trent] ability for sdc-listImages to filter on
  public/private images
- [done, PUBAPI-660, john] node-smartdc: add sdc-createimagefrommachine,
  sdc-deleteimage


## M5: Linux KVM image support

*Done.*

- [done, OS-2410, trent]: kvm support for 'imgadm create'
- [done, IMGAPI-274, trent/derek/carlos] first stab at prepare-image scripts
  (currently in smartos-vmtools2.git)
- [done, IMGAPI-269, carlos]: name linux-prepare-image
- [done, IMGAPI-270, carlos]: include shutdown into prepare-image script
- [done, IMGAPI-271, trent]: 'curl .../foo.sh | sh' oneliner for prepare-image usage.
- [done, RELENG-498, john]: tests for image creation and provisioning of kvm images


## M6: customer moving images between DCs

(~1 week)

- IMGAPI-278: CopyRemoteImage
- PORTAL-??? Does the portal deal properly with a customer's image only existing
  in a subset of DCs?


## M7: automated snapshot and prepare image

We plan to have "sdc-createimagefrommachine" handle all of steps 3-6: snapshot,
run prepare-image inside the customer's VM, shutdown, create image, rollback.
This involves:

- [done, OS-2482, joshw] "sdc:operator-script" metadata var pulling from
  `internal_metadata['operator-script']`
- [done, OS-2515, joshw] mdata:fetch/mdata:execute updates for running
  operator-script for SmartOS guests.
- [done, TOOLS-292, OS-2547, jclulow] mdata-put, improved mdata-*
- [done, 1w, OS-2550, trent] `imgadm create -s prepare-image-script` and snapshotting
- [done, 3d, IMGAPI-303, CNAPI-331, AGENT-674, trent] House the prepare-image scripts
  in IMGAPI and pass those through to the 'imgadm create' call.
- [done, 1d, IMGAPI-312, trent] min_platform to curr platform for smartos images
- [done, 1w, IMAGE-370, trent] centos guest tools: operator-script, mdata-put,
  remove prepare-image.
- [done, 1w, IMAGE-374, trent/jclulow] Package builds of the guest tools with which
  customers can upgrade proto VMs while we still have pre-"new Images with the
  latest guest tools" in play.
- [done, IMAGE-371, trent/jclulow] Old ubuntu guest tools
- [done, DOC-501, trent] img mgmt v2 user docs
- [all but freebsd done, IMAGE-375, christopher/trent] New releases of all
  (non-Windows) KVM images with the new guest tools.
- [done, IMAGE-406, ..., jclulow] Canonical Ubuntu guest tools
- [done, 2d, OS-2484, andres] incr image of incr image should use the first's origin
- [3d?, IMAGE-372, ?] debian guest tools: operator-script, mdata-put, ...
- [3d?, IMAGE-373, ?] freebsd guest tools: operator-script, mdata-put, ...
- [HEAD-1940, trent] mini-platform upgrade dependency to meaningfully deploy:
  OS-2657. See HEAD-1940 dep below as well.

Notes:

- node-smartdc polishing: error reporting on sdc-createimagefrommachine sucks.
  See the example at <http://wiki.joyent.com/wiki/display/jpc2/Troubleshooting+Image+Creation>
- polish, error case in JPC: IMGAPI-320
- cloudapi polishing:
    - cloudapi: a disabled image should still be shown via cloudapi's ListImages
      if the caller is the owner of the image. Right?
        e.g. image 5053e8fa-47bb-c4a3-baca-8aa92509cc5c in my COAL right now
        for admin user.
      "Failed" ones show, so this is totally incongruous
      Do "creating" ones show? E.g. on that gets *stuck* in creating (which
      only happens due to a bug in the create-from-vm workflow)?
      Note that "sdc-listimages" *has* a --state state option, and says
      default is "all", but it isn't including disabled ones.
      Might then want cloudapi internally to use _loadInactiveImages instead
      of _loadDisabledImages because that isn't the right separation.
- portal support: allow a "dry run" call to CreateImageFromMachine to validate
  fields?


## M8: supporting SDC image builds

*Done.*

The work required to be able to do SDC builds in JPC.

- [done, MANTA-1638, mark] This blocks IMGAPI-249
  *Note: not yet deployed.*
- [done, IMGAPI-249, andres] ExportImage endpoint
- [done, PUBAPI-674, andres]: ExportImage in cloudapi
- [done, RELENG-492 et al] get builds to work with slaves in us-east-1 JPC zones


## M9: incr of incr

Note: OS-2811 blocks doing C->A incremental images. Therefore practically
need to do C->B->A support. Plan:

- C->B->A support has been implemented (B's `origin` is A, C's `origin` is B).
- Longer term, if we want to support "C->A" once OS-2811 is fixed, then
  we could have: `imgadm create -I <A-image-uuid> ...`. This mirrors
  the `zfs snapshot -I <base-snapshot> ...` naming.

TODOs:

- [done, andres] OS-2484 'imgadm create -i' supporting incr of incr
  including the quick 'imgadm create' change and recursive origin handling
  in 'imgadm import'
- [done, andres] OS-2484 'imgadm create -i --max-origin-depth=N' support to
  allow having the create fail if the origin chain is too deep
- [done, andres] OS-2484 CreateImageFromVm: add support for passing through maxOriginDepth
- [done, andres] OS-2484 add support for passing through maxOriginDepth via
  CNAPI and provisioner agent
- [done, andres] OS-2484 Add support to AdminImportRemoteImage to do recursive
  importing
- [trent?] HEAD-1940: mini-platform upgrade. We need this to get new imgadm out in a
  timely manner to JPC.


## M10: local caching of remote image files

(3 weeks, very rough estimate) When IMGAPI's Manta is remote, then it should
intelligently cache image files locally. An obvious case is if a customer
creates an image in west-1 (which gets published to the manta in east), then
that image should be cached in west-1 for likely provisioning there.

Proposed plan tl;dr: Each IMGAPI maintains an image file MRU cache on local
disk. This is IMGAPI-235.

Proposed plan: Each IMGAPI has a size-limited local MRU cache dir. Limited by
two config vars: cacheLimitPercent, % available space on that mount
(determined at start up and periodically re-checked for resizing) and
cacheLimitSize, max absolute space (e.g. 20GB). Would also attempt to limit
to <90% total usage for that disk. File caching is only done if the stored
file is "remote". "Remote" is a boolean attribute of the "storage" config
var. IMGAPI changes to manage this cache:

- Add AdminFileCacheAdd to POST (or PUT) a file to the local cache
  (a la AddImageFile)
- Change GetImageFile: if file storage is remote, then use the local cache
  if available there. Perhaps if NOT available locally, then stream to the
  local cache. I.e., if used by one CN in this DC, then likely will be
  wanted again soon for another one.
- Change AdminGetState to also include the local file LRU cache index.
- Add AdminFileCacheFlush (perhaps, if this is useful):
  POST /state?flush-file-cache
- Change AddImageFile, if file storage is remote, to stream to the local
  file LRU cache.
- Change CreateImageFromVm, if file storage is remote, to stream to the local
  file LRU cache.
- For HA (IMGAPI-140): Change AddImageFile, if file storage is remote, to
  find other IMGAPIs in this DC and call AdminFileCacheAdd on those.

Create a followable metric (via SDC log analysis) to track GetImageFile
times to help improve this caching.


## M11: capacity handling

- [done, IMGAPI-182, IMGAPI-373, etc., andres/trent] Switch IMGAPI db to Moray
  and support limit/marker for paging through results.
- [???] Ability to have a limit of custom images per user, e.g. so that people
  don't start using custom images as a cheap/easy way to do backups.
- [???] How well does IMGAPI fail when its local dir for images files runs out
  of space? Test it.


## M12: tracking usage and billing

This is underspecified. Some notes:

- Image files are stored in manta under '/admin/imgapi', split out per customer
  (and per DC). Billing should include a line item for storage usage for each
  user.
- What about zpool usage for custom images? Marsell notes: "As an aside, what
  have the people above said about how we'll handle custom images taking up
  space in a zpool? We don't charge ourselves for our images being cached on a
  CN, but this could start presenting a serious problem once we support custom
  images." Not sure how much of an issue this will be or how best to handle
  it. Separate billing line items for this? Grace value? Zonetracker should
  track this? Usage API work to store that data.


## M13: windows support

- Windows prepare-image support
- windows image creation testing
- (somewhat indep) status/ETA of console support in portal
- [IMAGE-???] New version of guest tools for Windows.
- [jclulow] mdata-* tools support for Windows


## M14: misc

A collection of tickets that should be address for robustness, UX, etc. but
aren't strictly required for a starting rollout.

- [trent] Docs/tooling for managing the 'image-creation' packages. My plan here
  is to just come up with oneliners for these and document them in a section of
  the
  [IMGAPI Operator Guide](https://mo.joyent.com/docs/imgapi/master/#operator-guide).
    - update min_platform for a new required fix: 'sdc-ldap' can't search fields
      with an underscore, so might really want that 'sdc-ufds' replacement.
      Or sdc-packageadm.
    - list available CNs matching that platform
    - list available capacity (a quick hack script for this if we don't have
      a more complete "Capacity Aware Packages" answer by then)
    - list all VMs provisioned with these packages. Consider them "dirty" if
      they have a long life?
- [done, PUBAPI-857/PUBAPI-692, trent/andres] UpdateImage, sdc-updateimage
- PORTAL-??? How will public images from others be handled?
- [done, OS-2203, trent] provision fails when import in progress: imgadm import must
  coordinate
- [WORKFLOW-113, pedro, done?] Workflow RFE to be able to serialize jobs on
  the same vm_uuid. This to guard against an attempt to DeleteMachine
  or StartMachine on a VM being used to create an image until
  CreateImageFromMachine is complete. This isn't a blocker, *could*
  just doc this.
- [OS-???, IMGAPI-92, andres, minor] IMGAPI version header usage from imgadm for
  future proofing.


## Image Creation Test Matrix

Here are tables of tested origin images for image creation to show that
*at least once* image creation was successful with this origin image.

||**UUID**||**Name/Ver**||**Successful?**||**Requirements**||**Notes**||
||f669428c-a939-11e2-a485-b790efc0f0c1||base/13.1.0||yes||-||-||
||e3364212-05c0-11e3-9576-3f3ee9e951a7||base/13.2.0||yes||-||-||
||b83f8276-1fdd-11e3-989b-4bddb088a8a0||base/13.2.1||yes||-||-||
||753ceee6-5372-11e3-8f4e-f79c1154e596||base/13.3.0||yes||-||-||
||dee73ee2-69ab-11e3-b593-a3f1f80ef403||base/13.3.1||yes||-||-||
||2b683a82-a066-11e3-97ab-2faa44701c5a||base/13.4.0||yes||-||-||
||9eac5c0c-a941-11e2-a7dc-57a6b041988f||base64/13.1.0||yes||-||-||
||0084dad6-05c1-11e3-9476-8f8320925eea||base64/13.2.0||yes||-||-||
||17c98640-1fdb-11e3-bf51-3708ce78e75a||base64/13.2.1||yes||-||-||
||87b9f4ac-5385-11e3-a304-fb868b82fe10||base64/13.3.0||yes||-||-||
||c353c568-69ad-11e3-a248-db288786ea63||base64/13.3.1||yes||-||-||
||ff86eb8a-a069-11e3-ae0e-4f3c8983a91c||base64/13.4.0||yes||-||-||
||c56ed646-82d8-11e3-849e-eb2c0535bf06||java/13.3.1||???||-||-||
||81223438-7874-11e3-9edf-8f1e15269924||nodejs/13.3.1||yes||-||-||
||e7061478-9975-11e3-9e42-f3f53beea0c6||postgresql/13.3.1||yes||-||-||
||6d03452a-9a3c-11e3-8773-23a29a9b75d8||hadoop/13.3.1||yes||-||-||
||40d56fc2-788c-11e3-8e0e-ab90eb060ee7||standard/13.3.1||no||-||apache in maint, IMAGE-461||
||74c3b232-7961-11e3-a7a7-935768270b93||standard64/13.3.1||no||-||apache in maint, IMAGE-461||
||87c556ac-ab9d-11e2-914d-07682fcab47d||centos-6/2.4.1||???||guest tools upgrade||-||
||30e9e4c8-bbf2-11e2-ac3b-3b598ee13393||centos-6/2.4.2||???||guest tools upgrade||-||
||325dbc5e-2b90-11e3-8a3e-bfdcb1582a8d||centos-6/2.5.0||yes||guest tools upgrade||-||
||df81f45e-8f9f-11e3-a819-93fab527c81e||centos-6/2.6.0||yes||-||-||
||3162a91e-8b5d-11e2-a78f-9780813f9142||ubuntu-12.04/2.4.0||???||-||-||
||da144ada-a558-11e2-8762-538b60994628||ubuntu-12.04/2.4.1||???||-||-||
||d2ba0f30-bbe8-11e2-a9a2-6bc116856d85||ubuntu-12.04/2.4.2||yes||guest tools upgrade||-||
||a0b441cc-22ac-40c8-a21f-345b734444ec||ubuntu-certified-12.04/20140219||yes||-||-||
||46407334-9096-40ef-bb72-6f9a094f0507||ubuntu-certified-13.10/20140219||yes||-||-||
||96aae6e5-c130-44aa-a4e3-d2394591eee5||ubuntu-certified-13.10/20140410||yes||-||-||


I *think* the current img creation supported state is the following, but this
test matrix is here to clarify that:

- centos 2.6.0 or greater
- ubuntu-certified (all)
- base 13.3.x or greater
- base64 13.3.x or greater
- (other derivatives of base/base64, e.g. standard) 13.3.1 or greater
- special cases (though for simpler instructions we aren't explicitly
  mentioning these)
  - a few older centos and ubuntu with a guest tools upgrade
  - possibly could support older base-derivatives with a guest tools upgrade
    (to get DATASET-934 fix), but we don't provide a package for doing that
    right now

Here is how to generate the template for this table:

    sdc-imgadm list public=true -H -o type,name,published,version,uuid | sort \
        | awk '{print $5 " " $2 " " $4}' \
        | while read line; do printf "||%s||%s/%s||???||-||-||\n" $line; done




### images for which image creation is *unsupported*

Note that for many of these images the image creation process will naively
*work*. However VMs provisioned using those custom images will likely break
in various ways.

Some of these are unsupported because they are older versions, with recent
versions in that image family being supported. Some are unsupported OSes
or licensed product lines.

Regarding "stm" (Riverbed Stringray) images. I'm not going to test those right
now. Not clear that image mgmt is a req for them. If any, possibly for the
license-unencumbered one: "stm-developer".


||**UUID**||**Name/Ver**||**Notes**||
||55330ab4-066f-11e2-bd0f-434f2462fada||base/1.8.1||-||
||84cb7edc-3f22-11e2-8a2a-3f2a7b148699||base/1.8.4||-||
||60ed3a3e-92c7-11e2-ba4a-9b6d5feaa0c4||base/1.9.1||-||
||60a3b1fa-0674-11e2-abf5-cb82934a8e24||base64/1.8.1||-||
||fdea06b0-3f24-11e2-ac50-0b645575ce9d||base64/1.8.4||-||
||cf7e2f40-9276-11e2-af9a-0bad2233fb0b||base64/1.9.1||-||
||bae3f528-e01f-11e2-b2cb-1360087a7d5f||cassandra/13.1.0||-||
||274bc2bc-d919-11e2-b797-83245409fbeb||hadoop/13.1.0||-||
||48489174-e351-11e2-88c0-a31eb2b342ee||java/13.1.0||-||
||2c6b0348-d8f6-11e2-91f4-ef498b553611||manta-build/13.1.0||-||
||ec5defa8-16fe-11e3-948e-8f59b3488902||mongodb/13.2.0||-||
||d2409672-29f3-11e3-ba86-6f782523cb41||mongodb/13.2.1||-||
||f953e97e-4991-11e1-9ea4-27c6e7e8afda||nodejs/1.3.3||-||
||1fc068b0-13b0-11e2-9f4e-2f3f6a96d9bc||nodejs/1.4.0||-||
||beb2dbd4-b26f-11e2-8ad4-935c80092aa6||nodejs/13.1.0||-||
||ffed3d9e-2c2f-11e3-9a12-bf5267821b0b||nodejs/13.2.1||-||
||133263be-3c2c-11e3-8d3a-a30c43ae58fd||nodejs/13.2.2||-||
||dc1a8b5e-043c-11e2-9d94-0f3fcb2b0c6d||percona/1.6.0||-||
||3882b5da-b0e8-11e2-b3a9-dbcf26c3e051||percona/13.1.0||-||
||fb6e7820-60ee-11e3-93b6-7f34ea3f2616||percona/13.3.0||-||
||1567edb0-b33e-11e2-a0d2-bf73e2825ffe||riak/13.1.0||-||
||489754f2-5e01-11e1-8ff8-f770c2116b0d||smartos/1.5.4||Image should be deprecated, right?||
||01b2c898-945f-11e1-a523-af1afbe22822||smartos/1.6.3||Image should be deprecated, right?||
||31bc4dbe-5e06-11e1-907c-5bed6b255fd1||smartos64/1.5.4||Image should be deprecated, right?||
||f9e4be48-9466-11e1-bc41-9f993f5dff36||smartos64/1.6.3||Image should be deprecated, right?||
||3390ca7c-f2e7-11e1-8818-c36e0b12e58b||standard/1.0.7||-||
||34509f68-1ae7-11e3-b816-d3edf71c7840||standard/13.2.0||-||
||dac2ad6e-2aa5-11e3-885f-8fd408fc6a82||standard/13.2.1||-||
||56a0655c-3cc6-11e3-9c79-5701599fdf05||standard/13.2.3||-||
||a0f8cf30-f2ea-11e1-8a51-5793736be67c||standard64/1.0.7||-||
||399775e4-163e-11e3-8d42-7b14b732ae17||standard64/13.2.0||-||
||b779b49a-29e4-11e3-9b1d-0b0b41ccdcad||standard64/13.2.1||-||
||610e04c4-3cc4-11e3-9867-df64b21b66fe||standard64/13.2.3||-||
||3cd9ef64-1fa5-11e3-be45-1fa28ec74f4a||stm-1000H/13.2.0||Need we support custom stm?||
||efe2c3e8-1fb8-11e3-b4c4-eb64d18f0b71||stm-1000M/13.2.0||Need we support custom stm?||
||6e99eff4-1fb9-11e3-9d00-3b6b25be1e62||stm-1000M-SAF/13.2.0||Need we support custom stm?||
||ef905526-1fb9-11e3-a095-576400e02b54||stm-2000L/13.2.0||Need we support custom stm?||
||6bf3c40e-1fba-11e3-9847-4f44ccd9abe9||stm-2000L-SAF/13.2.0||Need we support custom stm?||
||0bcda78c-2066-11e3-8f62-d7edf9742dbd||stm-2000L-SAF-STX/13.2.0||Need we support custom stm?||
||36f3b80c-2066-11e3-9215-5ffe647b58f0||stm-2000L-STX/13.2.0||Need we support custom stm?||
||08c63ac6-2067-11e3-abea-a7c7c71e8f15||stm-2000M-SAF-STX/13.2.0||Need we support custom stm?||
||8b503466-2066-11e3-b5c8-c7e50b85619c||stm-2000M-STX/13.2.0||Need we support custom stm?||
||e96103b6-1fba-11e3-8dba-3b2f9d336fa1||stm-4000L/13.2.0||Need we support custom stm?||
||67e5fc46-1fbb-11e3-b1c7-274da29ae2f6||stm-500L-10/13.2.0||Need we support custom stm?||
||e4093946-1fbb-11e3-8b61-bb9e496e0da4||stm-500M-200/13.2.0||Need we support custom stm?||
||4b4c141e-1fb4-11e3-a10e-6f99cfdf8806||stm-developer/13.2.0||Need we support custom stm?||
||2539f6de-0b5a-11e2-b647-fb08c3503fb2||centos-5.7/1.3.0||-||
||e4cd7b9e-4330-11e1-81cf-3bb50a972bda||centos-6/1.0.1||-||
||8700b668-0da4-11e2-bde4-17221283a2f4||centos-6/1.3.0||-||
||46ecf60e-52c8-11e2-b212-9b51fc749547||debian-6.0.6/2.3.1||-||
||014e2254-a853-11e2-81c9-b318c31fa17a||debian-6.0.7/2.4.1||-||
||94384a12-bbeb-11e2-aec2-2bfa9742484b||debian-6.0.7/2.4.2||-||
||e6ac6784-44b3-11e1-8555-87c3dd87aafe||debian-6.03/1.0.0||-||
||e42f8c84-bbea-11e2-b920-078fab2aab1f||fedora/2.4.2||-||
||71101322-43a5-11e1-8f01-cf2a3031a7f4||ubuntu-10.04/1.0.1||-||
||64e1b2ee-52c8-11e2-bedd-7f919cc63ab9||ubuntu-12.04/2.3.1||-||
||13328c9a-9173-11e2-a9a5-2ff43d306c21||ws2008ent-r2-sp1/2.0.2||-||
||5f101d16-90ac-11e2-b9c2-877979ff6041||ws2008std-r2-sp1/2.0.2||-||
||95f6c9a6-a2bd-11e2-b753-dbf2651bf890||ws2012std/1.0.1||-||

<!-- #endif -->



# Image manifests

An image manifest is all the data about an image except the image file itself.
Generally this is represented as a JSON object. For example:

    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
      "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
      "name": "smartos",
      "version": "1.6.3",
      "state": "active",
      "disabled": false,
      "public": true,
      "published_at": "2012-05-02T15:14:45.805Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "description": "Base template to build other templates on",
      "requirements": {
        "networks": [
          {
            "name": "net0",
            "description": "public"
          }
        ]
      }
    }


A summary of fields (details are provided below):

||**Field**||**Type**||**Always Present?**||**Mutable?**||**Notes**||
||[v](#manifest-v)||Integer||Yes||No||Version of the manifest format/spec. The current value is **2**.||
||[uuid](#manifest-uuid)||UUID||Yes||No||The unique identifier for a UUID. This is set by the IMGAPI server. See details below.||
||[owner](#manifest-owner)||UUID||Yes||Yes||The UUID of the owner of this image (the account that created it).||
||[name](#manifest-name)||String||Yes||No||A short name for this image. Max 512 characters (though practical usage should be much shorter). No uniqueness guarantee.||
||[version](#manifest-version)||String||Yes||No||A version string for this image. Max 128 characters. No uniqueness guarantee.||
||[description](#manifest-description)||String||No||Yes||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||Yes||Homepage URL where users can find more information about the image.||
||[eula](#manifest-eula)||URL||No||Yes||URL of the End User License Agreement (EULA) for the image.||
||[icon](#manifest-icon)||Boolean||No||Yes (\*)||Indicates if the image has an icon file. If not present, then no icon is present.||
||[state](#manifest-state)||String||Yes||No||The current state of the image. One of 'active', 'unactivated', 'disabled', 'creating', 'failed'.||
||[error](#manifest-error)||Object||No||No||An object with details on image creation failure. It only exists when `state=='failed'`.||
||[disabled](#manifest-disabled)||Boolean||Yes||No (\*)||Indicates if this image is available for provisioning.||
||[public](#manifest-public)||Boolean||Yes||Yes (\*)||Indicates if this image is publicly available.||
||[published_at](#manifest-published_at)||Date||Yes (if activated)||No||The date at which the image is activated. Set by the IMGAPI server.||
||[type](#manifest-type)||String||Yes||Yes||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, "zvol" for a virtual machine image or "other" for image types that serve any other specific purpose.||
||[os](#manifest-os)||String||Yes||Yes||The OS family this image provides. One of "smartos", "windows", "linux" or "other".||
||[origin](#manifest-origin)||UUID||No||No||The origin image UUID if this is an incremental image.||
||[files](#manifest-files)||Array||Yes (if activated)||No||An array with a single object describing the image file.||
||[acl](#manifest-acl)||Array||No||Yes||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[requirements](#manifest-requirements)||Object||No||Yes||A set of named requirements for provisioning a VM with this image||
||[requirements.networks](#manifest-requirementsnetworks)||Array||No||Yes||Defines the minimum number of network interfaces required by this image.||
||[requirements.brand](#manifest-requirementsbrand)||String||No||Yes||Defines the brand that is required to provision with this image.||
||[requirements.ssh_key](#manifest-requirementsssh_key)||Boolean||No||Yes||Indicates that provisioning with this image requires that an SSH public key be provided.||
||[requirements.min_ram](#manifest-requirementsmin_ram)||Integer||No||Yes||Minimum RAM (in MiB) required to provision this image.||
||[requirements.max_ram](#manifest-requirementsmax_ram)||Integer||No||Yes||Maximum RAM (in MiB) this image may be provisioned with.||
||[requirements.min_platform](#manifest-requirementsmin_platform)||Object||No||Yes||Minimum platform requirement for provisioning with this image.||
||[requirements.max_platform](#manifest-requirementsmax_platform)||Object||No||Yes||Maximum platform requirement for provisioning with this image.||
||[users](#manifest-users)||Array||No||Yes||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||No||Yes||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||No||Yes||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[tags](#manifest-tags)||Object||No||Yes||An object of key/value pairs that allows clients to categorize images by any given criteria.||
||[generate_passwords](#manifest-generate-passwords)||Boolean||No||Yes||A boolean indicating whether to generate passwords for the users in the "users" field. If not present, the default value is true.||
||[inherited_directories](#manifest-inherited-directories)||Array||No||Yes||A list of inherited directories (other than the defaults for the brand).||
||[nic_driver](#manifest-nic-driver)||String||Yes (if `type==="zvol"`)||Yes||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||Yes (if `type==="zvol"`)||Yes||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||Yes (if `type==="zvol"`)||Yes||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||Yes (if `type==="zvol"`)||Yes||The size (in MiB) of this VM image's disk.||
||[channels](#manifest-channels)||Array||Yes (if server uses channels)||Yes||Array of channel names to which this image belongs.||

"Mutable?" refers to whether this field can be edited via
[UpdateImage](#UpdateImage). The `icon` boolean is effectively changed by
the [AddImageIcon](#AddImageIcon) and [DeleteImageIcon](#DeleteImageIcon)
endpoints. `disabled` can be modified via the [DisableImage](#DisableImage)
and [EnableImage](#EnableImage) endpoints. `public` cannot be set false for
an image on the "public mode" IMGAPI, e.g. <https://images.joyent.com>.


## Manifest: v

A single positive integer indicating the spec version of the image
manifest. The current version is **2**. Version history:

||**v**||**Date**||**Notes**||
||undefined||-||All dataset manifests (commonly ".dsmanifest" files) before SDC 7 do not have a "v" field. Versioning of the manifest via `v` was added in SDC 7. This is commonly referred to as version "1".||
||2||2013-Jan-31||Adds many fields. Deprecates `urn`. Removes already deprecated fields (e.g. `platform_type`). See the "imgmanifest" library for full details.||


## Manifest: uuid

An image `uuid` is the unique identifier for this UUID. This is what you
use to provision a VM. (For backwards compatibility unique identification
via a `urn` field is supported for legacy images. See the [urn section
below](#manifest-urn).)

An image UUID is created by the server on the [CreateImage](#CreateImage).
There are two exceptions: (1) The [MigrateImage](#MigrateImage) endpoint will
copy an image between two datacenters in the same cloud and persist the
UUID. (2) SDC operators can use the [AdminImportImage](#AdminImportImage)
to add an image with a specified UUID. In the latter case it is the
responsibility of the operator to ensure a given UUID is not duplicated,
or refers to different image data between separate clouds. A common case
for the latter is importing "core" Joyent-provided images from
<https://images.joyent.com>.


## Manifest: urn

**Deprecated.**  In SDC versions before SDC 7, an image (then called a
"dataset") could be uniquely identified by its `uuid` *and* by its `urn`.
While this is still true (images with a URN imported into IMGAPI retain
their URN), new images do not get a URN. The assumptions for the components
of URN (`<cloud_name>:<creator_name>:<name>:<version>`) are not maintainable
in global ecosystem of SmartOS images. Therefore the URN has been dropped as
a supported mechanism of uniquely identifying images. Use the `uuid` field.


## Manifest: owner

The account UUID of the owner/creator of this image.
In non-"dc" mode IMGAPI repositories (where there is no user database) this
value has no meaning.


## Manifest: name

A name for this image. Maximum 512 characters. However, typical names should
be much shorter, e.g. 5-20 characters.

Note that image `name` and `version` do not make a unique identifier for
an image. Separate users (and even the same user) can create images with
the same name and version. The image `uuid` is the only unique identifier
for an image.


## Manifest: version

A version string for this image. Maximum 128 characters. This is an opaque
string, i.e. no particular format or structure is enforced and
no ordering with other versions is implied. However, it is strongly suggested
that the [semver](http://semver.org/) versioning scheme be
followed. Further, the simple `Major.Minor.Patch` semver subset is ideal.

Note that image `name` and `version` do not make a unique identifier for
an image. Separate users (and even the same user) can create images with
the same name and version. The image `uuid` is the only unique identifier
for an image.


## Manifest: description

A short prose description of this image. Maximum 512 characters.


## Manifest: homepage

Homepage URL where users can find more information about the image. Maximum 128
characters.

## Manifest: eula

URL of the End User License Agreement (EULA) for the image. Maximum 128
characters.

## Manifest: icon

A boolean indicates if the image has an icon file. If this field is not
present then the image does not have an icon. The actual icon file content
is available via the [GetImageIcon](#GetImageIcon) endpoint.


## Manifest: state

The current state of the image. One of the following values:

||**State**||**Description**||
||active||The image is ready for use, i.e. VMs can be provisioned using this image.||
||unactivated||The image has not yet been activated. See [ActivateImage](#ActivateImage).||
||disabled||The image is disabled. This will be the state if the image is activated, but also `disabled == true`. See [EnableImage](#EnableImage) and [DisableImage](#DisableImage).||
||creating||A state for a placeholder image while an image is being asynchronously created. This is used during [CreateImageFromVm](#CreateImageFromVm).||
||failed||A state for a placeholder image indicating that asynchronous image creation failed. See the `error` field for details.||

Note that [`disabled`](#manifest-disabled) and [`state`](#manifest-state) can
seem like duplicate information. However `state` is a computed value from
`disabled` and whether an image has yet been activated.

Images with state `creating` or `failed` are called "placeholder images" --
there is no actual image. Placeholder images are reaped after one week to
prevent very old failures swamping data.



## Manifest: error

An object providing details on failure of some asynchronous image action.
Currently this is used during [CreateImageFromVm](#CreateImageFromVm). It is
only present with `state == 'failed'`. Error fields are as follows:

||**Field**||**Always Present?**||**Details**||
||message||Yes||String description of the error.||
||code||No||A "CamelCase" string error code.||
||stack||No||A stack trace giving context for the error. This is generally considered internal implementation detail, only there to assist with debugging and error classification.||

Possible `error.code` values from current SmartDataCenter and SmartOS:

|| **error.code** || **Details** ||
|| PrepareImageDidNotRun || This typically means that the target KVM VM (e.g. Linux) has old guest tools that pre-date the image creation feature. Guest tools can be upgraded with installers at <https://download.joyent.com/pub/guest-tools/>. Other possibilities are: a boot time greater than the 5 minute timeout or a bug or crash in the image preparation script. ||
|| VmHasNoOrigin || Origin image data could not be found for the VM. Either the link to the image from which the VM was created has been broken (e.g. via 'zfs promote' or migration, see SYSOPS-6491) or there is some problem in either the 'image_uuid' value from `vmadm get` or in imgadm's DB of manifest info for that image. ||
|| NotSupported || Indicates an error due to functionality that isn't currently supported. One example is that custom image creation of a VM based on a custom image isn't currently supported. ||



## Manifest: disabled

A boolean indicating if this image is disabled. A disabled image is only
visible to its owner in cloudapi. A disabled image cannot be used for
provisioning.

The [DisableImage](#DisableImage) and [EnableImage](#EnableImage) api
endpoints can be used to update the disabled state of an image.

Note that [`disabled`](#manifest-disabled) and [`state`](#manifest-state) can
seem like duplicate information. However `state` is a computed value from
`disabled` and whether an image has yet been activated.


## Manifest: public

A boolean indicating if this image is publicly available. Public images are
visible (and usable for provisioning) to anyone in cloudapi. Private images
(`public === false`) are only visible to the image owner and accounts listed
in [`acl`](#manifest-acl).


## Manifest: published_at

The date (in ISO-8601 format, e.g. "2012-05-02T15:14:45.805Z") at which this
image was published (i.e. activated via [ActivateImage](#ActivateImage)).

An image UUID is create by the server on the [ActivateImage](#ActivateImage).
There are two exceptions: (1) The [MigrateImage](#MigrateImage) endpoint will
copy an image between two datacenters in the same cloud and persist the
`published_at`. (2) SDC operators can use the
[AdminImportImage](#AdminImportImage) to add an image with a specified uuid
and `published_at`. A common case for the latter is importing "core"
Joyent-provided images from <https://images.joyent.com>.


## Manifest: type

The type of the image file. Must be one of:

||**TYPE**||**DESCRIPTION**||
||zone-dataset||a ZFS dataset used to create a new SmartOS zone||
||zvol||a KVM virtual machine image||
||other||an image that serves any other specific purpose||


## Manifest: os

The operating system of the image file. Must be one of:

||**OS**||**DESCRIPTION**||
||smartos||SmartOS||
||linux||Linux, e.g. CentOS, Ubuntu, etc.||
||windows||A Microsoft Windows OS image||
||bsd||FreeBSD/netBSD||
||illumos||Illumos||
||other||A catch-all for other operating systems.||


## Manifest: origin

If an image has an origin, then it is an **incremental image**. The origin is
the UUID of the origin image. Currenly only a single level of parentage is
allowed. I.e. an origin image cannot itself be incremental.


## Manifest: files

The array of image files that make up this image. Currently only a single
file is supported. An image cannot be activated until it has one file
uploaded. A "file" entry has the following fields:

||**FIELD**||**DESCRIPTION**||
||sha1||SHA-1 hex digest of the file content. Used for upload/download corruption checking.||
||size||Number of bytes. Maximum 20GiB. This maximum is meant to be a "you'll never hit it" cap, the purpose is to inform cache handling in IMGAPI servers.||
||compression||The type of file compression used by the file. One of 'bzip2', 'gzip', 'none'.||
<!-- #ifdef PRIVATE -->
||dataset_guid||Optional. The ZFS internal unique identifier for this dataset's snapshot (available via `zfs get guid SNAPSHOT`, e.g. `zfs get guid zones/f669428c-a939-11e2-a485-b790efc0f0c1@final`). If available, this is used to ensure a common base snapshot for incremental images (via `imgadm create -i`) and VM migrations (via `vmadm send/receive`).||
<!-- #endif -->

Example:

    {
        ...
        "files": [{
            "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
            "size": 46271847,
            "compression": "bzip2"
        }],
        ...
    }

**Backward compatibility notes:** In the DSAPI (Dataset API) from SDC 6.5
that preceded this there were two more fields:

- `files.*.path`: **Obsolete.** This field is no longer provided. It served
  no safe purpose. There was no guarantee that that "path" value was unique
  across images, hence it should not be used client-side.
- `files.*.url`: **Obsolete.** This field is no longer provided. The download
  URL for the image file is
  [`GET /images/:uuid/file` GetImageFile](#GetImageFile).


## Manifest: acl

An array of user/account UUIDs to which to give read access to a private
image. I.e. this is only relevant for images with `public === false`.


## Manifest: requirements

A grouping of various requirements for provisioning a VM with this image.


## Manifest: requirements.networks

Optional. An array describing the minimum number of network interfaces. This
example shows an image that requires one VNIC:

    {
        ...
        "requirements": {
            "networks": [{"name": "net0", "description": "public"}]
            ...
        },
        ...
    }

## Manifest: requirements.brand

Optional. Defines the brand that is required to provision with this image.
Brands are related to the type of virtualization used among other factors.
Currently there are four brands that can be used: 'joyent', 'joyent-minimal',
'sngl' for OS virtualization and 'kvm' for hardware virtualization.

## Manifest: requirements.ssh_key

Optional. A boolean indicating that provisioning with this image requires
that an SSH public key be provided. For example, provisioning a Linux VM
requires an SSH key for initial SSH access. If not defined, it is presumed to
be false.

## Manifest: requirements.min_ram

Optional. `min_ram` is an integer number of MiB specifying the minimum RAM
required to provision this image. If `max_ram` is also specified, then
`min_ram <= max_ram` must be true.

## Manifest: requirements.max_ram

Optional. `max_ram` is an integer number of MiB specifying the maximum RAM
this image may provisioned with. If `min_ram` is also specified, then
`min_ram <= max_ram` must be true.

## Manifest: requirements.min_platform

Optional. `min_platform` defines the minimum required SmartOS platform on
which this image can be used (and hence in SDC on which it will be
provisioned). It is a mapping of major "SDC Version" to the SmartOS platform
timestamp. E.g.:

    "min_platform": {"6.5": "20120901T113025Z", "7.1": "20130308T102805Z"}

This says that the image can only be used on SDC 6.5 platforms later than or
equal to "20120901T113025Z" or SDC 7.1 platforms later than or equal to
"20130308T102805Z".

The SDC version and platform timestamp values correspond to the `sysinfo`
"SDC Version" and "Live Image" keys respectively, e.g.:

    $ sysinfo | json "SDC Version"
    7.0
    $ sysinfo | json "Live Image"
    20130309T172903Z

Note that SDC versions before 7.0 did not have a "SDC Version" key in
sysinfo. If necessary the following may be used to get the appropriate value:

    test -z "$(sysinfo | json "SDC Version")" \
        && echo "6.5" \
        || echo $(sysinfo | json "SDC Version")

If `min_platform` is set but does not contain a key for your SDC version,
then:

1. if SDC version is less than the lowest key, e.g. if "6.4" for the example
   above, then this image **may not** be used on this platform
2. if SDC version is greater than the lowest key, e.g. if "7.0" for the example
   above, then this image **may** be used on this platform. This rule could
   have gone either way, depending on circumstances, hence the decision to
   *allow* in the face of ambiguity.


## Manifest: requirements.max_platform

Optional. `max_platform` defines the maximum allowed SmartOS platform on
which this image can be used (and hence in SDC on which it will be
provisioned). It is a mapping of major "SDC Version" to the SmartOS platform
timestamp. E.g.:

    "max_platform": {"6.5": "20120901T113025Z", "7.1": "20130308T102805Z"}

This says that the image can only be used on SDC 6.5 platforms less than or
equal to "20120901T113025Z" or SDC 7.1 platforms less than or equal to
"20130308T102805Z".

The SDC version and platform timestamp values correspond to the `sysinfo`
"SDC Version" and "Live Image" keys respectively, e.g.:

    $ sysinfo | json "SDC Version"
    7.0
    $ sysinfo | json "Live Image"
    20130309T172903Z

Note that SDC versions before 7.0 did not have a "SDC Version" key in
sysinfo. If necessary the following may be used to get the appropriate value:

    test -z "$(sysinfo | json "SDC Version")" \
        && echo "6.5" \
        || echo $(sysinfo | json "SDC Version")

If `max_platform` is set but does not contain a key for your SDC version,
then:

1. if SDC version is greater than the highest key, e.g. if "7.2" for the example
   above, then this image **may not** be used on this platform
2. if SDC version is greater than the lowest key, e.g. if "7.0" for the example
   above, then this image **may** be used on this platform. This rule could
   have gone either way, depending on circumstances, hence the decision to
   *allow* in the face of ambiguity.


## Manifest: users

Optional. `users` is a list of users for which passwords should be generated
for provisioning. This may only make sense for some datasets. Example:

    "users": [{"name": "root"}, {"name": "admin"}]

## Manifest: billing_tags

Optional. A list of tags that can be used by operators for additional billing
processing. This attribute can be useful for derivative images when the child
image object needs to be related to the parent image for billing or licensing
purposes. Example:

    "billing_tags": ["oracle", "rhel"]

## Manifest: traits

Optional. An object that defines a collection of properties that is used by
other APIs to evaluate where should customer VMs be placed. The keys allowed in
this object are application specific, but only strings, booleans or arrays of
strings are allowed for their values. Example:

    "traits": {
        "users": ["ef5d70c0-5281-154a-9f05-fad0ff43181e],
        "hw": ["richmond-a"],
        "over-provision-ram": "2.5"
    }

## Manifest: tags

Optional. An object of key/value pairs that allows clients to categorize images
by any given criteria. The keys allowed in this object are application specific,
but only strings, numbers or booleans are allowed for their values.
Example:

    "tags": {
      "role": "db",
      "license": "gpl"
    }

## Manifest: generate_passwords

Optional. `generate_passwords` is a boolean indicating whether to generate
passwords for the users in the "users" field. If not present, the default
value is true.

## Manifest: inherited_directories

Optional. `inherited_directories` is a list of inherited directories (other
than the defaults for the brand). This can be left out or the empty list if
the dataset need not inherit directories. This field only makes sense for
datasets of type "zone-dataset". Example:

    {
        ...
        "inherited_directories": ["/opt/support"],
        ...
    }


## Manifest: nic_driver

The NIC driver used by this VM image. Examples are 'virtio', 'ne2k_pci',
'rtl8139', 'e1000', 'pcnet'.
This is a required field for `type === "zvol"` images.


## Manifest: disk_driver

The disk driver used by this VM image. Examples are 'virtio', 'ide', 'scsi'.
This is a required field for `type === "zvol"` images.


## Manifest: cpu_type

The QEMU CPU model to use for this VM. Examples are: "qemu64", "host".
This is a required field for `type === "zvol"` images.


## Manifest: image_size

The size (in MiB) of the VM's disk, and hence the required size of allocated
disk for provisioning.
This is a required field for `type === "zvol"` images.


## Manifest: channels

Array of channel names to which this image belongs. This is only present
and relevant for images in an IMGAPI server that uses [channels](#channels).



<!-- #ifdef PRIVATE -->
# Use Cases

Here we look at some SDC use cases that touch on IMGAPI, and hence drive
its design.


## Use Case 1: Bootstrap SDC core zones' images on headnode setup

**Status**: complete.

[headnode.sh](https://mo.joyent.com/usb-headnode/blob/master/scripts/headnode.sh)
(see "/var/svc/log/system-smartdc-init:default.log") calls this:

    /opt/smartdc/bin/sdc-imgadm import -m $manifest -f $file

for all images used to provision SDC core zones.


## Use Case 2: Operator adds new images.joyent.com image to the DC

**Status**: complete (TODO: does adminui support this yet?)

This can be done on the command-line via the following in the headnode GZ:

    cd /var/tmp
    joyent-imgadm list  # find the wanted image UUID
    joyent-imgadm get $uuid > manifest
    joyent-imgadm get-file -O $uuid     # creates $uuid-file.$ext
    sdc-imgadm import -m manifest -f $uuid-file*

Note: With IMGAPI-80, this will eventually become a one-liner.


## Use Case 3: Operator adds a new image just for this cloud

**Status**: Incomplete. Currently the image must be manually added to each DC
as described below (the equivalent of SDC 6.5). Eventually, when IMGAPI has
MigrateImage (and when adminui supports using it), this will be easier.

How to add an image to a DC via the command-line:

1. `scp` the image manifest and file to the headnode GZ.
2. ssh to the headnode GZ and run:

        sdc-imgadm import -m MANIFEST -f FILE



## Use Case 4: User provisions with an image

**Status**: Complete.

This is via a normal
[cloudapi#CreateMachine](https://mo.joyent.com/docs/cloudapi/master/#CreateMachine)
call. CloudAPI could use [GetImage](#GetImage) on behalf of the calling user
to valid access to the `image_uuid`. VMAPI validates the `image_uuid`.
The provisioner agent uses the local `imgadm` to lazily install the image
if necessary (imgadm is configured to talk to the DC's local IMGAPI).


## Use Case 5: User creates a custom image (smartos)

**Status**: Incomplete. See roadmap section above.

Create a "proto" machine (i.e. the machine with the customizations on which
our custom image will be based). Currently JPC requires that you use one
of the "image-creation" packages for this "proto" machine.

    $ package_id=$(./bin/sdc-listpackages | json -c 'this.name=="g3-standard-2-smartos-image-creation"' 0.id)
    $ image_id=$(./bin/sdc-listimages | json -c 'this.name=="base"' 0.id)
    $ ./bin/sdc-createmachine -e $image_id -p $package_id --name proto1
    {
      "id": "5817ecef-a54f-42c7-96e5-5968b8e7c7b1",
      "name": "proto1",
      "type": "smartmachine",
      "state": "provisioning",
      "image": "e3364212-05c0-11e3-9576-3f3ee9e951a7",
      "ips": [],
      "memory": 2048,
      "disk": 67584,
      "metadata": {
        "root_authorized_keys": "ssh-rsa AAA..."
      },
      "tags": {},
      "created": "2013-08-28T06:22:58.348Z",
      "updated": "2013-08-28T06:22:58.348Z",
      "dataset": "sdc:sdc:base:13.2.0",
      "firewall_enabled": false,
      "package": "g3-standard-2-smartos-image-creation"
    }


SSH in, customize and *prepare* the machine once "./bin/sdc-getmachine UUID"
reports "state=running":

    $ machine_id=$(./bin/sdc-listmachines | json -c 'this.name=="proto1"' 0.id)
    $ machine_ip=$(./bin/sdc-getmachine $machine_id | json primaryIp)
    $ ssh root@$machine_ip

    # Make one or more "customizations" to be able to verify later. E.g.:
    $ echo "I was here" >/etc/motd
    # Prepare image and shutdown for image creation:
    $ sm-prepare-image -y

Now back on your local machine. Create the image (--machine, --name and
--imageVersion are required):

    $ ./bin/sdc-createimagefrommachine --machine $machine_id \
        --name 'my-custom-image-1' --imageVersion 1.0.0 \
        --description "This is just a throwaway tester image" \
        --tags '{"foo": "bar"}'
    {
      "id": "1793ed05-03db-421b-b38d-f76e84d85679",
      "name": "my-custom-image-1",
      "version": "1.0.0",
      "type": "smartmachine",
      "requirements": {},
      "description": "This is just a throwaway tester image",
      "tags": {
        "foo": "bar"
      }
    }

After a while it will have gone to either state=failed or state=active.
(Note: IMGAPI-267 is a bug where it can get stuck in state=creating.
You should expect image creation to be pretty quick. Less than a minute
certainly.)

    $ ./bin/sdc-getimage eac686e8-3bad-4c91-b22d-c197b543cb29
    {
      "id": "eac686e8-3bad-4c91-b22d-c197b543cb29",
      "name": "my-custom-image-1",
      "version": "1.0.3",
      "os": "smartos",
      "type": "smartmachine",
      "requirements": {},
      "description": "This is just a throwaway tester image",
      "tags": {
        "foo": "bar"
      },
      "published_at": "2013-08-28T07:45:44.599Z",
      "owner": "950cf163-b314-4ee8-ab46-08c884b9387c",
      "public": false,
      "state": "active"
    }

Now you should be able to create a machine using this image UUID (and
now using any package, no longer restricted to the 'image creation'
packages).

    $ package_id=$(./bin/sdc-listpackages | json -c 'this.name=="g3-standard-0.25-smartos"' 0.id)
    $ image_id=eac686e8-3bad-4c91-b22d-c197b543cb29
    $ ./bin/sdc-createmachine -e $image_id -p $package_id --name custom1


## Use Case 5: User creates a custom image (windows)

See the previous section for more explanation. This only explains steps that
differ for Windows VMs/images.

There are currently three windows flavours:

    $ sdc-imgadm list os=windows
    UUID                                  NAME              VERSION  FLAGS  OS       PUBLISHED
    5f101d16-90ac-11e2-b9c2-877979ff6041  ws2008std-r2-sp1  2.0.2    P      windows  2013-03-19T20:11:08Z
    13328c9a-9173-11e2-a9a5-2ff43d306c21  ws2008ent-r2-sp1  2.0.2    P      windows  2013-03-20T18:59:47Z
    95f6c9a6-a2bd-11e2-b753-dbf2651bf890  ws2012std         1.0.1    P      windows  2013-04-11T21:04:37Z

Each of these has a slightly different prepare-image batch file script. See
below. For this example we'll use Windows 2008 Standard.

Create the proto VM:

    $ package_id=$(./bin/sdc-listpackages | json -c 'this.name=="g3-standard-4-kvm-image-creation"' 0.id)
    $ image_id=$(./bin/sdc-listimages | json -c 'this.name=="ws2008std-r2-sp1"' 0.id)
    $ ./bin/sdc-createmachine -e $image_id -p $package_id --name proto2

Get the IP and administrator password via:

    $ machine_id=$(./bin/sdc-listmachines | json -c 'this.name=="proto2"' 0.id)
    $ ./bin/sdc-getmachine --credentials $machine_id

Then get in via Remote Desktop using the ip and administrator password. Note
that it can take a number of minutes after the Windows VM is running to get
in. Troubleshooting: If this still fails after a number of minutes, please
try creating a new proto VM. If *that* still fails, then we should dig in on
the VNC console to see if Windows crashed or is hung in interactive startup.

Once you are in, make a customization to verify later, e.g. create a text file
on the desktop.

Then prepare the VM for image creation by downloading the appropriate batch
file for your Windows flavor and running it in cmd.exe:

- Windows 2008 Server Standard: https://us-east.manta.joyent.com/derek/public/prepare-image.ws2008std.bat
- Windows 2008 Server Enterprise: https://us-east.manta.joyent.com/derek/public/prepare-image.ws2008ent.bat
- Windows 2012 Server Standard: https://us-east.manta.joyent.com/derek/public/prepare-image.ws2012std.bat

This should shutdown the VM. Now on your local machine again, create the image
(I suggest using a reasonably identifiable "name" to assist with debugging):

    $ ./bin/sdc-createimagefrommachine --machine $machine_id \
        --name 'trent-custom-win2008' --imageVersion 1.0.0
    {
        "id": "...",
        ...
    }

After a while it will have gone to either state=failed or state=active.
(Note: IMGAPI-267 is a bug where it can get stuck in state=creating.
You should expect image creation to be pretty quick. Less than a minute
certainly.)

    $ ./bin/sdc-getimage $uuid
    ...

Now you should be able to create a machine using this image UUID (and
now using any package with sufficient RAM for Windows, no longer restricted to
the 'image creation' packages).

    $ package_id=$(./bin/sdc-listpackages | json -c 'this.name=="sdc_4096"' 0.id)
    $ image_id=$uuid
    $ ./bin/sdc-createmachine -e $image_id -p $package_id --name customwin1



## Use Case 5: User creates a custom image (raw cloudapi)

**Status**: Incomplete. See roadmap section above.

An example using raw cloudapi (using the `sdc-cloudapi` tool in the 'sdc' zone
that allows the *admin* user to talk to CloudAPI). This example is run in COAL,
hence the packages, etc. are not practical JPC examples:

1. Some COAL-only setup. (Note: This, or the equivalent, is all automatically
   setup in staging.)

    Provision a cloudapi:

        cat <<EOM | sapiadm provision
        {
            "service_uuid": "$(sdc-sapi /services?name=cloudapi | json -H 0.uuid)",
            "params": {
                "alias": "cloudapi0",
                "networks": [
                    {
                        "uuid": "$(sdc-napi /networks?name=admin | json -H 0.uuid)"
                    },
                    {
                        "uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)",
                        "primary": true
                    }
                ]
            }
        }
        EOM

    Turn on image management bleeding edge features in cloudapi for the 'admin'
    user:

        echo '{
            "metadata": {
                "CLOUDAPI_BLEEDING_EDGE_FEATURES": ["img_mgmt"],
                "CLOUDAPI_BLEEDING_EDGE_LOGIN_WHITELIST": ["admin"]
            }
        }' | sapiadm update $(sdc-sapi /services?name=cloudapi | json -H 0.uuid)

    Ensure that DAPI will allow using the headnode for provisioning:

        sdc-login dapi

        cd /opt/smartdc/dapi/sapi_manifests/dapi
        json -f template -e '
          this.allocationDescription = this.allocationDescription.filter(
            function (e) {
              return !~[
                "hard-filter-min-ram",
                "hard-filter-min-disk",
                "hard-filter-min-cpu",
                "hard-filter-headnode"
              ].indexOf(e);
            })
          ' > template.new
        mv template.new template
        svcadm restart config-agent

        exit

    Need an external nic for the 'imgapi', 'sdc' and 'workflow' zones:

        sdc-vmapi /vms/$(vmadm lookup -1 alias=imgapi0)?action=add_nics -X POST -d@- <<EOP | sdc sdc-waitforjob
        {
            "networks": [{"uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)", "primary": true}]
        }
        EOP
        sdc-vmapi /vms/$(vmadm lookup -1 alias=sdc0)?action=add_nics -X POST -d@- <<EOP | sdc sdc-waitforjob
        {
            "networks": [{"uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)", "primary": true}]
        }
        EOP
        sdc-vmapi /vms/$(vmadm lookup -1 alias=workflow0)?action=add_nics -X POST -d@- <<EOP | sdc sdc-waitforjob
        {
            "networks": [{"uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)", "primary": true}]
        }
        EOP
        sleep 20  # workflow takes a while to come back

    Get the base 13.1.0 image to work with:

        sdc-imgadm import f669428c-a939-11e2-a485-b790efc0f0c1 -S https://images.joyent.com --skip-owner-check

    Now get into the sdc zone where `sdc-cloudapi` is setup for the admin user:

        [root@headnode (coal) ~]# sdc
        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]#

2.  Pick a package via ListPackages. Basically anyone should do.

        package_id=$(sdc-cloudapi /my/packages | json -H -c 'this.name=="sdc_256"' 0.id)

    E.g.:

        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]# sdc-cloudapi /my/packages | json -H -c 'this.name=="sdc_256"'
        [
          {
            "name": "sdc_256",
            "memory": 256,
            "disk": 25600,
            "swap": 512,
            "vcpus": 1,
            "default": "false",
            "id": "78aa629d-04fc-4ee5-881b-0b4a914e0c52",
            "version": "1.0.0"
          }
        ]

3.  Pick a network:

        network_id=$(sdc-cloudapi /my/networks | json -H 0.id)

    E.g.:

        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]# sdc-cloudapi /my/networks | json -H 0
        {
          "id": "c1dc3561-86ad-4a14-a3e4-3db849f6e0d4",
          "name": "external",
          "public": true
        }

4.  Create the proto machine [CreateMachine](https://mo.joyent.com/docs/cloudapi/master/#CreateMachine):

        cat <<EOM | sdc-cloudapi /my/machines -X POST -d@-
        {
            "name": "proto1",
            "package": "$package_id",
            "image": "f669428c-a939-11e2-a485-b790efc0f0c1",
            "networks": ["$network_id"]
        }
        EOM

    E.g.:

        HTTP/1.1 201 Created
        Location: /admin/machines/076a52ff-e18e-4168-b62e-a06dd2af699b
        Content-Type: application/json
        Content-Length: 1579
        ...
        Api-Version: 7.0.0

        {
          "id": "076a52ff-e18e-4168-b62e-a06dd2af699b",
          "name": "proto1",
          "type": "smartmachine",
          "state": "provisioning",
          "image": "f669428c-a939-11e2-a485-b790efc0f0c1",
          "ips": [],
          "memory": 256,
          "disk": 25600,
          "metadata": {
            "root_authorized_keys": "..."
          },
          "tags": {},
          "created": "2013-07-30T23:12:57.197Z",
          "updated": "2013-07-30T23:12:57.197Z",
          "dataset": "sdc:sdc:base:13.1.0",
          "firewall_enabled": false,
          "package": "sdc_256"
        }

    So:

        machine_id=076a52ff-e18e-4168-b62e-a06dd2af699b

    Wait until it is running:

        while [[ $(sdc-cloudapi /my/machines/$machine_id | json -H state) == "provisioning" ]]; do
          sleep 2
        done

    ... and get its IP:

        $ sdc-cloudapi /my/machines/$machine_id | json -Hj id name state ips
        {
          "id": "076a52ff-e18e-4168-b62e-a06dd2af699b",
          "name": "proto1",
          "state": "running",
          "ips": [
            "10.88.88.7"
          ]
        }

5.  SSH in, make a change and prepare the instance:

        [root@076a52ff-e18e-4168-b62e-a06dd2af699b (coal:sdc0) ~]# ssh -i ~/.ssh/sdc.id_rsa 10.88.88.7
        Last login: Thu Jul 11 04:29:02 2013 from 10.88.88.5
           __        .                   .
         _|  |_      | .-. .  . .-. :--. |-
        |_    _|     ;|   ||  |(.-' |  | |
          |__|   `--'  `-' `;-| `-' '  ' `-'
                           /  ; SmartMachine (base 13.1.0)
                           `-'  http://wiki.joyent.com/jpc2/SmartMachine+Base
        [root@076a52ff-e18e-4168-b62e-a06dd2af699b ~]# echo 'Trent was here' > /etc/motd
        [root@076a52ff-e18e-4168-b62e-a06dd2af699b ~]# sm-prepare-image -y
        ...

    This will stop the instance.

6.  Create the custom image:

        cat <<EOM | sdc-cloudapi /my/images -X POST -d@-
        {
          "machine": "076a52ff-e18e-4168-b62e-a06dd2af699b",
          "name": "foo",
          "version": "1.0.0",
          "description": "my first image"
        }
        EOM

    Cloudapi's response gives you the new image UUID:

        {
          "id": "cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd",
          "name": "foo",
          "type": "smartmachine",
          "requirements": {},
          "version": "1.0.0",
          "description": "my first image"
        }

    So:

        image_id=cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd

    but without a "published_at". Wait (for up to 2 minutes) for it to be created
    and published to the local IMGAPI:

        for i in {40..1}; do
            sleep 3
            if [[ -n "$(sdc-cloudapi /my/images/$image_id | json published_at)" ]]; then
                break
            fi
        done

    Once it is published:

        $ sdc-cloudapi /my/images/$image_id
        [
          {
            "id": "cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd",
            "name": "foo",
            "os": "smartos",
            "type": "smartmachine",
            "requirements": {},
            "version": "1.0.0",
            "description": "my first image",
            "published_at": "2013-07-11T04:40:10.364Z"
          }
        ]

    If that returns an error (404), then the creation failed. Currently there
    is no mechanism to report a specific creation error. There is a plan
    in M1 of the roadmap to fix that.

    The created image will have inherited relevant fields, e.g. billing_tags,
    from the source image (in this case 'base 13.1.0').

7.  Provision a new machine with this custom image.

        cat <<EOM | sdc-cloudapi /my/machines -X POST -d@-
        {
            "name": "foo0",
            "package": "$package_id",
            "image": "$image_id",
            "networks": ["$network_id"]
        }
        EOM

    Get its IP:

        $ sdc-cloudapi /my/machines/c4412958-0d6b-46c1-8b98-e4b52361e62c | json -Hj id name state ips
        {
          "id": "c4412958-0d6b-46c1-8b98-e4b52361e62c",
          "name": "foo0",
          "state": "running",
          "ips": [
            "10.88.88.8"
          ]
        }

    SSH in to see if it worked:

        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]# ssh -i ~/.ssh/sdc.id_rsa 10.88.88.8
        The authenticity of host '10.88.88.8 (10.88.88.8)' can't be established.
        RSA key fingerprint is 5c:6c:9e:50:95:36:5c:1c:17:8f:53:77:84:ee:81:e9.
        Are you sure you want to continue connecting (yes/no)? yes
        Warning: Permanently added '10.88.88.8' (RSA) to the list of known hosts.
        Last login: Thu Jul 11 04:49:11 2013 from 10.88.88.5
        Trent was here
        [root@c4412958-0d6b-46c1-8b98-e4b52361e62c ~]#

It worked!


### Thoughts

Obviously that process (do this; wait for this to be done) is a bit onerous
on the user. It is scriptable so the node-smartdc tooling should facilitate
that waiting.

We will be exposing more fields in "GET /my/images/:uuid", e.g. "public". For
comparison, here is the full internal data on the image:

        $ sdc-imgadm get cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd
        {
          "v": "2",
          "uuid": "cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd",
          "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
          "name": "foo",
          "version": "1.0.0",
          "state": "active",
          "disabled": false,
          "public": false,
          "published_at": "2013-07-11T04:40:10.364Z",
          "type": "zone-dataset",
          "os": "smartos",
          "files": [
            {
              "sha1": "3b52cd61463ee1b0c6551a3789b9db7e591fa410",
              "size": 381619144,
              "compression": "none"
            }
          ],
          "description": "my first image",
          "requirements": {
            "networks": [
              {
                "name": "net0",
                "description": "public"
              }
            ]
          }
        }

TODO: Redo this example using the node-smartdc CLI.


## Use Case 6: User modifies an image they own

**Status**: Incomplete. UpdateImage is implemented to support this, but
remaining work include custom image creation (Use Case 5) and exposing
UpdateImage via cloudapi (TODO: ticket for this).


## Use Case 7: User easily gets custom image from an Ubuntu ISO

**Status**: Incomplete. This is not an SDC 7.0 requirement and will not
be implemented for SDC 7.0.

Mark:

    i would like it to be that i _start_ in JPC with imgadm as ISO images
    i.e., i say "here's the ubuntu ISO image" i want to boot off of.
    i then do whatever the fuck i want to my VM
    i take a snapshot. and right there, that's now a new image available to me and anyone i share with (later)

Q: how do I create an image from an ISO. Say a slackware, debian or whatever ISO?

<!-- #endif -->


# API Summary

||**Name**||**Endpoint**||**Notes**||
||[ListImages](#ListImages)||GET /images||List available images.||
||[GetImage](#GetImage)||GET /images/:uuid||Get a particular image manifest.||
||[GetImageFile](#GetImageFile)||GET /images/:uuid/file||Get the file for this image.||
||[DeleteImage](#DeleteImage)||DELETE /images/:uuid||Delete an image (and its file).||
||[CreateImage](#CreateImage)||POST /images||Create a new (unactivated) image from a manifest.||
||[AddImageFile](#AddImageFile)||PUT /images/:uuid/file||Upload the image file.||
||[ActivateImage](#ActivateImage)||POST /images/:uuid?action=activate||Activate the image.||
||[UpdateImage](#UpdateImage)||POST /images/:uuid?action=update||Update image manifest fields. This is limited. Some fields are immutable.||
||[DisableImage](#DisableImage)||POST /images/:uuid?action=disable||Disable the image.||
||[EnableImage](#EnableImage)||POST /images/:uuid?action=enable||Enable the image.||
||[AddImageAcl](#AddImageAcl)||POST /images/:uuid/acl?action=add||Add account UUIDs to the image ACL.||
||[RemoveImageAcl](#RemoveImageAcl)||POST /images/:uuid/acl?action=remove||Remove account UUIDs from the image ACL.||
||[AddImageIcon](#AddImageIcon)||POST /images/:uuid/icon||Add the image icon.||
||[GetImageIcon](#GetImageIcon)||GET /images/:uuid/icon||Get the image icon file.||
||[DeleteImageIcon](#DeleteImageIcon)||DELETE /images/:uuid/icon||Remove the image icon.||
<!-- #ifdef PRIVATE -->
||[CreateImageFromVm](#CreateImageFromVm)||POST /images?action=create-from-vm||Create a new (activated) image from an existing VM.||
||[ExportImage](#ExportImage)||POST /images/:uuid?action=export||Exports an image to the specified Manta path.||
||[CopyRemoteImage](#CopyRemoteImage)||POST /images/$uuid?action=copy-remote&dc=us-west-1||**NYI (IMGAPI-278)** Copy one's own image from another DC in the same cloud.||
||[AdminImportRemoteImage](#AdminImportRemoteImage)||POST /images/$uuid?action=import-remote&source=$imgapi-url||Import an image from another IMGAPI||
||[AdminImportImage](#AdminImportImage)||POST /images/$uuid?action=import||Only for operators to import an image and maintain `uuid` and `published_at`.||
||[AdminGetState](#AdminGetState)||GET /state||Dump internal server state (for dev/debugging)||
<!-- #endif -->
||[ListChannels](#ListChannels)||GET /channels||List image channels (if the server uses channels).||
||[ChannelAddImage](#ChannelAddImage)||POST /images/:uuid?action=channel-all||Add an existing image to another channel.||
||[Ping](#Ping)||GET /ping||Ping if the server is up.||



# Errors

<!-- #include "build/errors.restdown" -->

# Images

An "image" object is the metadata for an image file, also called the manifest.
See [Image manifest data](#image-manifest-data) above for a summary of all
fields.


## ListImages (GET /images)

List images. Without query params this returns all active
(`state === "active"`) images.

There are two typical calling styles to this endpoint: with 'account=$UUID' and
without. The former is what cloudapi uses to ask on behalf of a particular
authenticated account. The latter is for operator-only querying.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to images visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
||owner||UUID||No||Only list images owned by this account.||
||state||String||No||List images with the given state. Can be one of 'active' (the default), 'disabled', 'unactivated' or 'all'.||
||name||String||No||List images with the given name. Prefix with `~` to do a substring match (case-*sensitive*). E.g., `~foo`.||
||version||String||No||List images with the given version. Prefix with `~` to do a substring match (case-*sensitive*). E.g., `~foo`.||
||public||Boolean||No||List just public or just private images.||
||os||String||No||List images with the given os.||
||type||String||No||List images of the given type.||
||tag.{key}||String||No||List images by tags. See below||
||billing_tag||String||No||List images by billing tags. See below||
||limit||Number||No||Maximum number of images to return. Images are sorted by creation date (ASC) by default. The default (and maximum) limit value is 1000||
||marker||UUID||No||Only return images created after the creation date of the image specified by the marker (including the marker image).||

### Filtering Images

Resuls from ListImages can be paginated by using the limit and marker query
parameters. Both can be used together or separately. Here are a couple of
examples that demostrate their usage:

    Get only 10 images
      GET /images?limit=10

    Get images created after image d0f6f1a8-aef5-11e3-8002-28cfe91a33c9
      GET /images?marker=d0f6f1a8-aef5-11e3-8002-28cfe91a33c9

    Get the next 2 images after image d0f6f1a8-aef5-11e3-8002-28cfe91a33c9
      GET /images?limit=3&marker=d0f6f1a8-aef5-11e3-8002-28cfe91a33c9


### Searching Images by Tags or Billing Tags

Images can be searched by tags. If an Image is tagged as 'cloud=private', then
the filter to be added to the request params should be 'tag.cloud=private' and
the full path for the query would look like "/images?tag.cloud=private". More
than one tag can be specified for the same search. Multiple tags are interpreted
as a logical AND, meaning that each of the Images returned is tagged with each of
the values provided.

In contrast, billing tags are not key/value objects but a single array of values.
This means that a query filter for billing_tags is constructed in a conventional
way. As an example, the following queries show the usage of tags and billing_tags
when filtering images.

    One matching tag
      GET /images?tag.cloud=private

    Multiple matching tags
      GET /images?tag.cloud=private&tag.dc=east

    One matching billing tag
      GET /images?billing_tag=promo

    Multiple matching billing tags
      GET /images?biling_tag=promo&billing_tag=smallinstance


### Returns

An array of image objects.

### Errors

See [Errors](#errors) section above.

### Example

Raw curl (from images.joyent.com):

    $ curl -kisS https://images.joyent.com/images | json
    HTTP/1.1 200 OK
    Date: Tue, 08 Jan 2013 01:07:25 GMT
    Content-Type: application/json
    Connection: keep-alive
    Content-Length: 60203
    Server: IMGAPI/1.0.0
    x-request-id: c3993970-592f-11e2-8ef6-f7e53a279942
    x-response-time: 44
    x-server-name: b908c5b2-ccd9-4f43-b5ff-2997eb6bd682.local

    [
      {
        "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
        "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
        "name": "smartos",
        "version": "1.6.3",
        "state": "active",
        "disabled": false,
        "public": true,
        "published_at": "2012-05-02T15:14:45.805Z",
        "type": "zone-dataset",
        "os": "smartos",
        "files": [
          {
            "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
            "size": 46271847,
            "compression": "bzip2"
          }
        ],
        "description": "Base template to build other templates on",
    ...

CLI tool (from images.joyent.com):

    $ joyent-imgadm list
    UUID                                  NAME           VERSION  OS       STATE   PUBLISHED
    febaa412-6417-11e0-bc56-535d219f2590  smartos        1.3.12   smartos  active  2011-04-11
    7456f2b0-67ac-11e0-b5ec-832e6cf079d5  nodejs         1.1.3    smartos  active  2011-04-15
    ...

    $ joyent-imgadm list name=~base   # filter on substring in name
    UUID                                  NAME    VERSION  OS       STATE   PUBLISHED
    8418dccc-c9c6-11e1-91f4-5fb387d839c5  base    1.7.0    smartos  active  2012-07-09
    d0eebb8e-c9cb-11e1-8762-2f01c4acd80d  base64  1.7.0    smartos  active  2012-07-10
    ...

In an SDC headnode GZ to talk to that data center's IMGAPI:

    $ sdc-imgapi /images
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 515
    Date: Tue, 08 Jan 2013 01:08:19 GMT
    Server: IMGAPI/1.0.0
    x-request-id: e3b681e0-592f-11e2-b638-4b6ffa4ca56f
    x-response-time: 1
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    [
      {
        "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
        "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
        "name": "smartos",
        "version": "1.6.3",
    ...

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm list state=all
    UUID                                  NAME     VERSION  OS       STATE        PUBLISHED
    e70502b0-705e-498e-a810-53a03980eabf  foo      1.0.0    smartos  unactivated  -
    01b2c898-945f-11e1-a523-af1afbe22822  smartos  1.6.3    smartos  active       2012-05-02
    ...


## GetImage (GET /images/:uuid)

Get a image by uuid.

There are two typical calling styles to this endpoint: with 'account=$UUID' and
without. The former is what cloudapi uses to ask on behalf of a particular
authenticated account. The latter is for operator-only querying.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to images visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers. ||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

An image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw curl (from images.joyent.com):

    $ curl -sS https://images.joyent.com/images/01b2c898-945f-11e1-a523-af1afbe22822
    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
    ...

CLI tool (from images.joyent.com):

    $ joyent-imgadm get 01b2c898-945f-11e1-a523-af1afbe22822
    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
    ...

Raw API tool (from an SDC's IMGAPI):

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 513
    Date: Tue, 08 Jan 2013 01:10:06 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 2383aaf0-5930-11e2-b638-4b6ffa4ca56f
    x-response-time: 71
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
      "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
      "name": "smartos",
      "version": "1.6.3",
      "state": "active",
      "disabled": false,
      "public": true,
      "published_at": "2012-05-02T15:14:45.805Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "description": "Base template to build other templates on",
      "urn": "sdc:sdc:smartos:1.6.3",
      "requirements": {
        "networks": [
          {
            "name": "net0",
            "description": "public"
          }
        ]
      }
    }

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm get 01b2c898-945f-11e1-a523-af1afbe22822
    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
    ...



## GetImageFile (GET /images/:uuid/file)

Get the image file.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers. ||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

The (typically large) image file content.

### Errors

Any errors produced while transferring the image data will result in the connection
being closed. Clients should compare the returned data's SHA-1 against the value
found in the manifest files object in order to check if the received file is corrupt.

For request validation errors, see [Errors](#errors) section above.

### Example

Raw curl (from images.joyent.com):

    $ curl -kfsS https://images.joyent.com/images/01b2c898-945f-11e1-a523-af1afbe22822/file -o file.bz2

CLI tool (from images.joyent.com):

    $ joyent-imgadm get-file 01b2c898-945f-11e1-a523-af1afbe22822 -O
    100% [=============================]  time 43.4s  eta 0.0s
    Saved "01b2c898-945f-11e1-a523-af1afbe22822.bz2".

Raw API tool (from an SDC's IMGAPI):

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822/file -o file.bz2

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm get-file 01b2c898-945f-11e1-a523-af1afbe22822 -O
    100% [=============================]  time 43.4s  eta 0.0s
    Saved "01b2c898-945f-11e1-a523-af1afbe22822.bz2".


## GetImageIcon (GET /images/:uuid/icon)

Get the image icon file.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers. ||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

The image icon file content.

### Errors

Any errors produced while transferring the image icon will result in the connection
being closed. Clients should compare the returned data's SHA-1 against the value
found in the manifest files object in order to check if the received icon file is
corrupt.

For request validation errors, see [Errors](#errors) section above.

### Example

Raw curl:

    $ curl -kfsS https://localhost/images/01b2c898-945f-11e1-a523-af1afbe22822/icon -o icon.png

CLI tool:

    $ joyent-imgadm get-icon 01b2c898-945f-11e1-a523-af1afbe22822 -O
    100% [=============================]  time 0.4s  eta 0.0s
    Saved "01b2c898-945f-11e1-a523-af1afbe22822.png".

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822/icon -o icon.png


## DeleteImageIcon (DELETE /images/:uuid/icon)

Delete the image icon file.

There are two typical calling styles to this endpoint: with 'account=$UUID' and
without. The former is what cloudapi uses to ask on behalf of a particular
authenticated account. The latter is for operator-only querying.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow deletion for images *owned* by this account. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

The image object with the 'icon' field now false.

### Errors

See [Errors](#errors) section above.

### Example

CLI tool:

    $ joyent-imgadm delete-icon 01b2c898-945f-11e1-a523-af1afbe22822
    Deleted icon from image 01b2c898-945f-11e1-a523-af1afbe22822

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822/icon -X DELETE


## DeleteImage (DELETE /images/:uuid)

Delete this image (and its file and icon, if any).

There are two typical calling styles to this endpoint on DC mode IMGAPI servers:
with 'account=$UUID' and without. The former is what cloudapi uses to ask on
behalf of a particular authenticated account. The latter is for operator-only
querying.

For IMGAPI servers that support image channels (e.g. updates.joyent.com)

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow deletion for images *owned* by this account. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
|| force_all_channels (query_param) ||Boolean||No||Set this true to force deletion even if the image exists in multiple channels. Only relevant for IMGAPI servers using [channels](#channels).||

### Returns

Responds with HTTP 204 (No Content).

### Errors

See [Errors](#errors) section above.

### Example

CLI tool (from images.joyent.com):

    $ joyent-imgadm delete 69d8bd69-db68-a54c-bec5-8c934822cfa9
    Deleted image 69d8bd69-db68-a54c-bec5-8c934822cfa9

Raw API tool (from an SDC's IMGAPI):

    $ sdc-imgapi /images/f9bbbc9f-d281-be42-9651-72c6be875874 -X DELETE

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm delete 7a1b1967-6ecf-1e4c-8f09-f49094cc36ad
    Deleted image 7a1b1967-6ecf-1e4c-8f09-f49094cc36ad

Cloud API:

    $ sdc-cloudapi /my/images/7a1b1967-6ecf-1e4c-8f09-f49094cc36ad -X DELETE


## CreateImage (POST /images)

Create a new (unactivated) image from a manifest. The typical process is to
subsequently call [AddImageFile](#AddImageFile) and then
[ActivateImage](#ActivateImage) to finish with an image available for
provisioning.

### Inputs

||**Field**||**Type**||**Required?**||**Notes**||
|| account (query param) ||UUID||Yes\*||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
||[owner](#manifest-owner)||UUID||Yes\*||The UUID of the owner of this image (the account that created it). If not given, the given `account` is used. At least one of `account` or `owner` is required.||
||[name](#manifest-name)||String||Yes||A short name (and optionally version) for this image. Max 512 characters. No uniqueness guantee.||
||[version](#manifest-version)||String||Yes||A version string for this image. Max 128 characters. No uniqueness guarantee.||
||[description](#manifest-description)||String||No||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||Homepage URL where users can find more information about the image.||
||[eula](#manifest-eula)||URL||No||URL of the End User License Agreement (EULA) for the image.||
||[disabled](#manifest-disabled)||Boolean||No||Indicates if this image should be available for provisioning. Default is `false`.||
||[public](#manifest-public)||Boolean||No||Indicates if this image is publicly available. Default is `false`.||
||[type](#manifest-type)||String||Yes||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, "zvol" for a virtual machine image or "other" for image types that serve any other specific purpose.||
||[os](#manifest-os)||String||Yes||The OS family this image provides. One of "smartos", "windows", and "linux".||
||[origin](#manifest-origin)||UUID||No||The origin image UUID if this is an incremental image.||
||[acl](#manifest-acl)||Array||No||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[requirements](#manifest-requirements)||Object||No||A set of named requirements for provisioning a VM with this image. See [the requirements docs](#manifest-requirements) above for supported fields.||
||[users](#manifest-users)||Array||No||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||No||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||No||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[tags](#manifest-tags)||Object||No||An object of key/value pairs that allows clients to categorize images by any given criteria.||
||[generate_passwords](#manifest-generate-passwords)||Boolean||No||A boolean indicating whether to generate passwords for the users in the "users" field. If not present, the default value is true.||
||[inherited_directories](#manifest-inherited-directories)||Array||No||A list of inherited directories (other than the defaults for the brand).||
||[nic_driver](#manifest-nic-driver)||String||Yes (if `type==="zvol"`)||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||Yes (if `type==="zvol"`)||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||Yes (if `type==="zvol"`)||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||Yes (if `type==="zvol"`)||The size (in MiB) of this VM image's disk.||

### Returns

The (unactivated) image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This creates a new unactivated
image:

    $ sdc-imgapi /images -X POST \
        --data-binary '{
            "name": "foo",
            "version": "1.0.0",
            "type": "zone-dataset",
            "os": "smartos",
            "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81"
        }'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 236
    Date: Tue, 08 Jan 2013 20:04:01 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 8b547800-59ce-11e2-b638-4b6ffa4ca56f
    x-response-time: 52
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81",
      "name": "foo",
      "version": "1.0.0",
      "state": "unactivated",
      "disabled": false,
      "public": false,
      "type": "zone-dataset",
      "os": "smartos",
      "files": [],
      "acl": []
    }

CLI tool (against an SDC's IMGAPI):

    $ echo '{
        "name": "foo",
        "version": "1.0.0",
        "type": "zone-dataset",
        "os": "smartos",
        "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81"
    }' | sdc-imgadm create
    Imported image 25ab9ddf-96e8-4157-899d-1dc8be7b9810 (foo, 1.0.0, state=unactivated)


<!-- #ifdef PRIVATE -->

## CreateImageFromVm (POST /images?action=create-from-vm)

Create a new (activated) image from an existing VM. The VM from which the Image
will be created must be stopped. This endpoint has a subset of allowed inputs
compared to [CreateVm](#CreateVm), as many of the Image manifest fields are
going to be directly computed from the source VM.

### Query String Inputs

|| **Field**        || **Type** || **Required?** ||**Default**||**Notes**||
|| account          || UUID     || Yes           ||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
|| channel          || String   || No            || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
|| vm_uuid          || UUID     || Yes           ||The UUID of the source VM.||
|| incremental      || Boolean  || No            ||Whether to create an incremental image. Default is `false`.||
|| max_origin_depth || Number   || No            ||If the image is incremental, this number allows setting a limit in the number of child incremental images. E.g. a value of 3 means that the image will only be created if there are no more than 3 parent images in the origin chain.||

### Manifest Inputs

The following is the list of inputs that can be specified for a new Image created
from an existing VM:

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||[uuid](#manifest-uuid)||UUID||No||-||UUID of the new Image. A new one will be generated if not specified||
||[owner](#manifest-owner)||UUID||Yes\*||-||The UUID of the owner of this image (the account that created it). If not given, the given `account` is used. At least one of `account` or `owner` is required.||
||[name](#manifest-name)||String||Yes||-||A short name (and optionally version) for this image. Max 512 characters. No uniqueness guantee.||
||[version](#manifest-version)||String||Yes||-||A version string for this image. Max 128 characters. No uniqueness guarantee.||
||[description](#manifest-description)||String||No||-||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||-||Homepage URL where users can find more information about the image.||
||[disabled](#manifest-disabled)||Boolean||No||false||Indicates if this image should be available for provisioning.||
||[public](#manifest-public)||Boolean||No||false||Indicates if this image is publicly available.||
||[acl](#manifest-acl)||Array||No||-||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[tags](#manifest-tags)||Object||No||-||An object of key/value pairs that allows clients to categorize images by any given criteria.||


### Inherited Fields

The following is the list of fields that the new Image will inherit from the source
Image of the VM in question and therefore cannot be specified:

||**Field**||**Type**||**Notes**||
||[type](#manifest-type)||String||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, "zvol" for a virtual machine image or "other" for image types that serve any other specific purpose.||
||[os](#manifest-os)||String||The OS family this image provides. One of "smartos", "windows", and "linux".||
||[requirements](#manifest-requirements)||Object||A set of named requirements for provisioning a VM with this image. See [the requirements docs](#manifest-requirements) above for supported fields.||
||[users](#manifest-users)||Array||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[generate_passwords](#manifest-generate-passwords)||Boolean||A boolean indicating whether to generate passwords for the users in the "users" field. If not present, the default value is true.||
||[inherited_directories](#manifest-inherited-directories)||Array||A list of inherited directories (other than the defaults for the brand).||
||[nic_driver](#manifest-nic-driver)||String||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||The size (in MiB) of this VM image's disk.||


### Returns

A Job object. The location of the workflow API where the status of the job can
be polled is available in the workflow-api header of the response.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This queues the creation of a new Image
from an existing VM:

    $ sdc-imgapi '/images?action=create-from-vm&vm_uuid=56b107b9-9277-4a6a-bcd3-17c497041bee' \
        -X POST \
        --data-binary '{
            "name": "foo",
            "version": "1.0.0",
            "uuid": "4e88c673-f3ab-4a55-9f5d-b54379cf2d8a",
            "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81"
        }'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 236
    Date: Tue, 08 Jan 2013 20:04:01 GMT
    Server: IMGAPI/1.0.0
    workflow-api: http://workflow.coal.joyent.us
    x-request-id: 8b547800-59ce-11e2-b638-4b6ffa4ca56f
    x-response-time: 52
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "image_uuid": "4e88c673-f3ab-4a55-9f5d-b54379cf2d8a",
      "job_uuid": "4c831bba-68ed-4fe8-a54b-a5b5acefd7ac"
    }


## ExportImage (POST /images/:uuid?action=export)

Exports an image to the specified Manta path. Only images that already live
in Manta can be exported, locally stored images are not supported.

### Inputs

||**Field**||**Type**||**Required?**||**Notes**||
|| account (query param) || UUID || No\* || The account UUID on behalf of whom this request is being made. If given then the manta_path prefix must resolve to a location that is owned by the account. If not given then the manta_path prefix is assumed to (and must) resolve to a path that is owned by the admin user.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
|| manta_path ||String||Yes\*||Manta path prefix where the image file and manifest should be exported to. If "manta_path" is a dir, then the files are saved to it. If the basename of "PATH" is not a dir, then "PATH.imgmanifest" and "PATH.zfs[.EXT]" are created.||

### Returns

A Manta location response object. It provides the properties that allow the
IMGAPI user to retrieve the image file and manifest from Manta: manta_url,
image_path, manifest_path.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/a93fda38-80aa-11e1-b8c1-8b1f33cd9007?action=export&manta_path=/user/stor/imgapi -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 200
    Date: Fri, 30 Aug 2013 00:19:11 GMT
    Server: IMGAPI/1.1.1
    x-request-id: cac4f490-1109-11e3-a1a5-012c46265014
    x-response-time: 1225
    x-server-name: 9243385e-9975-4a74-a68e-ce601af89e76
    Connection: keep-alive

    {
      "manta_url": "https://us-east.manta.joyent.com",
      "image_path": "/user/stor/imgapi/smartos-1.6.2.zfs.bz2",
      "manifest_path": "/user/stor/imgapi/smartos-1.6.2.imgmanifest"
    }

CLI tool:

    $ sdc-imgadm export a93fda38-80aa-11e1-b8c1-8b1f33cd9007
    Image a93fda38-80aa-11e1-b8c1-8b1f33cd9007 exported to Manta path /user/stor/imgapi


<!-- #endif -->

## AddImageFile (PUT /images/:uuid/file)

Add the image file. If the image already has a file, it will be overwritten.
A file can only be added to an image that has not yet been activated. The
typical process is to call this after [CreateImage](#CreateImage), and then
subsequently call [ActivateImage](#ActivateImage) to make the image available
for provisioning, `state == "active"`.

### Inputs

||**Field**||**Type**||**Required?**||**Notes**||
|| account (query param) || UUID||No||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
<!-- #ifdef PRIVATE -->
||storage||String||No||The type of storage preferred for this image file. Storage can only be specified if the request is being made by an operator. The only two possible values for storage are **local** and **manta**. When the request is made on behalf of a customer then IMGAPI will try to use manta as the storage backend, otherwise default to local storage.||
<!-- #else -->
||storage||String||No||The type of storage preferred for this image file. Admin-only.||
<!-- #endif -->
||[compression](#manifest-files)||UUID||Yes||The type of compression used for the file content. One of 'none', 'gzip' or 'bzip2'.||
||[sha1](#manifest-files)||SHA-1 Hash||No||SHA-1 of the uploaded file to allow the server to check for data corruption.||
<!-- #ifdef PRIVATE -->
||dataset_guid||GUID||No||The ZFS internal unique identifier for this dataset's snapshot (available via `zfs get guid SNAPSHOT`, e.g. `zfs get guid zones/f669428c-a939-11e2-a485-b790efc0f0c1@final`). If available, this is used to ensure a common base snapshot for incremental images (via `imgadm create -i`) and VM migrations (via `vmadm send/receive`).||
<!-- #endif -->
||(file content in the body)||binary||Yes||The image file content.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This example is using curl's
`-T/--upload-file <file>` option, which results in a PUT.

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/file?compression=bzip2 \
        -T image.bz2
    HTTP/1.1 100 Continue

    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 319
    Date: Tue, 08 Jan 2013 20:17:46 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 773c5b10-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 106
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81",
      "name": "foo",
      "version": "1.0.0",
      "state": "unactivated",
      "disabled": false,
      "public": false,
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm add-file 25ab9ddf-96e8-4157-899d-1dc8be7b9810 -f file.bz2
    100% [=============================]  time 5.6s  eta 0.0s
    Added file "file.bz2" to image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## AddImageIcon (PUT /images/:uuid/icon)

Add the image icon. If the image already has an icon file, it will be overwritten.
Icons must have a maximum file size of 128Kb pixels and be in one of the following
formats: PNG, GIF or JPG.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID||No||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
||[sha1](#manifest-files)||SHA-1 Hash||No||SHA-1 of the uploaded icon file to allow the server to check for data corruption.||
<!-- #ifdef PRIVATE -->
||storage||String||No||The type of storage preferred for the image icon. Storage can only be specified if the request is being made by an operator. The only two possible values for storage are **local** and **manta**. When the request is made on behalf of a customer then IMGAPI will try to use manta as the storage backend, otherwise default to local storage.||
<!-- #else -->
||storage||String||No||The type of storage preferred for the image icon. Admin-only.||
<!-- #endif -->
||(file content in the body)||binary||Yes||The icon file content.||

### HTTP Request Headers

||**Header Name**||**Required?**||**Notes**||
||Content-Type||Yes||Content type of the icon file. One of 'image/jpeg', 'image/png' or 'image/gif'.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This example is using curl's
`-T/--upload-file <file>` option, which results in a PUT.

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/icon \
        -H 'content-type: image/png'
        -T icon.png
    HTTP/1.1 100 Continue

    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 319
    Date: Tue, 08 Jan 2013 20:17:46 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 773c5b10-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 106
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81",
      "name": "foo",
      "version": "1.0.0",
      "state": "unactivated",
      "disabled": false,
      "public": false,
      "type": "zone-dataset",
      "os": "smartos",
      "icon": true,
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm add-icon 25ab9ddf-96e8-4157-899d-1dc8be7b9810 -f icon.png
    100% [=============================]  time 0.4s  eta 0.0s
    Added file "icon.png" to image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## ActivateImage (POST /images/:uuid?action=activate)

Activate the image. This makes the image available for provisioning -- the
`state` field will be "active". The image must already have had a file
uploaded via [AddImageFile](#AddImageFile). Once activated, an image cannot
be "deactivated". However it can be [*disabled*](#DisableImage) temporarily
or [*deleted*](#DeleteImage) permanently.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf?action=activate -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm activate 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Activated image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## DisableImage (POST /images/:uuid?action=disable)

Disables the image. This makes the image unavailable for provisioning -- the
`state` field will be "disabled".

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf?action=disable -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "disabled",
      "disabled": true,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm disable 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Disabled image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## EnableImage (POST /images/:uuid?action=enable)

Enables the image. This makes the image available for provisioning once again --
the `state` field will be "active".

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf?action=enable -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm enable 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Enabled image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## AddImageAcl (POST /images/:uuid/acl?action=add)

Adds more UUIDs to the Image ACL (access control list). If any of the account
UUIDs is already in the image ACL it gets ignored. For convenience, when the
action parameter is not present it will default to action=add. This means that
the **AddImageAcl** action is valid in either of the two following forms:

    POST /images/:uuid/acl
    POST /images/:uuid/acl?action=add

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) ||UUID||No||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
|| [acl](#manifest-acl) ||Array||Yes||Access Control List. An array of account UUIDs to give access to a private image. The field is only relevant to private images.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/acl -X POST
        -d '[ "669a0e24-5e8a-11e2-8c11-7c6d6290281a" ]'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": [
        "669a0e24-5e8a-11e2-8c11-7c6d6290281a"
      ]
    }

CLI tool:

    $ sdc-imgadm add-acl 25ab9ddf-96e8-4157-899d-1dc8be7b9810 669a0e24-5e8a-11e2-8c11-7c6d6290281a
    Updated ACL for image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## RemoveImageAcl (POST /images/:uuid/acl?action=remove)

Removes UUIDs from the Image ACL. Any of the account UUIDs that is not in the
image ACL gets ignored. In contrast to [AddImageAcl](#AddImageAcl), RemoveImageAcl
requires the action parameter to be present and to be equal to 'remove'.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) ||UUID||No||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
|| [acl](#manifest-acl) ||Array||Yes||Access Control List. An array of account UUIDs to remove access to a private image. The field is only relevant to private images.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/acl?action=remove -X POST
        -d '[ "669a0e24-5e8a-11e2-8c11-7c6d6290281a" ]'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": [
      ]
    }

CLI tool:

    $ sdc-imgadm remove-acl 25ab9ddf-96e8-4157-899d-1dc8be7b9810 669a0e24-5e8a-11e2-8c11-7c6d6290281a
    Updated ACL for image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## UpdateImage (POST /images/:uuid?action=update)

Update some fields in the image manifest. Not all fields can be updated. The
inputs section lists every image attribute that can be modified.
Any input is optional but at least one attribute must be updated.

**NOTE** Public images residing on a public mode server cannot be made private.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| account (query param) || UUID || No || Only allow access to an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images. This field is only relevant for ['mode=dc'](#configuration) IMGAPI servers.||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
||[description](#manifest-description)||String||No||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||Homepage URL where users can find more information about the image.||
||[eula](#manifest-eula)||URL||No||URL of the End User License Agreement (EULA) for the image.||
||[public](#manifest-public)||Boolean||false||Indicates if this image is publicly available.||
||[type](#manifest-type)||String||No||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, "zvol" for a virtual machine image or "other" for image types that serve any other specific purpose.||
||[os](#manifest-os)||String||No||The OS family this image provides. One of "smartos", "windows", and "linux".||
||[acl](#manifest-acl)||Array||No||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[requirements](#manifest-requirements)||Object||No||A set of named requirements for provisioning a VM with this image. See [the requirements docs](#manifest-requirements) above for supported fields.||
||[users](#manifest-users)||Array||No||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||No||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||No||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[tags](#manifest-tags)||Object||No||An object of key/value pairs that allows clients to categorize images by any given criteria.||
||[inherited_directories](#manifest-inherited-directories)||Array||No||A list of inherited directories (other than the defaults for the brand).||
||[generate_passwords](#manifest-generate-passwords)||Boolean||No||A boolean indicating whether to generate passwords for the users in the "users" field.||
||[nic_driver](#manifest-nic-driver)||String||No||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||No||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||No||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||No||The size (in MiB) of this VM image's disk.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/f9bbbc9f-d281-be42-9651-72c6be875874?action=update -X POST
        --data-binary '{
            "description": "updated description"
        }'

CLI tool:

    $ sdc-imgadm update f9bbbc9f-d281-be42-9651-72c6be875874 -f data.json
    $ sdc-imgadm update f9bbbc9f-d281-be42-9651-72c6be875874 description='new description'
    $ cat data.json | sdc-imgadm update f9bbbc9f-d281-be42-9651-72c6be875874



<!-- #ifdef PRIVATE -->
## AdminImportImage (POST /images/:uuid?action=import)

Import an image (preserving its `uuid` and `published_at` fields).

This may only be used by operators. This is enforced by requiring that
`account=UUID` is NOT provided. All usage of IMGAPI on behalf of end users
is required to use `account=UUID`; operator usage (e.g. from AdminUI) is
not.

This creates an unactivated image. The typical process is to subsequently
call [AddImageFile](#AddImageFile) and then [ActivateImage](#ActivateImage)
to finish with an image available for provisioning.

### Inputs

The request body includes the same fields as for [CreateImage](#CreateImage),
including the SDC6-era backward compat fields, with the following additions
and changes:

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||account||UUID||No\*||-||This must NOT be provided. See the discussion above.||
||uuid||UUID||Yes||-||The existing image UUID.||
||published_at||Date||No||-||The published date/time of the image.||
||...||...||...||...||Other fields from [CreateImage](#CreateImage).||

Other inputs:

||**Field**||**Type**||**Required?**||**Notes**||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
||action||String||Yes||"import"||
||skip_owner_check||Boolean||No||Defaults to `false`. Pass in 'true' to skip the check that the image "owner" UUID exists in the user database (in SDC this database is UFDS). Note: The owner check is only done for `mode == "dc"` IMGAPI instances.||
||source||URL||No||URL of the source IMGAPI repository. If called with a `source` then only the `uuid` input field is relevant.||

### Returns

The (unactivated) image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822?action=import \
        -X POST --data-binary @base-14.1.0.imgmanifest
    ...

CLI tool. This example uses the '-f FILE' argument, which will handle
AddImageFile and ActivateImage calls after the AdminImportImage.

    $ sdc-imgadm import -m manifest -f file.bz2
    Imported image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699 (base, 1.8.4, state=unactivated)
    100% [=============================]  time 0.6s  eta 0.0s
    Added file "file.bz2" to image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699
    Activated image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699


## AdminImportRemoteImage (POST /images/:uuid?action=import-remote)

Import an image from another IMGAPI repository. This is typically used for
importing an image from <https://images.joyent.com>, but can be used for any
other valid Image repository. It is mainly a convenience method to allow IMGAPI
to execute the five import steps (get manifest, get file, import manifest,
add file, activate image) on the user's behalf.

This may only be used by operators. All usage of IMGAPI on behalf of end users
is required to use `account=UUID`; operator usage (e.g. from AdminUI) is
not.

This creates an active image ready for consumption.

### Inputs

|| **Field** || **Type** || **Required?** || **Notes** ||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
||action||String||Yes||"import-remote"||
||source||URL||Yes||URL of the source IMGAPI repository||
||skip_owner_check||Boolean||No||Defaults to `false`. Pass in 'true' to skip the check that the image "owner" UUID exists in the user database (in SDC this database is UFDS). Note: The owner check is only done for `mode == "dc"` IMGAPI instances.||


### Returns

A job response object with the following fields:

||**Field**||**Type**||**Notes**||
||image_uuid||UUID||UUID of the image being imported||
||job_uuid||UUID||The job UUID. In SDC use `sdc-workflow /jobs/$job_uuid` to inspect.||

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822?action=import-remote&source=https://images.joyent.com
    HTTP/1.1 200 OK
    workflow-api: http://workflow.coal.joyent.us
    content-type: application/json
    content-length: 112
    date: Thu, 25 Jul 2013 05:23:23 GMT
    server: IMGAPI/1.0.3
    x-request-id: 4e71ed70-f4ea-11e2-b255-75716000a01d
    x-response-time: 8307
    x-server-name: ba928081-1e9f-49dc-8900-0239956fda7b

    {
      "image_uuid": "a93fda38-80aa-11e1-b8c1-8b1f33cd9007",
      "job_uuid": "b45be0ae-778a-474e-8e41-9793f09ffde1"
    }

CLI tool:

    $ sdc-imgadm import 84cb7edc-3f22-11e2-8a2a-3f2a7b148699 -S https://images.joyent.com
    Imported image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699 (base, 1.8.4, state=active)


## ListImageJobs (GET /images/:uuid/jobs)

List all jobs created for an image.

### Inputs

||**Field**||**Type**||**Description**||
||task||String||List all jobs of the given task. Currently, task can be any of the following values: 'create-from-vm', 'import-remote-image'.||
||execution||String||Filter jobs that match the given execution state. It can be any of: 'running', 'succeeded', 'failed', 'canceled' or 'queued'.||

### Returns

An array of image job objects.

### Errors

See [Errors](#errors) section above.

### Example

    $ sdc-imgapi /images/0084dad6-05c1-11e3-9476-8f8320925eea/jobs?execution=succeeded
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 3253
    Date: Wed, 11 Sep 2013 23:13:52 GMT
    Server: IMGAPI/1.1.1
    x-request-id: d2924780-1b37-11e3-895c-876b1f3f0171
    x-response-time: 23
    x-server-name: f62ea923-eec8-4c0a-b9e0-fe4feec3bd3e
    Connection: keep-alive

    [
      {
        "execution": "succeeded",
        "chain_results": [
          {
            "result": "No origin (skipping origin image import)",
            "error": "",
            "name": "origin_import_image",
            "started_at": "2013-09-11T23:12:36.993Z",
            "finished_at": "2013-09-11T23:12:37.086Z"
          },
    ...

<!-- #endif -->


# Channels

An IMGAPI server can use "channels". Each channel is an independent set of
images in the same server. The set of channels is a [static
configured](#configuration) set of channel names, optionally with a default
channel. Use [ListChannels](#ListChannels) to see the server's configured
channels.

Each relevant IMGAPI endpoint has a "?channel=<channel>" query param to work
with images in that channel. Without it the server's configured default channel
is implied. The [IMGAPI
client](https://mo.joyent.com/node-sdc-clients/blob/master/lib/imgapi.js) takes
a new `channel` constructor option. Image manifests have a new "channels"
field that is an array of the channel names to which the image belongs.

In a server that uses channels, an image can be in one or more channels. An
existing image is added to additional channels via
[ChannelAddImage](#ChannelAddImage). An image is removed from a channel via
[DeleteImage](#DeleteImage) -- the image is not fully deleted from the
repository until it is removed from its last channel.

The current canonical example of an IMGAPI server using channels is the
SmartDataCenter updates server (https://updates.joyent.com). The
[`updates-imgadm`](https://mo.joyent.com/imgapi-cli/blob/channels/bin/updates-imgadm)
CLI takes a `-C <channel>` option or `UPDATES_IMGADM_CHANNEL=<channel>`
environment variable to specify the channel. Additionally on a SmartDataCenter
headnode the `updates-imgadm` will default to the DC's configured update
channel (see the `update_channel` SDC config var).

A channel object has the following fields:

||**Field**||**Description**||
||name||The channel name. This is the unique id.||
||default||Boolean. Only set for the default channel, if any.||
||description||A short prose description of the channel's purpose.||


## ListChannels (GET /channels)

List the IMGAPI server's channels.

### Inputs

None.

### Returns

An array of channel objects (see above).

### Errors

See [Errors](#errors) section above.

### Example


CLI tool:

    $ updates-imgadm channels
    NAME     DEFAULT  DESCRIPTION
    dev      true     all development builds
    staging  -        builds for testing in staging in prep for production release
    release  -        release gold bits

Raw curl (from updates.joyent.com):

    $ curl -kisS https://updates.joyent.com/channels
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 280
    Date: Tue, 29 Jul 2014 21:56:17 GMT
    Server: IMGAPI/1.2.0
    x-request-id: 2aa89bb0-176b-11e4-b4fe-f1422f0ce754
    x-response-time: 1
    x-server-name: ...
    Connection: keep-alive

    [
      {
        "name": "dev",
        "description": "all development builds",
        "default": true
      },
      {
        "name": "staging",
        "description": "builds for testing in staging in prep for production release"
      },
      {
        "name": "release",
        "description": "release gold bits"
      }
    ]


## ChannelAddImage (POST /images/:uuid?action=channel-add)

Add an image (on the current channel) to a new channel.

### Inputs

||**Field**||**Type**||**Required?**||**Notes**||
|| uuid (path) ||UUID||Yes||The existing image UUID.||
|| action (query param) ||String||Yes||"channel-add"||
|| channel (query param) || String || No || The image channel to use. (Only relevant for servers using [channels](#channels).) ||
|| channel (body) ||String||Yes||The channel to which to add the image.||

Note: Somewhat confusingly, this endpoint uses *two* independent `channel`
field inputs:

1. The "channel" query param, used to find the given image (as with
   most other endpoints), and
2. the "channel" param in the *body*, giving the channel to which to
   add image.

### Returns

The updated image object. The new channel should now be a member of the
image object's [`channels`](#manifest-channels) array.

### Errors

See [Errors](#errors) section above.

### Example

CLI tool:

    $ updates-imgadm channel-add staging 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Added image 25ab9ddf-96e8-4157-899d-1dc8be7b9810 to channel "staging"



# Miscellaneous API

<!-- #ifdef PRIVATE -->
## Ping (GET /ping)

A simple ping to check to health of the IMGAPI server. Here "pid" is the PID
of the IMGAPI server process. This is helpful for the test suite.

### Inputs

||**Field**||**Type**||**Description**||
||error||String||Optional. An error code name, e.g. "ResourceNotFound" to simulate an error response.||
||message||String||Optional. The error message to include in the simulated error response. Defaults to "pong".||

### Returns

When not simulating an error response, a "pong" object is returned:

||**Field**||**Type**||**Description**||
||ping||String||"pong"||
||pid||String||The PID of IMGAPI server process. Only for non-"public" mode IMGAPI configurations.||
||version||String||The version of the IMGAPI app.||
||imgapi||Boolean||true||

When simulating an error, the HTTP response code depends on the error type
and the response body is an JSON object with:

||**Field**||**Type**||**Description**||
||code||String||A restify error code, e.g. "ResourceNotFound", "InternalError". ||
||message||String||Error message.||

### Examples

    $ sdc-imgapi /ping
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 45
    Date: Tue, 08 Jan 2013 19:52:42 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f6f24850-59cc-11e2-b638-4b6ffa4ca56f
    x-response-time: 0
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "ping": "pong",
      "pid": 23097,
      "version": "1.0.0"
    }

Ping can also be used to simulate error responses from the IMGAPI:

    $ sdc-imgapi /ping?error=ValidationFailed
    HTTP/1.1 422 Unprocessable Entity
    Content-Type: application/json
    Content-Length: 56
    Date: Tue, 08 Jan 2013 19:53:31 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 143dfa30-59cd-11e2-b638-4b6ffa4ca56f
    x-response-time: 0
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "code": "ValidationFailed",
      "message": "boom",
      "errors": []
    }

<!-- #else -->

## Ping (GET /ping)

A simple ping to check to health of the IMGAPI server.

### Returns

A "pong" object is returned:

||**Field**||**Type**||**Description**||
||ping||String||"pong"||
||version||String||The version of the IMGAPI app.||
||imgapi||Boolean||true||

### Examples

    $ curl -i https://images.joyent.com/ping
    HTTP/1.1 200 OK
    Date: Fri, 22 Feb 2013 23:52:18 GMT
    Content-Type: application/json
    Connection: keep-alive
    Content-Length: 60
    Server: Joyent Image API
    x-request-id: e41046a0-7d4a-11e2-8ad6-7ff4644169eb
    x-response-time: 1
    x-server-name: b908c5b2-ccd9-4f43-b5ff-2997eb6bd682.local

    {
      "ping": "pong",
      "version": "1.0.0",
      "imgapi": true
    }
<!-- #endif -->


<!-- #ifdef PRIVATE -->
## AdminGetState (GET /state)

Return server internal state. For debugging/dev only.

### Inputs

None.

### Returns

A JSON representation of some internal state.

### Example

    $ sdc-imgapi /state
    {
      "cache": {
        ...
      },
      "log": {
        "level": 20
      },
      ...
    }
<!-- #endif -->


<!-- #ifdef PRIVATE -->
# Image file storage

There are two possible storage mechanisms for the (large) image files (and image
icon files). Which are in use depend on the IMGAPI configuration (and
availability in the DC).

1. manta: Requires an available Manta for this DC's region. All files are
   store in the "imgapi" user's Manta area. Manta storage may be local
   (preferred) or remote.
2. local: A local dir (or locally mounted dir). Only really mean for testing,
   development and bootstrapping. Generally 'local' usage is insufficient
   for producion usage because a locally mounted dir can't handle HA (imgapi
   zones on more than one server).

The set of available storages is set in the configuration. E.g.:

    "storage": {
        "manta": {
            "url": "https://us-east.manta.joyent.com",
            "user": "admin",
            "insecure": false,
            "remote": true,
            "key": "/root/.ssh/imgapi.id_rsa",
            "keyId": "59:8a:63:3f:9d:5d:69:5f:cf:37:2e:0d:84:80:91:da"
        },
        "local": {
            "baseDir": "/data/imgapi"
        }
    }

Local Manta storage, if available, is used in preference to "local" storage.
Manta storage is *required* for user custom image creation, i.e. CloudAPI's
[CreateImageFromMachine](http://apidocs.joyent.com/cloudapi/#CreateImageFromMachine).

If Manta storage is available *but is remote*, then which storage is used is a
little more complicated. The intention is that user-created custom images
(i.e. IMGAPI's CreateImageFromVm, aka CreateImageFromMachine on cloudapi) go
to Manta. However, admin-managed public images for the DC are typically large
and can't practically live in a remote Manta. Therefore the algorithm is that
"admin"-owned images prefer local storage to "remote Manta" storage. Images
owned by others prefer remote Manta storage to local storage.
<!-- #endif -->


<!-- #ifdef PRIVATE -->
# Configuration

Reference docs on configuration vars to imgapi. Default values are in
"etc/defaults.json". Custom values are provided in a JSON file passed in with
the "-f CFG-FILE" command-line option. By default this is
"./etc/imgapi.config.json". Note that given custom values override full
top-level keys in the factory settings. For example: if providing
'ufds', one must provide the whole 'ufds' object.

||**var**||**type**||**default**||**description**||
||port||Number||8080||Port number on which to listen.||
||serverName||String||IMGAPI/$version||Name of the HTTP server. This value is present on every HTTP response in the 'server' header.||
||logLevel||String/Number||debug||Level at which to log. One of the supported Bunyan log levels. This is overridden by the `-d|--debug` switch.||
||maxSockets||Number||100||Maximum number of sockets for external API calls||
||mode||String||public||One of 'public' (default, running as a public server e.g. images.joyent.com), 'private' (a ironically "public" server that only houses images marked `public=false`), or 'dc' (running as the IMGAPI in an SDC datacenter).||
||datacenterName||String||-||Name of the SDC datacenter on which IMGAPI is running.||
||adminUuid||String||-||The UUID of the admin user in this SDC.||
||channels||Array||-||Set this make this IMGAPI server support [channels](#channels). It must be an array of channel definition objects of the form `{"name": "<name>", "description": "<desc>"[, "default": true]}`. See the example in "etc/imgapi.config.json.in".||
||placeholderImageLifespanDays||Number||7||The number of days after which a "placeholder" image (one with state 'failed' or 'creating') is purged from the database.||
||allowLocalCreateImageFromVm||Boolean||false||Whether to allow CreateImageFromVm using local storage (i.e. if no manta storage is configured). This should only be enabled for testing. For SDC installations of IMGAPI `"IMGAPI_ALLOW_LOCAL_CREATE_IMAGE_FROM_VM": true` can be set on the metadata for the 'imgapi' SAPI service to enable this.||
||minImageCreationPlatform||Array||see defaults.json||The minimum platform version, `["<sdc version>", "<platform build timestamp>"]`, on which the proto VM for image creation must reside. This is about the minimum platform with sufficient `imgadm` tooling. This is used as an early failure guard for [CreateImageFromVm](#CreateImageFromVm).||
||ufds.url||String||-||LDAP URL to connect to UFDS. Required if `mode === 'dc'`.||
||ufds.bindDN||String||-||UFDS root dn. Required if `mode === 'dc'`.||
||ufds.bindPassword||String||-||UFDS root dn password. Required if `mode === 'dc'`.||
||auth||Object||-||If in 'public' mode, then auth details are required. 'dc' mode does no auth.||
||auth.type||String||-||One of 'basic' (HTTP Basic Auth) or 'signature' ([HTTP Signature auth](https://github.com/joyent/node-http-signature)).||
||auth.users||Object||-||Required if `auth.type === 'basic'`. A mapping of username to bcrypt-hashed password. Use the `bin/hash-basic-auth-password` tool to create the hash.||
||auth.keys||Object||-||Required if `auth.type === 'signature'`. A mapping of username to an array of ssh public keys.||
||database||Object||-||Database info. The "database" is how the image manifest data is stored.||
||database.type||String||ufds||One of 'ufds' (the default, i.e. use an SDC UFDS directory service) or 'local'. The 'local' type is a quick implementation appropriate only for smallish numbers of images.||
||database.dir||String||-||The base directory for the database `database.type === 'local'`.||
||storage||Object||-||The set of available storage mechanisms for the image *files*. There must be at least one. See the [Image file storage](#image-file-storage) section for discussion.||
||storage.local||Object||-||Object holding config information for "local" disk storage.||
||storage.local.baseDir||String||-||The base directory in which to store image files and archived manifests for "local" storage. This is required even if "storage.manta" is setup for primary storage, because image manifest archives are first staged locally before upload to manta.||
||storage.manta||Object||-||Object holding config information for Manta storage.||
||storage.manta.baseDir||String||-||The base directory, relative to '/${storage.manta.user}/stor', under which image files are stored in Manta.||
||storage.manta.url||String||-||The Manta API URL.||
||storage.manta.insecure||Boolean||false||Ignore SSL certs on the Manta URL.||
||storage.manta.remote||Boolean||-||Whether this Manta is remote to this IMGAPI. This helps IMGAPI determine practical issues on whether manta or local storage is used for large files.||
||storage.manta.user||String||-||The Manta user under which to store data.||
||storage.manta.key||String||-||Path to the SSH private key file with which to authenticate to Manta.||
||storage.manta.keyId||String||-||The SSH public key ID (signature).||
||wfapi.url||String||-||The Workflow API URL.||
||wfapi.workflows||String||-||Array of workflows to load.||
||wfapi.forceReplace||Boolean||-||Wether to replace all workflows loaded every time the IMGAPI service is started. Ideal for development environments||



# Developer Guide

## Repositories

    node-sdc-clients.git    # Includes imgapi.js node library for using IMGAPI.
    node-imgmanifest.git    # Defines the SmartDataCenter Image manifest spec
                            #   and support for validation and upgrade.
    imgapi-cli.git          # `*-imgadm` tools for common IMGAPI servers,
                            #   e.g. `joyent-imgadm`, `sdc-imgadm`,
                            #   `updates-imgadm` and a framework for tools
                            #   for other IMGAPI servers.
    smartos-live.git        # Holds the SmartOS base `imgadm` tool
                            #   (in src/img). Currently in "imgadm2.git".
    imgapi.git              # The IMGAPI server


# Operator Guide

This section is intended to give necessary information for diagnosing and
dealing with issues with Image API in a SmartDataCenter installation.

There is one IMGAPI service per datacenter. There might actually be more than
one "imgapi" zone for HA. Use this to list the imgapi zones in a DC:

    sdc-vmapi /vms?owner_uuid=$(bash /lib/sdc/config.sh -json | json ufds_admin_uuid) \
        | json -H -c "this.tags.smartdc_role=='imgapi'"


## Health

An IMGAPI server has a "/ping" endpoint to indicate if it is up

    $ sdc-imgapi /ping

or if there are multiple IMGAPI servers:

    $ for ip in $(bash /lib/sdc/config.sh -json | json imgapi_admin_ips | tr ',' ' '); do \
        echo "# $ip" ; \
        curl -sS http://$ip/ping | json ; \
    done

TODO: sdc-healthcheck, sdc-webinfo


## Logs

||**service/path**||**where**||**format**||**tail -f**||
||imgapi||in each "imgapi" zone||[Bunyan](https://github.com/trentm/node-bunyan)||`` sdc-login imgapi; tail -f `svcs -L imgapi` | bunyan ``||


## HOWTO: Enable custom image creation without Manta

By default, an IMGAPI in SDC only allows custom image creation (via the
CreateImageFromVm endpoint) if it is configured with Manta storage for
custom image files. However for *test* SDC standups you can hack IMGAPI
to allow local custom image storage.

The symptom of needing to do this from cloudapi or the node-smartdc CLI is:

    $ sdc-createimagefrommachine --machine 3d68ee48-d1fa-685c-9c33-e23064141138 --imageVersion 1.0.0 --name image1 --description "Does this work"
    sdc-createimagefrommachine: error (NotAvailable): custom image creation is not currently available


To allow custom images using *local* storage, run the following in your
SDC headnode global zone:

    echo '{"metadata": {"IMGAPI_ALLOW_LOCAL_CREATE_IMAGE_FROM_VM": true}}' \
      | sapiadm update $(sdc-sapi /services?name=imgapi | json -H 0.uuid)

When the 'config-agent' running in the imgapi zone picks up this change
(after about 30s), the imgapi service will be restarted with
`"allowLocalCreateImageFromVm": true` (see [the Configuration
section](#configuration) above).


## HOWTO: Dig into IMGAPI's Manta storage

If this IMGAPI is setup to use Manta.

        HN=stage2    # my SDC headnode login

        # Get one of the Manta LB IPs:
        export MANTA_URL=https://$(ssh $HN "/opt/smartdc/bin/sdc-vmapi /vms?tag.manta_role=loadbalancer | json -H -c 'this.state==\"running\"' 0.nics | json -c 'this.nic_tag==\"external\"' 0.ip" 2>/dev/null)

        # Get a local copy of the admin SSH key being used for Manta access
        # (or add your own to the admin user).
        ZONENAME=$(ssh $HN vmadm lookup -1 alias=imgapi0)
        mkdir -p /var/tmp/$HN
        cd /var/tmp/$HN
        scp $HN:/zones/$ZONENAME/root/root/.ssh/id_rsa* .

        # This would be sufficient for python-manta and mantash:
        #    export MANTA_KEY_ID=`pwd`/id_rsa
        # However, node-manta tools are a little more picky. You need to
        # have your id_rsa in ~/.ssh or in your agent. So we'll do the
        # latter:
        chmod 0600 id_rsa*
        ssh-add `pwd`/id_rsa
        MANTA_KEY_ID=$(ssh-keygen -l -f id_rsa.pub | awk '{print $2}')

        export MANTA_USER=admin
        set | grep MANTA_

        # With mantash from python-manta:
        mantash -k find /admin/stor/imgapi

        # With node-manta tools:
        # TODO: I think node-manta tools don't support a non-default path
        # to the ssh key?


## Configuring IMGAPI for HTTPS

This section is for setting up an IMGAPI that lives *outside* of an SDC
installation. Examples of this are for <https://images.joyent.com> and
<https://updates.joyent.com>.

On SmartOS, IMGAPI can be deployed to support HTTPS with the use of Stud
(https://github.com/bumptech/stud) as a SSL/TLS termination proxy. Because of the
way Stud works we need to put an additional reverse proxy between Stud and IMGAPI:
HAProxy. The only caveat here is that the latest version of HAProxy doesn't
fully understand the traffic coming from Stud, so we use a patched version of
the package.

### Prerequisites and Assumptions

* IMGAPI running on an Image with at least a 2012Q2 release of pkgsrc
* IMGAPI running on port 8080 if using configuration defaults
* Generated certficate file
* gmake

### Installing and Configuring HAProxy

The IMGAPI repository contains the patched copy of HAProxy under the deps/
directory. cd to that directory and proceed to compile HAProxy as follows:

    cd $IMGAPI_REPO/deps/haproxy-1.4.21/
    gmake TARGET=solaris

It's not necessary to move the resulting binary to another location. Now, we need
to configure HAProxy. This repository contains a sample configuration file (on
etc/haproxy.cfg.in) that will make the proxy listen on port 8443 and redirect
its traffic to port 8080.

The final step is to import the HAProxy SMF file in order to run the proxy as a
service. The IMGAPI repository contains a sample service definition file that
can be imported after updating the exec_method tag and config_file values to
reflect the current install setup. With a valid SMF file we can proceed to
import it and start running HAProxy:

    cp $IMGAPI_REPO/smf/manifests/haproxy.xml.in $IMGAPI_REPO/smf/manifests/haproxy.xml
    # --- Replace variables ---
    svccfg import $IMGAPI_REPO/smf/manifests/haproxy.xml
    svcadm enable haproxy:default

### Installing and configuring Stud

Configuring Stud is easier since it doesn't require a custom binary, we use the
version provided by pksrc. Additionally, pkgsrc provides a sample SMF and
configuration file to use for Stud. Begin by installing the package:

    # Install Stud
    pkgin -y in stud-0nb20120827

This package will write a sample configuration file to /opt/local/etc/stud.conf.
For this guide we assume that Stud will terminate and redirect its traffic to a
service listening on port 8443. The only additional value we need to modify
is pem-file, which specifies the location of the SSL certificate to use. After
updating the configuration file we enable the Stud SMF service, since the sample
SMF file was already imported (assuming we are OK with using
/opt/local/etc/stud.conf as the location for our configuration file):

    svcadm enable stud:default

At this point Stud, HAProxy and IMGAPI should all be running correctly. We can
confirm this with the help of the netstat command:

    netstat -f inet -an

    TCP: IPv4
       Local Address        Remote Address    Swind Send-Q Rwind Recv-Q    State
    -------------------- -------------------- ----- ------ ----- ------ -----------
          *.8080               *.*                0      0 128000      0 LISTEN
          *.8443               *.*                0      0 128000      0 LISTEN
    127.0.0.1.8081             *.*                0      0 128000      0 LISTEN
          *.443                *.*                0      0 128000      0 LISTEN


# Portal Guide

This is a short guide to portal developers wanting to integrate image mgmt.

The main cloudapi endpoints you'll be using for this are:
- [CreateImageFromMachine](https://mo.joyent.com/docs/cloudapi/master/#CreateImageFromMachine)
- [GetImage](https://mo.joyent.com/docs/cloudapi/master/#GetImage)
- [DeleteImage](https://mo.joyent.com/docs/cloudapi/master/#DeleteImage)
- UpdateImage (not yet exposed via cloudapi)

You'll need to be using a recentish node-smartdc.git and calling the client with
an Api-Version header that gets the 7.1 version of the API at least. E.g. in my
test code my cloudapi client is created like this:

    self._cloudapi = smartdc.createClient({
        url: prof.url,
        account: prof.account,
        version: '*',    // <--- asking for latest version
        noCache: true,
        rejectUnauthorized: Boolean(prof.rejectUnauthorized),
        sign: sign,
        logLevel: this.log && this.log.level()
    });

The process for a user to create an image is to call CreateImageFromMachine
with one of their machines that is setup the way they want it. This call also
takes image manifest data: name, version, description, etc. Minimally the
API requires 'machine', 'name' and 'version'. So presumably the "Create Image"
flow in portal would include a form with all the CreateImageFromMachine
fields.

The initial call to CreateImageFromMachine will return a "placeholder" image
object with the image UUID (the `id` field) and a `state` of "creating", e.g.:

    {
        "id": "62306cd7-7b8a-c5dd-d44e-8491c83b9974",
        "name": "Priam",
        "version": "1.2.3",
        "requirements": {},
        "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
        "public": false,
        "state": "creating"
    }

There is some basic validation of the CreateImageFromMachine inputs. An error
response example:

    HTTP/1.1 422 Unprocessable Entity
    content-type: application/json
    content-length: 413
    access-control-allow-origin: *
    access-control-allow-headers: Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, Api-Version, Response-Time
    access-control-allow-methods: GET, HEAD, POST
    access-control-expose-headers: Api-Version, Request-Id, Response-Time
    connection: Keep-Alive
    content-md5: Q9a1XQBHShbKgT7ADF6Tgw==
    date: Wed, 11 Dec 2013 19:02:40 GMT
    server: Joyent SmartDataCenter 7.1.0
    api-version: 7.1.0
    request-id: ceb8a270-6296-11e3-9c6e-ad55ae466bcb
    response-time: 277
    x-request-id: ceb8a270-6296-11e3-9c6e-ad55ae466bcb
    x-api-version: 7.1.0
    x-response-time: 277

    {
        "code": "ValidationFailed",
        "message": "invalid image data: name, version",
        "errors": [
          {
            "field": "name",
            "code": "Invalid",
            "message": "image name has invalid characters (only alpha-numeric characters and \" \", \".\", \"-\", \"_\" and \"/\" are allowed)"
          },
          {
            "field": "version",
            "code": "Invalid",
            "message": "image version has invalid characters (only alpha-numeric characters and \".\", \"-\", \"_\" and \"/\" are allowed)"
          }
        ]
    }

That `errors` array format is documented here:
<https://mo.joyent.com/docs/eng/master/#error-handling>. Presumably this could
be used for form validation.

The image state can be retrieved with GetImage using the `id` from the original
call. The placeholder image will also show up in ListImages if the `state=all`
parameter is used. The image states are:

- `failed`: The image creation failed. There will be an `error` object of the
  form:

        ...
        "error": {
            "code": "SomeCamelCaseErrorCode",
            "message": "some description of the error"
        },
        ...

  For example:

        {
            "id": "d4ac3751-64f1-6929-ee92-fe01e14743b7",
            "name": "Briseis",
            "version": "1.2.3",
            "requirements": {},
            "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
            "public": false,
            "state": "failed",
            "error": {
                "code": "PrepareImageDidNotRun",
                "message": "prepare-image script did not indicate it was run (old guest tools in VM 670e2535-9f3a-494f-d066-a280f4ab0d85?)"
            }
        }

  The possible errors codes are documented in
  [GetImage](https://mo.joyent.com/docs/cloudapi/master/#GetImage).

  Note: I hope to eventually have a URL to a troubleshooting page for each
  `error.code`. The URL will be in the error.message or perhaps in a separate
  `error.url`. It might be interesting for portal to link to that if present.

- `creating`: Still creating.

- `unactivated`: The image has been created on the CN and is in the process
  of being published to IMGAPI.

- `active`: The image has been successfully created and is ready for use.


ListImages shows all images to which a user has access. Images that the user
*owns*, i.e. for which the `owner` field is the user's UUID, can be deleted
by that user via DeleteImage.

Caveats/Limitations:

- Existing machines created *before* the img mgmt feature is released *might*
  not support image creation. That sucks a little for portal providing a "create
  image" link next to machines. The reasons pre-existing machines might be
  un-imageable are:

  1. They reside on a CN running a too old platform. The JPC reboot should fix
     that by ~Feb. This case will error on the CreateImageFromMachine call
     with error code `InsufficientServerVersionError`.

  2. They were migrated. Our current and old migrator script broke a image link
     at the ZFS level that image mgmt requires. This will be an async error,
     but fairly quick, with an `error.code = "VmHasNoOrigin"` on the failed
     image.

  Theoretically we could mark each machine's "internal_metadata" in VMAPI with
  whether they fall under this category 2. But I need to defer that until after
  the initial rush.

  For now, perhaps the portal could start by not allowing image creation on
  machines with a created_at before $(date we release img mgmt to JPC).
  Dev Note: This presumes the migrator script is fixed (SYSOPS-6491) for future
  migrations.

- Image creation for a Linux machine will fail with `PrepareImageDidNotRun`
  (that will take ~5 minutes to timeout to that error) until they've done a one
  time upgrade of their Linux guest tools. We'll have a one-liner for them to
  run to do that, and the updated image creation docs will show how to do that.
  I'm working no those this week.

  We'll also have new Linux images soonish that will include the new Linux
  guest tools.

- We don't support image creation for machines created from images other than:
  smartos images, CentOS images, Ubuntu images. Eventually others (like debian
  and freebsd) will be added.

Please ping me (Trent Mick <trent.mick@joyent.com>) if you need something from
the API to reasonably integrate this into portal. The current relevant roadmap
section is [M7 above](#m7-automated-snapshot-and-prepare-image). It includes
some rough notes on planned and desireable polishing, some of this touch on
the portal.

<!-- #endif -->
