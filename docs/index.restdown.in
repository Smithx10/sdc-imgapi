---
title: Image API (IMGAPI)
markdown2extras: wiki-tables, code-friendly, cuddled-lists, link-patterns
markdown2linkpatternsfile: link-patterns.txt
apisections: Miscellaneous API, Image API
---

# Image API (IMGAPI)

The Image API (or Images API, or IMGAPI) is the SDC7 replacement for the Dataset
API (DSAPI) in earlier versions of SDC. Along with the SmartOS `imgadm`
tool, various instances of the IMGAPI manage images in the SDC and SmartOS
ecosystem.


# Introduction

An "image" is virtual machine image content (e.g. a zfs dataset for a
SmartOS zone or a KVM machine image) plus [the metadata for the image (called
the "manifest")](#image-manifest-data). The following API instances and tools
are relevant for managing images in SmartOS and SDC.

<!-- #ifdef PRIVATE -->
The old Datasets API (DSAPI, e.g. https://datasets.joyent.com) will live
until all SDC 6 instances are done. This provides Joyent-vetted images
(a.k.a. datasets) for use in SDC 6 standups. In SDC 6, MAPI (the Master API)
running inside each datacenter manages datasets within that datacenter.
MAPI's "/datasets" endpoints provide a subset of the DSAPI API.
<!-- #endif -->

The joyent IMGAPI (https://images.joyent.com) is the central repository
of Joyent-vetted base images for usage in SmartOS. (Images from software
vendors may exist here, but are still vetted by Joyent.) All images here are
public -- no read auth, no private images. SmartOS' `imgadm` version 2
is configured to use this image repository by default. SDC's operator portal
(a.k.a. adminui) is configured by default to list this repository from which
to import images.

<!-- #ifdef PRIVATE -->
Administration of https://images.joyent.com is via the `joyent-imgadm`
tool (currently available in `git@git.joyent.com:imgapi-cli.git`).

There is an IMGAPI in each SDC datacenter that manages images available in
that datacenter. "IMGAPI" without scoping typically refers to this IMGAPI
in a given datacenter. This is the authority for which images are available
for provisioning in that DC. The provisioning process will lazily
`zfs receive` images on CNs as necessary -- streaming from the IMGAPI
(`imgadm` on that machine handles that). IMGAPI supports private images,
customer-owned images, etc. Cloud API speaks to IMGAPI for its
['/images'](https://mo.joyent.com/docs/cloudapi/master/#images) and legacy
['/datasets'](https://mo.joyent.com/docs/cloudapi/master/#datasets)
endpoints.

See [Use Cases](#use-cases) for details on how IMGAPI is (designed to be)
used.
<!-- #endif -->


<!-- #ifdef PRIVATE -->
# Current Status

- Good: The 'imgapi' zone is available and running in sdc with most endpoints
  implemented (see [API Summary](#api-summary)).

- Good: `sdc-imgadm` is available in SDC GZs for managing the datacenter's
  IMGAPI from the command-line.

- Good: `imgadm` v2 for SmartOS (imgadm v2) is in.

- Good: Manta as a storage backend support is in.

- Good: SDC 6.5 backward compatibility, i.e. providing images to 6.5 CNs
  with IMGAPI, is working fine in JPC now.

- Bad: The full process for a user creating a custom image (IMGAPI-93)
  in incomplete. See [Custom Image Management
  Roadmap](#custom-image-management-roadmap) below.

- Bad: Notably unimplemented is MigrateImage for copying images
  between datacenters in the same SDC cloud.


# Custom Image Management Roadmap

From a discussion with Trent, Bryan and Carlos 3 Jun 2013, the MVP image mgmt
plan is to:

- wait until we fully implement support for both zones and KVM (common case
  in JPC is custom KVM images);
- implement incremental images (because we need a manta for storage of
  customer images, we only have the Manta in us-east, we want image mgmt in
  other DCs so we'll pull images across the WAN, incr images will help a
  *lot* here, also a great differentiator);

Top-level ticket (FWIW) is IMGAPI-93.

## M1: basics

*Done.* (1-2 weeks) First, getting the basic full stack creation of non-KVM
images, walking up the stack from the platform level:

- [done, IMGAPI-95, trent, platform] `imgadm create` and `imgadm publish`
  'create' is just for non-KVM VMs so far
- [done, OS-2323, andres] bug in 'imgadm create' work that breaks
  'imgadm import'
- [done, AGENT-605] machine_image_create task for custom image creation
- [done, CNAPI-259] [https://mo.joyent.com/docs/cnapi/master/#VmImagesCreate]
- [done, IMGAPI-191, andres] CreateImageFromVm
- [done, PUBAPI-591, trent/pedro] CreateImageFromMachine
- [done, RELENG-491, trent]: sdc-system-tests tests for this. Create an image
  from cloudapi and use it from cloudapi.
- [done, PUBAPI-639, trent] Cloud API docs for CreateImageFromMachine.
  Hidden behind a guard so only at
  <https://mo.joyent.com/docs/cloudapi/master/#CreateImageFromMachine> for now.
- [done, PUBAPI-653, trent] enable cloudapi img mgmt endpoints for whitelist of users


## M2: incremental images

*Done.* Incremental images. Plan is that all custom images created via
cloudapi are incremental.

- [done, IMGAPI-124] incremental images support: manifest fields, CreateImage,
  AdminImportImage
- [done, OS-2401] incremental images support in 'imgadm create', 'imgadm
  install', 'imgadm import'
- [done, PUBAPI-655, trent] Get cloudapi to pass incremental:true


## M3: Working with mixed CNs

(2 weeks) Working with mixed CNs: some with sufficient support, some not.
This means documenting usage in a DC (e.g. JPC) for a subset of packages for
proto VMs.

- [AGENT-644, orlando] *6.5* provisioner agent support for incremental images
- [RELENG-496, john] Set up staging to more closely reflect JPC
- [DAPI-143, marsell] add handling for a min_platform package field
- [PAPI-22, pedro] add min_platform package field
- [IMAGE-318, carlos]: spec small set of packages using min_platform for use for
  VMs for image creation
- [trent] Docs/tooling for managing these packages. My plan here is to just
  come up with oneliners for these and document them in a section of the
  [IMGAPI Operator Guide](https://mo.joyent.com/docs/imgapi/master/#operator-guide).
    - update min_platform for a new required fix: 'sdc-ldap' can't search fields
      with an underscore, so might really want that 'sdc-ufds' replacement.
      Or sdc-packageadm.
    - list available CNs matching that platform
    - list available capacity (a quick hack script for this if we don't have
      a more complete "Capacity Aware Packages" answer by then)
    - list all VMs provisioned with these packages. Consider them "dirty" if
      they have a long life?
- [merline/jens/et al] Discuss if we want to use traits ("image-create" or
  whatever) on the image creation packages and the few CN(s) in us-east to
  ensure capacity. I.e. to ensure that CN is *only* used for image creation.


## M4: more basics

(1.5 weeks) The remaining scraps from M1 to help clarify required remaining work.

- [IMGAPI-250, andres]: state=error|creating|... for better UX for cloudapi's
  CreateImageFromMachine
- [PUBAPI-659, trent]: UpdateImage, DeleteImage and tweaks to exposed fields
  in GetImage and ListImages
  Note: Specifically doc that 'public' is not updatable or settable right now.
  Don't want user-created *public* images in JPC right now. For now guard that
  in PUBAPI.
- [PUBAPI-660, trent/pedro] node-smartdc: add sdc-createimagefrommachine,
  sdc-deleteimage, sdc-updateimage


## M5: supporting SDC image builds

The work required to be able to do SDC builds in JPC.

- [IMGAPI-249, trent] ExportImage endpoint
- [RELENG-492, john] get builds to work with slaves in us-east-1 JPC zones


## M6: KVM image support

(2 weeks, very rough time estimate) KVM image support.

- [OS-???] kvm support for `imgadm create`
- [OS-???] kvm support for incremental images (might not require anything
  special here)
- test kvm custom images working through the stack



## M7: remote streaming

**Note:** Presuming a first JPC rollout *to us-east only*, this milestone is
not necessary for the end-of-Aug cut.

(3 weeks, again very rough estimate) Support for remote streaming (from
remote manta) of image files for install in local DC. If necessary (typically
large incr images and/or slow WAN download), intelligent local
pre-caching/loading of images. An obvious case is if a customer creates an
image in west-1 (which gets published to the manta in east), then that image
should be cached in west-1 for likely provisioning there.

Proposed plan tl;dr: Each IMGAPI maintains an image file MRU cache on local
disk. This is IMGAPI-235.

Proposed plan: Each IMGAPI has a size-limited local MRU cache dir. Limited by
two config vars: cacheLimitPercent, % available space on that mount
(determined at start up and periodically re-checked for resizing) and
cacheLimitSize, max absolute space (e.g. 20GB). Would also attempt to limit
to <90% total usage for that disk. File caching is only done if the stored
file is "remote". "Remote" is a boolean attribute of the "storage" config
var. IMGAPI changes to manage this cache:

- Add AdminFileCacheAdd to POST (or PUT) a file to the local cache
  (a la AddImageFile)
- Change GetImageFile: if file storage is remote, then use the local cache
  if available there. Perhaps if NOT available locally, then stream to the
  local cache. I.e., if used by one CN in this DC, then likely will be
  wanted again soon for another one.
- Change AdminGetState to also include the local file LRU cache index.
- Add AdminFileCacheFlush (perhaps, if this is useful):
  POST /state?flush-file-cache
- Change AddImageFile, if file storage is remote, to stream to the local
  file LRU cache.
- Change CreateImageFromVm, if file storage is remote, to stream to the local
  file LRU cache.
- For HA (IMGAPI-140): Change AddImageFile, if file storage is remote, to
  find other IMGAPIs in this DC and call AdminFileCacheAdd on those.

Create a followable metric (via SDC log analysis) to track GetImageFile
times to help improve this caching.


## M8: customer moving images between DCs

**Note:** Presuming a first JPC rollout *to us-east only*, this milestone is
not necessary for the end-of-Aug cut.

(1 week, likely will fall easily out of M5) Will need to have MigrateImage
(or whatever name we choose) solved for a customer making a custom image in
DC1 availalbe for provisioning in DC2.

## M9: capacity handling

**Note:** This milestone probably not required for shipping img mgmt in JPC.

- What happens when there are >1000 images for a typical search case? Currently
  IMGAPI doesn't handle paging through "ListImages" results. Proper paging
  here might require moving IMGAPI's db of manifests from UFDS to Moray.
  This is IMGAPI-182
- Ability to have a limit if custom images per user, e.g. so that people
  don't start using custom images as a cheap/easy way to do backups.
- How well does IMGAPI fail when its local dir for images files runs out
  of space? Test it.

## M10: tracking usage and billing

This is underspecified. Some notes:

- Image files are stored in manta under '/admin/imgapi', split out per customer
  (and per DC). Billing should include a line item for storage usage for each
  user.
- What about zpool usage for custom images? Marsell notes: "As an aside, what
  have the people above said about how we'll handle custom images taking up
  space in a zpool? We don't charge ourselves for our images being cached on a
  CN, but this could start presenting a serious problem once we support custom
  images." Not sure how much of an issue this will be or how best to handle
  it. Separate billing line items for this? Grace value? Zonetracker should
  track this? Usage API work to store that data.

## M11: misc

A collection of tickets that should be address for robustness, UX, etc. but
aren't strictly required for a starting rollout.

- [WORKFLOW-113, pedro, done?] Workflow RFE to be able to serialize jobs on
  the same vm_uuid. This to guard against an attempt to DeleteMachine
  or StartMachine on a VM being used to create an image until
  CreateImageFromMachine is complete. This isn't a blocker, *could*
  just doc this.
- [OS-???, IMGAPI-92, andres, minor] IMGAPI version header usage from imgadm for
  future proofing.
- [PUBAPI-???, trent] What about exposing adding an image icon via cloudapi?


<!-- #endif -->


# API Summary

||**Name**||**Endpoint**||**Notes**||
||[ListImages](#ListImages)||GET /images||List available images.||
||[GetImage](#GetImage)||GET /images/:uuid||Get a particular image manifest.||
||[GetImageFile](#GetImageFile)||GET /images/:uuid/file||Get the file for this image.||
||[DeleteImage](#DeleteImage)||DELETE /images/:uuid||Delete an image (and its file).||
||[CreateImage](#CreateImage)||POST /images||Create a new (unactivated) image from a manifest.||
||[AddImageFile](#AddImageFile)||PUT /images/:uuid/file||Upload the image file.||
||[ActivateImage](#ActivateImage)||POST /images/:uuid?action=activate||Activate the image.||
||[UpdateImage](#UpdateImage)||POST /images/:uuid?action=update||Update image manifest fields. This is limited. Some fields are immutable.||
||[DisableImage](#DisableImage)||POST /images/:uuid?action=disable||Disable the image.||
||[EnableImage](#EnableImage)||POST /images/:uuid?action=enable||Enable the image.||
||[AddImageAcl](#AddImageAcl)||POST /images/:uuid/acl?action=add||Add account UUIDs to the image ACL.||
||[RemoveImageAcl](#RemoveImageAcl)||POST /images/:uuid/acl?action=remove||Remove account UUIDs from the image ACL.||
||[AddImageIcon](#AddImageIcon)||POST /images/:uuid/icon||Add the image icon.||
||[GetImageIcon](#GetImageIcon)||GET /images/:uuid/icon||Get the image icon file.||
||[DeleteImageIcon](#DeleteImageIcon)||DELETE /images/:uuid/icon||Remove the image icon.||
<!-- #ifdef PRIVATE -->
||[CreateImageFromVm](#CreateImageFromVm)||POST /images?action=create-from-vm||Create a new (activated) image from an existing VM.||
||[MigrateImage](#MigrateImage)||POST /images/$uuid?action=migrate&dc=us-west-1||**NYI** Migrate one of "my" images from another DC.||
||[AdminImportRemoteImage](#AdminImportRemoteImage)||POST /images/$uuid?action=import-remote&source=$imgapi-url||Import an image from another IMGAPI||
||[AdminImportImage](#AdminImportImage)||POST /images/$uuid?action=import||Only for operators to import an image and maintain `uuid` and `published_at`.||
<!-- #endif -->
||[Ping](#Ping)||GET /ping||Ping if the server is up.||



# Errors

<!-- #include "build/errors.restdown" -->


# Image manifests

An image manifest is all the data about an image except the image file itself.
Generally this is represented as a JSON object. For example:

    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
      "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
      "name": "smartos",
      "version": "1.6.3",
      "state": "active",
      "disabled": false,
      "public": true,
      "published_at": "2012-05-02T15:14:45.805Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "description": "Base template to build other templates on",
      "requirements": {
        "networks": [
          {
            "name": "net0",
            "description": "public"
          }
        ]
      }
    }


A summary of fields (details are provided below):

||**Field**||**Type**||**Always Present?**||**Mutable?**||**Notes**||
||[v](#manifest-v)||Integer||Yes||No||Version of the manifest format/spec. The current value is **2**.||
||[uuid](#manifest-uuid)||UUID||Yes||No||The unique identifier for a UUID. This is set by the IMGAPI server. See details below.||
||[owner](#manifest-owner)||UUID||Yes||No||The UUID of the owner of this image (the account that created it).||
||[name](#manifest-name)||String||Yes||No||A short name for this image. Max 512 characters (though practical usage should be much shorter). No uniqueness guarantee.||
||[version](#manifest-version)||String||Yes||No||A version string for this image. Max 128 characters. No uniqueness guarantee.||
||[description](#manifest-description)||String||No||Yes||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||Yes||Homepage URL where users can find more information about the image.||
||[eula](#manifest-eula)||URL||No||Yes||URL of the End User License Agreement (EULA) for the image.||
||[icon](#manifest-icon)||Boolean||No||Yes (\*)||Indicates if the image has an icon file. If not present, then no icon is present.||
||[state](#manifest-state)||String||Yes||No||The current state of the image. One of 'active', 'unactivated', 'disabled'.||
||[disabled](#manifest-disabled)||Boolean||Yes||No (\*)||Indicates if this image is available for provisioning.||
||[public](#manifest-public)||Boolean||Yes||Yes (\*)||Indicates if this image is publicly available.||
||[published_at](#manifest-published_at)||Date||Yes (if activated)||No||The date at which the image is activated). Set by the IMGAPI server.||
||[type](#manifest-type)||String||Yes||Yes||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, or "zvol" for a virtual machine image.||
||[os](#manifest-os)||String||Yes||Yes||The OS family this image provides. One of "smartos", "windows", "linux" or "other".||
||[origin](#manifest-origin)||UUID||No||No||The origin image UUID if this is an incremental image.||
||[files](#manifest-files)||Array||Yes (if activated)||No||An array with a single object describing the image file.||
||[acl](#manifest-acl)||Array||No||Yes||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[requirements](#manifest-requirements)||Object||No||Yes||A set of named requirements for provisioning a VM with this image||
||[requirements.networks](#manifest-requirementsnetworks)||Array||No||Yes||Defines the minimum number of network interfaces required by this image.||
||[requirements.brand](#manifest-requirementsbrand)||String||No||Yes||Defines the brand that is required to provision with this image.||
||[requirements.ssh_key](#manifest-requirementsssh_key)||Boolean||No||Yes||Indicates that provisioning with this image requires that an SSH public key be provided.||
||[requirements.min_ram](#manifest-requirementsmin_ram)||Integer||No||Yes||Minimum RAM (in MiB) required to provision this image.||
||[requirements.max_ram](#manifest-requirementsmax_ram)||Integer||No||Yes||Maximum RAM (in MiB) this image may be provisioned with.||
||[requirements.min_platform](#manifest-requirementsmin_platform)||Object||No||Yes||Minimum platform requirement for provisioning with this image.||
||[requirements.max_platform](#manifest-requirementsmax_platform)||Object||No||Yes||Maximum platform requirement for provisioning with this image.||
||[users](#manifest-users)||Array||No||Yes||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||No||Yes||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||No||Yes||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[tags](#manifest-tags)||Object||No||Yes||An object of key/value pairs that allows clients to categorize images by any given criteria.||
||[generate_passwords](#manifest-generate-passwords)||Boolean||No||Yes||A boolean indicating whether to generate passwords for the users in the "users" field. If not present, the default value is true.||
||[inherited_directories](#manifest-inherited-directories)||Array||No||Yes||A list of inherited directories (other than the defaults for the brand).||
||[nic_driver](#manifest-nic-driver)||String||Yes (if `type==="zvol"`)||Yes||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||Yes (if `type==="zvol"`)||Yes||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||Yes (if `type==="zvol"`)||Yes||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||Yes (if `type==="zvol"`)||Yes||The size (in MiB) of this VM image's disk.||

"Mutable?" refers to whether this field can be edited via
[UpdateImage](#UpdateImage). The `icon` boolean is effectively changed by
the [AddImageIcon](#AddImageIcon) and [DeleteImageIcon](#DeleteImageIcon)
endpoints. `disabled` can be modified via the [DisableImage](#DisableImage)
and [EnableImage](#EnableImage) endpoints. `public` cannot be set false for
an image on the "public mode" IMGAPI, e.g. <https://images.joyent.com>.


## Manifest: v

A single positive integer indicating the spec version of the image
manifest. The current version is **2**. Version history:

||**v**||**Date**||**Notes**||
||undefined||-||All dataset manifests (commonly ".dsmanifest" files) before SDC 7 do not have a "v" field. Versioning of the manifest via `v` was added in SDC 7. This is commonly referred to as version "1".||
||2||2013-Jan-31||Adds many fields. Deprecates `urn`. Removes already deprecated fields (e.g. `platform_type`). See the "imgmanifest" library for full details.||


## Manifest: uuid

An image `uuid` is the unique identifier for this UUID. This is what you
use to provision a VM. (For backwards compatibility unique identification
via a `urn` field is supported for legacy images. See the [urn section
below](#manifest-urn).)

An image UUID is created by the server on the [CreateImage](#CreateImage).
There are two exceptions: (1) The [MigrateImage](#MigrateImage) endpoint will
copy an image between two datacenters in the same cloud and persist the
UUID. (2) SDC operators can use the [AdminImportImage](#AdminImportImage)
to add an image with a specified UUID. In the latter case it is the
responsibility of the operator to ensure a given UUID is not duplicated,
or refers to different image data between separate clouds. A common case
for the latter is importing "core" Joyent-provided images from
<https://images.joyent.com>.


## Manifest: urn

**Deprecated.**  In SDC versions before SDC 7, an image (then called a
"dataset") could be uniquely identified by its `uuid` *and* by its `urn`.
While this is still true (images with a URN imported into IMGAPI retain
their URN), new images do not get a URN. The assumptions for the components
of URN (`<cloud_name>:<creator_name>:<name>:<version>`) are not maintainable
in global ecosystem of SmartOS images. Therefore the URN has been dropped as
a supported mechanism of uniquely identifying images. Use the `uuid` field.

## Manifest: owner

The account UUID of the owner/creator of this image.


## Manifest: name

A name for this image. Maximum 512 characters. However, typical names should
be much shorter, e.g. 5-20 characters.

Note that image `name` and `version` do not make a unique identifier for
an image. Separate users (and even the same user) can create images with
the same name and version. The image `uuid` is the only unique identifier
for an image.


## Manifest: version

A version string for this image. Maximum 128 characters. This is an opaque
string, i.e. no particular format or structure is enforced and
no ordering with other versions is implied. However, it is strongly suggested
that the [semver](http://semver.org/) versioning scheme be
followed. Further, the simple `Major.Minor.Patch` semver subset is ideal.

Note that image `name` and `version` do not make a unique identifier for
an image. Separate users (and even the same user) can create images with
the same name and version. The image `uuid` is the only unique identifier
for an image.


## Manifest: description

A short prose description of this image. Maximum 512 characters.


## Manifest: homepage

Homepage URL where users can find more information about the image. Maximum 128
characters.

## Manifest: eula

URL of the End User License Agreement (EULA) for the image. Maximum 128
characters.

## Manifest: icon

A boolean indicates if the image has an icon file. If this field is not
present then the image does not have an icon. The actual icon file content
is available via the [GetImageIcon](#GetImageIcon) endpoint.


## Manifest: state

The current state of the image. One of the following values:

||**State**||**Description**||
||active||The image is ready for use, i.e. VMs can be provisioned using this image.||
||unactivated||The image has not yet been activated. See [ActivateImage](#ActivateImage).||
||disabled||The image is disabled. This will be the state if the image is activated, but also `disabled == true`. See [EnableImage](#EnableImage) and [DisableImage](#DisableImage).||

Note that [`disabled`](#manifest-disabled) and [`state`](#manifest-state) can
seem like duplicate information. However `state` is a computed value from
`disabled` and whether an image has yet been activated.


## Manifest: disabled

A boolean indicating if this image is disabled. A disabled image is only
visible to its owner in cloudapi. A disabled image cannot be used for
provisioning.

The [DisableImage](#DisableImage) and [EnableImage](#EnableImage) api
endpoints can be used to update the disabled state of an image.

Note that [`disabled`](#manifest-disabled) and [`state`](#manifest-state) can
seem like duplicate information. However `state` is a computed value from
`disabled` and whether an image has yet been activated.


## Manifest: public

A boolean indicating if this image is publicly available. Public images are
visible (and usable for provisioning) to anyone in cloudapi. Private images
(`public === false`) are only visible to the image owner and accounts listed
in [`acl`](#manifest-acl).


## Manifest: published_at

The date (in ISO-8601 format, e.g. "2012-05-02T15:14:45.805Z") at which this
image was published (i.e. activated via [ActivateImage](#ActivateImage)).

An image UUID is create by the server on the [ActivateImage](#ActivateImage).
There are two exceptions: (1) The [MigrateImage](#MigrateImage) endpoint will
copy an image between two datacenters in the same cloud and persist the
`published_at`. (2) SDC operators can use the
[AdminImportImage](#AdminImportImage) to add an image with a specified uuid
and `published_at`. A common case for the latter is importing "core"
Joyent-provided images from <https://images.joyent.com>.


## Manifest: type

The type of the image file. Must be one of:

||**OS**||**DESCRIPTION**||
||zone-dataset||a ZFS dataset used to create a new SmartOS zone||
||zvol||a KVM virtual machine image||


## Manifest: os

The operating system of the image file. Must be one of:

||**OS**||**DESCRIPTION**||
||smartos||SmartOS||
||linux||Linux, e.g. CentOS, Ubuntu, etc.||
||windows||A Microsoft Windows OS image||
||bsd||FreeBSD/netBSD||
||illumos||Illumos||
||other||A catch-all for other operating systems.||


## Manifest: origin

If an image has an origin, then it is an **incremental image**. The origin is
the UUID of the origin image. Currenly only a single level of parentage is
allowed. I.e. an origin image cannot itself be incremental.


## Manifest: files

The array of image files that make up this image. Currently only a single
file is supported. An image cannot be activated until it has one file
uploaded. A "file" entry has the following fields:

||**FIELD**||**DESCRIPTION**||
||sha1||SHA-1 hex digest of the file content. Used for upload/download corruption checking.||
||size||Number of bytes. Maximum 20GiB. This maximum is meant to be a "you'll never hit it" cap, the purpose is to inform cache handling in IMGAPI servers.||
||compression||The type of file compression used by the file. One of 'bzip2', 'gzip', 'none'.||

Example:

    {
        ...
        "files": [{
            "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
            "size": 46271847,
            "compression": "bzip2"
        }],
        ...
    }

**Backward compatibility notes:** In the DSAPI (Dataset API) from SDC 6.5
that preceded this there were two more fields:

- `files.*.path`: **Obsolete.** This field is no longer provided. It served
  no safe purpose. There was no guarantee that that "path" value was unique
  across images, hence it should not be used client-side.
- `files.*.url`: **Obsolete.** This field is no longer provided. The download
  URL for the image file is
  [`GET /images/:uuid/file` GetImageFile](#GetImageFile).


## Manifest: acl

An array of user/account UUIDs to which to give read access to a private
image. I.e. this is only relevant for images with `public === false`.


## Manifest: requirements

A grouping of various requirements for provisioning a VM with this image.


## Manifest: requirements.networks

Optional. An array describing the minimum number of network interfaces. This
example shows an image that requires one VNIC:

    {
        ...
        "requirements": {
            "networks": [{"name": "net0", "description": "public"}]
            ...
        },
        ...
    }

## Manifest: requirements.brand

Optional. Defines the brand that is required to provision with this image.
Brands are related to the type of virtualization used among other factors.
Currently there are four brands that can be used: 'joyent', 'joyent-minimal',
'sngl' for OS virtualization and 'kvm' for hardware virtualization.

## Manifest: requirements.ssh_key

Optional. A boolean indicating that provisioning with this image requires
that an SSH public key be provided. For example, provisioning a Linux VM
requires an SSH key for initial SSH access. If not defined, it is presumed to
be false.

## Manifest: requirements.min_ram

Optional. `min_ram` is an integer number of MiB specifying the minimum RAM
required to provision this image. If `max_ram` is also specified, then
`min_ram <= max_ram` must be true.

## Manifest: requirements.max_ram

Optional. `max_ram` is an integer number of MiB specifying the maximum RAM
this image may provisioned with. If `min_ram` is also specified, then
`min_ram <= max_ram` must be true.

## Manifest: requirements.min_platform

Optional. `min_platform` defines the minimum required SmartOS platform on
which this image can be used (and hence in SDC on which it will be
provisioned). It is a mapping of major "SDC Version" to the SmartOS platform
timestamp. E.g.:

    "min_platform": {"6.5": "20120901T113025Z", "7.1": "20130308T102805Z"}

This says that the image can only be used on SDC 6.5 platforms later than or
equal to "20120901T113025Z" or SDC 7.1 platforms later than or equal to
"20130308T102805Z".

The SDC version and platform timestamp values correspond to the `sysinfo`
"SDC Version" and "Live Image" keys respectively, e.g.:

    $ sysinfo | json "SDC Version"
    7.0
    $ sysinfo | json "Live Image"
    20130309T172903Z

Note that SDC versions before 7.0 did not have a "SDC Version" key in
sysinfo. If necessary the following may be used to get the appropriate value:

    test -z "$(sysinfo | json "SDC Version")" \
        && echo "6.5" \
        || echo $(sysinfo | json "SDC Version")

If `min_platform` is set but does not contain a key for your SDC version,
then:

1. if SDC version is less than the lowest key, e.g. if "6.4" for the example
   above, then this image **may not** be used on this platform
2. if SDC version is greater than the lowest key, e.g. if "7.0" for the example
   above, then this image **may** be used on this platform. This rule could
   have gone either way, depending on circumstances, hence the decision to
   *allow* in the face of ambiguity.


## Manifest: requirements.max_platform

Optional. `max_platform` defines the maximum allowed SmartOS platform on
which this image can be used (and hence in SDC on which it will be
provisioned). It is a mapping of major "SDC Version" to the SmartOS platform
timestamp. E.g.:

    "max_platform": {"6.5": "20120901T113025Z", "7.1": "20130308T102805Z"}

This says that the image can only be used on SDC 6.5 platforms less than or
equal to "20120901T113025Z" or SDC 7.1 platforms less than or equal to
"20130308T102805Z".

The SDC version and platform timestamp values correspond to the `sysinfo`
"SDC Version" and "Live Image" keys respectively, e.g.:

    $ sysinfo | json "SDC Version"
    7.0
    $ sysinfo | json "Live Image"
    20130309T172903Z

Note that SDC versions before 7.0 did not have a "SDC Version" key in
sysinfo. If necessary the following may be used to get the appropriate value:

    test -z "$(sysinfo | json "SDC Version")" \
        && echo "6.5" \
        || echo $(sysinfo | json "SDC Version")

If `max_platform` is set but does not contain a key for your SDC version,
then:

1. if SDC version is greater than the highest key, e.g. if "7.2" for the example
   above, then this image **may not** be used on this platform
2. if SDC version is greater than the lowest key, e.g. if "7.0" for the example
   above, then this image **may** be used on this platform. This rule could
   have gone either way, depending on circumstances, hence the decision to
   *allow* in the face of ambiguity.


## Manifest: users

Optional. `users` is a list of users for which passwords should be generated
for provisioning. This may only make sense for some datasets. Example:

    "users": [{"name": "root"}, {"name": "admin"}]

## Manifest: billing_tags

Optional. A list of tags that can be used by operators for additional billing
processing. This attribute can be useful for derivative images when the child
image object needs to be related to the parent image for billing or licensing
purposes. Example:

    "billing_tags": ["oracle", "rhel"]

## Manifest: traits

Optional. An object that defines a collection of properties that is used by
other APIs to evaluate where should customer VMs be placed. The keys allowed in
this object are application specific, but only strings, booleans or arrays of
strings are allowed for their values. Example:

    "traits": {
        "users": ["ef5d70c0-5281-154a-9f05-fad0ff43181e],
        "hw": ["richmond-a"],
        "over-provision-ram": "2.5"
    }

## Manifest: tags

Optional. An object of key/value pairs that allows clients to categorize images
by any given criteria. The keys allowed in this object are application specific,
but only strings, numbers or booleans are allowed for their values.
Example:

    "tags": {
      "role": "db",
      "license": "gpl"
    }

## Manifest: generate_passwords

Optional. `generate_passwords` is a boolean indicating whether to generate
passwords for the users in the "users" field. If not present, the default
value is true.

## Manifest: inherited_directories

Optional. `inherited_directories` is a list of inherited directories (other
than the defaults for the brand). This can be left out or the empty list if
the dataset need not inherit directories. This field only makes sense for
datasets of type "zone-dataset". Example:

    {
        ...
        "inherited_directories": ["/opt/support"],
        ...
    }


## Manifest: nic_driver

The NIC driver used by this VM image. Examples are 'virtio', 'ne2k_pci',
'rtl8139', 'e1000', 'pcnet'.
This is a required field for `type === "zvol"` images.


## Manifest: disk_driver

The disk driver used by this VM image. Examples are 'virtio', 'ide', 'scsi'.
This is a required field for `type === "zvol"` images.


## Manifest: cpu_type

The QEMU CPU model to use for this VM. Examples are: "qemu64", "host".
This is a required field for `type === "zvol"` images.


## Manifest: image_size

The size (in MiB) of the VM's disk, and hence the required size of allocated
disk for provisioning.
This is a required field for `type === "zvol"` images.



<!-- #ifdef PRIVATE -->
# Use Cases

Here we look at some SDC use cases that touch on IMGAPI, and hence drive
its design.


## Use Case 1: Bootstrap SDC core zones' images on headnode setup

**Status**: complete.

[headnode.sh](https://mo.joyent.com/usb-headnode/blob/master/scripts/headnode.sh)
(see "/var/svc/log/system-smartdc-init:default.log") calls this:

    /opt/smartdc/bin/sdc-imgadm import -m $manifest -f $file

for all images used to provision SDC core zones.


## Use Case 2: Operator adds new images.joyent.com image to the DC

**Status**: complete (TODO: does adminui support this yet?)

This can be done on the command-line via the following in the headnode GZ:

    cd /var/tmp
    joyent-imgadm list  # find the wanted image UUID
    joyent-imgadm get $uuid > manifest
    joyent-imgadm get-file -O $uuid     # creates $uuid-file.$ext
    sdc-imgadm import -m manifest -f $uuid-file*

Note: With IMGAPI-80, this will eventually become a one-liner.


## Use Case 3: Operator adds a new image just for this cloud

**Status**: Incomplete. Currently the image must be manually added to each DC
as described below (the equivalent of SDC 6.5). Eventually, when IMGAPI has
MigrateImage (and when adminui supports using it), this will be easier.

How to add an image to a DC via the command-line:

1. `scp` the image manifest and file to the headnode GZ.
2. ssh to the headnode GZ and run:

        sdc-imgadm import -m MANIFEST -f FILE



## Use Case 4: User provisions with an image

**Status**: Complete.

This is via a normal
[cloudapi#CreateMachine](https://mo.joyent.com/docs/cloudapi/master/#CreateMachine)
call. CloudAPI could use [GetImage](#GetImage) on behalf of the calling user
to valid access to the `image_uuid`. VMAPI validates the `image_uuid`.
The provisioner agent uses the local `imgadm` to lazily install the image
if necessary (imgadm is configured to talk to the DC's local IMGAPI).


## Use Case 5: User creates a custom image

**Status**: Incomplete. Current work is in IMGAPI-95 and related tickets.

An example using raw cloudapi (using the `sdc-cloudapi` tool in the 'sdc' zone
that allows the *admin* user to talk to CloudAPI). This example is run in COAL,
hence the packages, etc. are not practical JPC examples:

1. Some COAL-only setup. (Note: This, or the equivalent, is all automatically
   setup in staging.)

    Provision a cloudapi:

        cat <<EOM | sapiadm provision
        {
            "service_uuid": "$(sdc-sapi /services?name=cloudapi | json -H 0.uuid)",
            "params": {
                "alias": "cloudapi0",
                "networks": [
                    {
                        "uuid": "$(sdc-napi /networks?name=admin | json -H 0.uuid)"
                    },
                    {
                        "uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)",
                        "primary": true
                    }
                ]
            }
        }
        EOM

    Turn on image management bleeding edge features in cloudapi for the 'admin'
    user:

        echo '{
            "metadata": {
                "CLOUDAPI_BLEEDING_EDGE_FEATURES": ["img_mgmt"],
                "CLOUDAPI_BLEEDING_EDGE_LOGIN_WHITELIST": ["admin"]
            }
        }' | sapiadm update $(sdc-sapi /services?name=cloudapi | json -H 0.uuid)

    Ensure that DAPI will allow using the headnode for provisioning:

        sdc-login dapi

        cd /opt/smartdc/dapi/sapi_manifests/dapi
        json -f template -e '
          this.allocationDescription = this.allocationDescription.filter(
            function (e) {
              return !~[
                "hard-filter-min-ram",
                "hard-filter-min-disk",
                "hard-filter-min-cpu",
                "hard-filter-headnode"
              ].indexOf(e);
            })
          ' > template.new
        mv template.new template
        svcadm restart config-agent

        exit

    Need an external nic for the 'imgapi', 'sdc' and 'workflow' zones:

        sdc-vmapi /vms/$(vmadm lookup -1 alias=imgapi0)?action=add_nics -X POST -d@- <<EOP | sdc sdc-waitforjob
        {
            "networks": [{"uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)"}]
        }
        EOP
        sdc-vmapi /vms/$(vmadm lookup -1 alias=sdc0)?action=add_nics -X POST -d@- <<EOP | sdc sdc-waitforjob
        {
            "networks": [{"uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)"}]
        }
        EOP
        sdc-vmapi /vms/$(vmadm lookup -1 alias=workflow0)?action=add_nics -X POST -d@- <<EOP | sdc sdc-waitforjob
        {
            "networks": [{"uuid": "$(sdc-napi /networks?name=external | json -H 0.uuid)"}]
        }
        EOP
        sleep 20  # workflow takes a while to come back

    Get the base 13.1.0 image to work with:

        sdc-imgadm import f669428c-a939-11e2-a485-b790efc0f0c1 -S https://images.joyent.com --skip-owner-check

    Now get into the sdc zone where `sdc-cloudapi` is setup for the admin user:

        [root@headnode (coal) ~]# sdc
        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]#

2.  Pick a package via ListPackages. Basically anyone should do.

        package_id=$(sdc-cloudapi /my/packages | json -H -c 'this.name=="sdc_256"' 0.id)

    E.g.:

        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]# sdc-cloudapi /my/packages | json -H -c 'this.name=="sdc_256"'
        [
          {
            "name": "sdc_256",
            "memory": 256,
            "disk": 25600,
            "swap": 512,
            "vcpus": 1,
            "default": "false",
            "id": "78aa629d-04fc-4ee5-881b-0b4a914e0c52",
            "version": "1.0.0"
          }
        ]

3.  Pick a network:

        network_id=$(sdc-cloudapi /my/networks | json -H 0.id)

    E.g.:

        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]# sdc-cloudapi /my/networks | json -H 0
        {
          "id": "c1dc3561-86ad-4a14-a3e4-3db849f6e0d4",
          "name": "external",
          "public": true
        }

4.  Create the proto machine [CreateMachine](https://mo.joyent.com/docs/cloudapi/master/#CreateMachine):

        cat <<EOM | sdc-cloudapi /my/machines -X POST -d@-
        {
            "name": "proto1",
            "package": "$package_id",
            "image": "f669428c-a939-11e2-a485-b790efc0f0c1",
            "networks": ["$network_id"]
        }
        EOM

    E.g.:

        HTTP/1.1 201 Created
        Location: /admin/machines/076a52ff-e18e-4168-b62e-a06dd2af699b
        Content-Type: application/json
        Content-Length: 1579
        ...
        Api-Version: 7.0.0

        {
          "id": "076a52ff-e18e-4168-b62e-a06dd2af699b",
          "name": "proto1",
          "type": "smartmachine",
          "state": "provisioning",
          "image": "f669428c-a939-11e2-a485-b790efc0f0c1",
          "ips": [],
          "memory": 256,
          "disk": 25600,
          "metadata": {
            "root_authorized_keys": "..."
          },
          "tags": {},
          "created": "2013-07-30T23:12:57.197Z",
          "updated": "2013-07-30T23:12:57.197Z",
          "dataset": "sdc:sdc:base:13.1.0",
          "firewall_enabled": false,
          "package": "sdc_256"
        }

    So:

        machine_id=076a52ff-e18e-4168-b62e-a06dd2af699b

    Wait until it is running:

        while [[ $(sdc-cloudapi /my/machines/$machine_id | json -H state) == "provisioning" ]]; do
          sleep 2
        done

    ... and get its IP:

        $ sdc-cloudapi /my/machines/$machine_id | json -Hj id name state ips
        {
          "id": "076a52ff-e18e-4168-b62e-a06dd2af699b",
          "name": "proto1",
          "state": "running",
          "ips": [
            "10.88.88.7"
          ]
        }

5.  SSH in, make a change and prepare the instance:

        [root@076a52ff-e18e-4168-b62e-a06dd2af699b (coal:sdc0) ~]# ssh -i ~/.ssh/sdc.id_rsa 10.88.88.7
        Last login: Thu Jul 11 04:29:02 2013 from 10.88.88.5
           __        .                   .
         _|  |_      | .-. .  . .-. :--. |-
        |_    _|     ;|   ||  |(.-' |  | |
          |__|   `--'  `-' `;-| `-' '  ' `-'
                           /  ; SmartMachine (base 13.1.0)
                           `-'  http://wiki.joyent.com/jpc2/SmartMachine+Base
        [root@076a52ff-e18e-4168-b62e-a06dd2af699b ~]# echo 'Trent was here' > /etc/motd
        [root@076a52ff-e18e-4168-b62e-a06dd2af699b ~]# sm-prepare-image -y
        ...

    This will stop the instance.

6.  Create the custom image:

        cat <<EOM | sdc-cloudapi /my/images -X POST -d@-
        {
          "machine": "076a52ff-e18e-4168-b62e-a06dd2af699b",
          "name": "foo",
          "version": "1.0.0",
          "description": "my first image"
        }
        EOM

    Cloudapi's response gives you the new image UUID:

        {
          "id": "cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd",
          "name": "foo",
          "type": "smartmachine",
          "requirements": {},
          "version": "1.0.0",
          "description": "my first image"
        }

    So:

        image_id=cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd

    but without a "published_at". Wait (for up to 2 minutes) for it to be created
    and published to the local IMGAPI:

        for i in {40..1}; do
            sleep 3
            if [[ -n "$(sdc-cloudapi /my/images/$image_id | json published_at)" ]]; then
                break
            fi
        done

    Once it is published:

        $ sdc-cloudapi /my/images/$image_id
        [
          {
            "id": "cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd",
            "name": "foo",
            "os": "smartos",
            "type": "smartmachine",
            "requirements": {},
            "version": "1.0.0",
            "description": "my first image",
            "published_at": "2013-07-11T04:40:10.364Z"
          }
        ]

    If that returns an error (404), then the creation failed. Currently there
    is no mechanism to report a specific creation error. There is a plan
    in M1 of the roadmap to fix that.

    The created image will have inherited relevant fields, e.g. billing_tags,
    from the source image (in this case 'base 13.1.0').

7.  Provision a new machine with this custom image.

        cat <<EOM | sdc-cloudapi /my/machines -X POST -d@-
        {
            "name": "foo0",
            "package": "$package_id",
            "image": "$image_id",
            "networks": ["$network_id"]
        }
        EOM

    Get its IP:

        $ sdc-cloudapi /my/machines/c4412958-0d6b-46c1-8b98-e4b52361e62c | json -Hj id name state ips
        {
          "id": "c4412958-0d6b-46c1-8b98-e4b52361e62c",
          "name": "foo0",
          "state": "running",
          "ips": [
            "10.88.88.8"
          ]
        }

    SSH in to see if it worked:

        [root@5edec2f5-2301-48cb-9306-e41237a2fbde (coal:sdc0) ~]# ssh -i ~/.ssh/sdc.id_rsa 10.88.88.8
        The authenticity of host '10.88.88.8 (10.88.88.8)' can't be established.
        RSA key fingerprint is 5c:6c:9e:50:95:36:5c:1c:17:8f:53:77:84:ee:81:e9.
        Are you sure you want to continue connecting (yes/no)? yes
        Warning: Permanently added '10.88.88.8' (RSA) to the list of known hosts.
        Last login: Thu Jul 11 04:49:11 2013 from 10.88.88.5
        Trent was here
        [root@c4412958-0d6b-46c1-8b98-e4b52361e62c ~]#

It worked!


### Thoughts

Obviously that process (do this; wait for this to be done) is a bit onerous
on the user. It is scriptable so the node-smartdc tooling should facilitate
that waiting.

We will be exposing more fields in "GET /my/images/:uuid", e.g. "public". For
comparison, here is the full internal data on the image:

        $ sdc-imgadm get cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd
        {
          "v": "2",
          "uuid": "cf3ef5fb-9a53-4c33-9c81-3ebab13a09fd",
          "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
          "name": "foo",
          "version": "1.0.0",
          "state": "active",
          "disabled": false,
          "public": false,
          "published_at": "2013-07-11T04:40:10.364Z",
          "type": "zone-dataset",
          "os": "smartos",
          "files": [
            {
              "sha1": "3b52cd61463ee1b0c6551a3789b9db7e591fa410",
              "size": 381619144,
              "compression": "none"
            }
          ],
          "description": "my first image",
          "requirements": {
            "networks": [
              {
                "name": "net0",
                "description": "public"
              }
            ]
          }
        }

TODO: Redo this example using the node-smartdc CLI.


## Use Case 6: User modifies an image they own

**Status**: Incomplete. UpdateImage is implemented to support this, but
remaining work include custom image creation (Use Case 5) and exposing
UpdateImage via cloudapi (TODO: ticket for this).


## Use Case 7: User easily gets custom image from an Ubuntu ISO

**Status**: Incomplete. This is not an SDC 7.0 requirement and will not
be implemented for SDC 7.0.

Mark:

    i would like it to be that i _start_ in JPC with imgadm as ISO images
    i.e., i say "here's the ubuntu ISO image" i want to boot off of.
    i then do whatever the fuck i want to my VM
    i take a snapshot. and right there, that's now a new image available to me and anyone i share with (later)

Q: how do I create an image from an ISO. Say a slackware, debian or whatever ISO?

<!-- #endif -->


<!-- #ifdef PRIVATE -->
# Image file storage

There are three possible storage mechanisms for the (large) image files.
Which are in use depend on the IMGAPI configuration (and availability
in the DC).

1. manta: Requires an available Manta for this DC's region. All files are
   store in the "imgapi" user's Manta area.
2. dcls: Data Center Local Storage.
   TODO: details from wdp how this would be used.
3. local: A local dir (or locally mounted dir). Only useful for testing and
   development. This is insufficient for production usage because a locally
   mounted dir can't handle HA (imgapi zones on more than one server).

The set of available storages is set in the configuration. E.g.:

    "storage": {
        "manta": {
            "url": "https://manta.bh1-kvm1.joyent.us",   // or something
            "user": "imgapi",
            "password": "***"
        },
        "dcls": {
            "dir": "/mnt/share/imgapi"
        },
        "local": {
            "dir": "/var/db/imgapi"
        }
    }

A production setup needs at least one of "manta" or "dcls" storage, where
"production" is defined as running without the `IMGAPI_DEVELOPMENT` envvar
defined (with a non-empty string value). Likewise, usage of "local" is only
allowed if `IMGAPI_DEVELOPMENT` is set.

When adding an image file the storage used is determined as follows:

- if "manta" is available, use that
- else if "dcls" is available, use that
- else if "local" is available, use that


Open questions (TODO):

- Do we need more control than the above storage determination?
- Should 'dcls' usage be limited to a set of users? Or have a config item
  to limit the set of users that can use it. If so, then need an endpoint
  to update that config.
<!-- #endif -->


# Image API

An "image" object is the metadata for an image file, also called the manifest.
See [Image manifest data](#image-manifest-data) above for a summary of all
fields.


## ListImages (GET /images)

List images. Without query params this returns all active
(`state === "active"`) images.

There are two typical calling styles to this endpoint: with 'account=$UUID' and
without. The former is what cloudapi uses to ask on behalf of a particular
authenticated account. The latter is for operator-only querying.

### Inputs

||**Field**||**Type**||**Description**||
||account||UUID||Only list images visible to this account. A user can only see: (a) active public images, (b) active private images for which they are listed in the ACL, and (c) their own images.||
||owner||UUID||Only list images owned by this account.||
||state||String||List images with the given state. Can be one of 'active' (the default), 'disabled', 'unactivated' or 'all'.||
||name||String||List images with the given name. Prefix with `~` to do a substring match (case-*sensitive*). E.g., `~foo`.||
||version||String||List images with the given version. Prefix with `~` to do a substring match (case-*sensitive*). E.g., `~foo`.||
||public||Boolean||List just public or just private images.||
||os||String||List images with the given os.||
||type||String||List images of the given type.||
||tag.{key}||String||List images by tags. See below||
||billing_tag||String||List images by billing tags. See below||

Images can be searched by tags. If an Image is tagged as 'cloud=private', then
the filter to be added to the request params should be 'tag.cloud=private' and
the full path for the query would look like "/images?tag.cloud=private". More
than one tag can be specified for the same search. Multiple tags are interpreted
as a logical AND, meaning that each of the Images returned is tagged with each of
the values provided.

In contrast, billing tags are not key/value objects but a single array of values.
This means that a query filter for billing_tags is constructed in a conventional
way. As an example, the following queries show the usage of tags and billing_tags
when filtering images.

    One matching tag
      GET /images?tag.cloud=private

    Multiple matching tags
      GET /images?tag.cloud=private&tag.dc=east

    One matching billing tag
      GET /images?billing_tag=promo

    Multiple matching billing tags
      GET /images?biling_tag=promo&billing_tag=smallinstance


### Returns

An array of image objects.

### Errors

See [Errors](#errors) section above.

### Example

Raw curl (from images.joyent.com):

    $ curl -kisS https://images.joyent.com/images | json
    HTTP/1.1 200 OK
    Date: Tue, 08 Jan 2013 01:07:25 GMT
    Content-Type: application/json
    Connection: keep-alive
    Content-Length: 60203
    Server: IMGAPI/1.0.0
    x-request-id: c3993970-592f-11e2-8ef6-f7e53a279942
    x-response-time: 44
    x-server-name: b908c5b2-ccd9-4f43-b5ff-2997eb6bd682.local

    [
      {
        "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
        "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
        "name": "smartos",
        "version": "1.6.3",
        "state": "active",
        "disabled": false,
        "public": true,
        "published_at": "2012-05-02T15:14:45.805Z",
        "type": "zone-dataset",
        "os": "smartos",
        "files": [
          {
            "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
            "size": 46271847,
            "compression": "bzip2"
          }
        ],
        "description": "Base template to build other templates on",
    ...

CLI tool (from images.joyent.com):

    $ joyent-imgadm list
    UUID                                  NAME           VERSION  OS       STATE   PUBLISHED
    febaa412-6417-11e0-bc56-535d219f2590  smartos        1.3.12   smartos  active  2011-04-11
    7456f2b0-67ac-11e0-b5ec-832e6cf079d5  nodejs         1.1.3    smartos  active  2011-04-15
    ...

    $ joyent-imgadm list name=~base   # filter on substring in name
    UUID                                  NAME    VERSION  OS       STATE   PUBLISHED
    8418dccc-c9c6-11e1-91f4-5fb387d839c5  base    1.7.0    smartos  active  2012-07-09
    d0eebb8e-c9cb-11e1-8762-2f01c4acd80d  base64  1.7.0    smartos  active  2012-07-10
    ...

In an SDC headnode GZ to talk to that data center's IMGAPI:

    $ sdc-imgapi /images
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 515
    Date: Tue, 08 Jan 2013 01:08:19 GMT
    Server: IMGAPI/1.0.0
    x-request-id: e3b681e0-592f-11e2-b638-4b6ffa4ca56f
    x-response-time: 1
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    [
      {
        "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
        "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
        "name": "smartos",
        "version": "1.6.3",
    ...

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm list state=all
    UUID                                  NAME     VERSION  OS       STATE        PUBLISHED
    e70502b0-705e-498e-a810-53a03980eabf  foo      1.0.0    smartos  unactivated  -
    01b2c898-945f-11e1-a523-af1afbe22822  smartos  1.6.3    smartos  active       2012-05-02
    ...


## GetImage (GET /images/:uuid)

Get a image by uuid.

There are two typical calling styles to this endpoint: with 'account=$UUID' and
without. The former is what cloudapi uses to ask on behalf of a particular
authenticated account. The latter is for operator-only querying.

### Inputs

||**Field**||**Type**||**Description**||
||account||UUID||Only return an image visible to this account. A user can only see: (a) active public images, (b) active private images for which they are on the ACL, and (c) their own images.||

### Returns

An image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw curl (from images.joyent.com):

    $ curl -sS https://images.joyent.com/images/01b2c898-945f-11e1-a523-af1afbe22822
    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
    ...

CLI tool (from images.joyent.com):

    $ joyent-imgadm get 01b2c898-945f-11e1-a523-af1afbe22822
    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
    ...

Raw API tool (from an SDC's IMGAPI):

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 513
    Date: Tue, 08 Jan 2013 01:10:06 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 2383aaf0-5930-11e2-b638-4b6ffa4ca56f
    x-response-time: 71
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
      "owner": "352971aa-31ba-496c-9ade-a379feaecd52",
      "name": "smartos",
      "version": "1.6.3",
      "state": "active",
      "disabled": false,
      "public": true,
      "published_at": "2012-05-02T15:14:45.805Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "97f20b32c2016782257176fb58a35e5044f05840",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "description": "Base template to build other templates on",
      "urn": "sdc:sdc:smartos:1.6.3",
      "requirements": {
        "networks": [
          {
            "name": "net0",
            "description": "public"
          }
        ]
      }
    }

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm get 01b2c898-945f-11e1-a523-af1afbe22822
    {
      "uuid": "01b2c898-945f-11e1-a523-af1afbe22822",
    ...



## GetImageFile (GET /images/:uuid/file)

Get the image file.

### Inputs

None.

### Returns

The (typically large) image file content.

### Errors

See [Errors](#errors) section above.

### Example

Raw curl (from images.joyent.com):

    $ curl -kIsS https://images.joyent.com/images/01b2c898-945f-11e1-a523-af1afbe22822/file -o file.bz2

CLI tool (from images.joyent.com):

    $ joyent-imgadm get-file 01b2c898-945f-11e1-a523-af1afbe22822 -O
    100% [=============================]  time 43.4s  eta 0.0s
    Saved "01b2c898-945f-11e1-a523-af1afbe22822.bz2".

Raw API tool (from an SDC's IMGAPI):

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822/file -o file.bz2

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm get-file 01b2c898-945f-11e1-a523-af1afbe22822 -O
    100% [=============================]  time 43.4s  eta 0.0s
    Saved "01b2c898-945f-11e1-a523-af1afbe22822.bz2".


## GetImageIcon (GET /images/:uuid/icon)

Get the image icon file.

### Inputs

None.

### Returns

The image icon file content.

### Errors

See [Errors](#errors) section above.

### Example

Raw curl:

    $ curl -kIsS https://localhost/images/01b2c898-945f-11e1-a523-af1afbe22822/icon -o icon.png

CLI tool:

    $ joyent-imgadm get-icon 01b2c898-945f-11e1-a523-af1afbe22822 -O
    100% [=============================]  time 0.4s  eta 0.0s
    Saved "01b2c898-945f-11e1-a523-af1afbe22822.png".

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822/icon -o icon.png


## DeleteImageIcon (DELETE /images/:uuid/icon)

Delete the image icon file.

### Inputs

None.

### Returns

The image icon file content.

### Errors

See [Errors](#errors) section above.

### Example

CLI tool:

    $ joyent-imgadm delete-icon 01b2c898-945f-11e1-a523-af1afbe22822
    Delete icon from image 01b2c898-945f-11e1-a523-af1afbe22822

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822/icon -X DELETE


## DeleteImage (DELETE /images/:uuid)

Delete this image (and its file, if any).

### Inputs

None.

### Returns

Responds with HTTP 204 (No Content).

### Errors

See [Errors](#errors) section above.

### Example

CLI tool (from images.joyent.com):

    $ joyent-imgadm delete 69d8bd69-db68-a54c-bec5-8c934822cfa9
    Deleted image 69d8bd69-db68-a54c-bec5-8c934822cfa9

Raw API tool (from an SDC's IMGAPI):

    $ sdc-imgapi /images/f9bbbc9f-d281-be42-9651-72c6be875874/file -X DELETE

CLI tool (from an SDC's IMGAPI):

    $ sdc-imgadm delete 7a1b1967-6ecf-1e4c-8f09-f49094cc36ad
    Deleted image 7a1b1967-6ecf-1e4c-8f09-f49094cc36ad



## CreateImage (POST /images)

Create a new (unactivated) image from a manifest. The typical process is to
subsequently call [AddImageFile](#AddImageFile) and then
[ActivateImage](#ActivateImage) to finish with an image available for
provisioning.

### Inputs

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||account||UUID||Yes\*||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
||[owner](#manifest-owner)||UUID||Yes\*||-||The UUID of the owner of this image (the account that created it). If not given, the given `account` is used. At least one of `account` or `owner` is required.||
||[name](#manifest-name)||String||Yes||-||A short name (and optionally version) for this image. Max 512 characters. No uniqueness guantee.||
||[version](#manifest-version)||String||Yes||-||A version string for this image. Max 128 characters. No uniqueness guarantee.||
||[description](#manifest-description)||String||No||-||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||-||Homepage URL where users can find more information about the image.||
||[eula](#manifest-eula)||URL||No||-||URL of the End User License Agreement (EULA) for the image.||
||[disabled](#manifest-disabled)||Boolean||No||false||Indicates if this image should be available for provisioning.||
||[public](#manifest-public)||Boolean||No||false||Indicates if this image is publicly available.||
||[type](#manifest-type)||String||Yes||-||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, or "zvol" for a virtual machine image.||
||[os](#manifest-os)||String||Yes||-||The OS family this image provides. One of "smartos", "windows", and "linux".||
||[origin](#manifest-origin)||UUID||No||-||The origin image UUID if this is an incremental image.||
||[acl](#manifest-acl)||Array||No||-||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[requirements](#manifest-requirements)||Object||No||-||A set of named requirements for provisioning a VM with this image. See [the requirements docs](#manifest-requirements) above for supported fields.||
||[users](#manifest-users)||Array||No||-||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||No||-||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||No||-||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[tags](#manifest-tags)||Object||No||-||An object of key/value pairs that allows clients to categorize images by any given criteria.||
||[generate_passwords](#manifest-generate-passwords)||Boolean||No||-||A boolean indicating whether to generate passwords for the users in the "users" field. If not present, the default value is true.||
||[inherited_directories](#manifest-inherited-directories)||Array||No||-||A list of inherited directories (other than the defaults for the brand).||
||[nic_driver](#manifest-nic-driver)||String||Yes (if `type==="zvol"`)||-||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||Yes (if `type==="zvol"`)||-||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||Yes (if `type==="zvol"`)||-||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||Yes (if `type==="zvol"`)||-||The size (in MiB) of this VM image's disk.||


### Returns

The (unactivated) image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This creates a new unactivated
image:

    $ sdc-imgapi /images -X POST \
        --data-binary '{
            "name": "foo",
            "version": "1.0.0",
            "type": "zone-dataset",
            "os": "smartos",
            "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81"
        }'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 236
    Date: Tue, 08 Jan 2013 20:04:01 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 8b547800-59ce-11e2-b638-4b6ffa4ca56f
    x-response-time: 52
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81",
      "name": "foo",
      "version": "1.0.0",
      "state": "unactivated",
      "disabled": false,
      "public": false,
      "type": "zone-dataset",
      "os": "smartos",
      "files": [],
      "acl": []
    }

CLI tool (against an SDC's IMGAPI):

    $ echo '{
        "name": "foo",
        "version": "1.0.0",
        "type": "zone-dataset",
        "os": "smartos",
        "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81"
    }' | sdc-imgadm create
    Imported image 25ab9ddf-96e8-4157-899d-1dc8be7b9810 (foo, 1.0.0, state=unactivated)


<!-- #ifdef PRIVATE -->

## CreateImageFromVm (POST /images?action=create-from-vm)

Create a new (activated) image from an existing VM. The VM from which the Image
will be created must be stopped. This endpoint has a subset of allowed inputs
compared to [CreateVm](#CreateVm), as many of the Image manifest fields are
going to be directly computed from the source VM.

CreateFromVM takes the following two additional parameters in the URL query string:

### Query String Inputs

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||account||UUID||Yes||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
||vm_uuid||UUID||Yes||-||The UUID of the source VM.||
||incremental||Boolean||No||false||Whether to create an incremental image.||

### Manifest Inputs

The following is the list of inputs that can be specified for a new Image created
from an existing VM:

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||[uuid](#manifest-uuid)||UUID||No||-||UUID of the new Image. A new one will be generated if not specified||
||[owner](#manifest-owner)||UUID||Yes\*||-||The UUID of the owner of this image (the account that created it). If not given, the given `account` is used. At least one of `account` or `owner` is required.||
||[name](#manifest-name)||String||Yes||-||A short name (and optionally version) for this image. Max 512 characters. No uniqueness guantee.||
||[version](#manifest-version)||String||Yes||-||A version string for this image. Max 128 characters. No uniqueness guarantee.||
||[description](#manifest-description)||String||No||-||A short description of the image.||
||[homepage](#manifest-homepage)||URL||No||-||Homepage URL where users can find more information about the image.||
||[disabled](#manifest-disabled)||Boolean||No||false||Indicates if this image should be available for provisioning.||
||[public](#manifest-public)||Boolean||No||false||Indicates if this image is publicly available.||
||[acl](#manifest-acl)||Array||No||-||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[tags](#manifest-tags)||Object||No||-||An object of key/value pairs that allows clients to categorize images by any given criteria.||


### Inherited Fields

The following is the list of fields that the new Image will inherit from the source
Image of the VM in question and therefore cannot be specified:

||**Field**||**Type**||**Notes**||
||[type](#manifest-type)||String||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, or "zvol" for a virtual machine image.||
||[os](#manifest-os)||String||The OS family this image provides. One of "smartos", "windows", and "linux".||
||[requirements](#manifest-requirements)||Object||A set of named requirements for provisioning a VM with this image. See [the requirements docs](#manifest-requirements) above for supported fields.||
||[users](#manifest-users)||Array||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[generate_passwords](#manifest-generate-passwords)||Boolean||A boolean indicating whether to generate passwords for the users in the "users" field. If not present, the default value is true.||
||[inherited_directories](#manifest-inherited-directories)||Array||A list of inherited directories (other than the defaults for the brand).||
||[nic_driver](#manifest-nic-driver)||String||NIC driver used by this VM image.||
||[disk_driver](#manifest-disk-driver)||String||Disk driver used by this VM image.||
||[cpu_type](#manifest-cpu-type)||String||The QEMU CPU model to use for this VM image.||
||[image_size](#manifest-image-size)||Number||The size (in MiB) of this VM image's disk.||


### Returns

A Job object. The location of the workflow API where the status of the job can
be polled is available in the workflow-api header of the response.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This queues the creation of a new Image
from an existing VM:

    $ sdc-imgapi /images?action=create-from-vm&vm_uuid=56b107b9-9277-4a6a-bcd3-17c497041bee \
        -X POST \
        --data-binary '{
            "name": "foo",
            "version": "1.0.0",
            "uuid": "4e88c673-f3ab-4a55-9f5d-b54379cf2d8a",
            "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81"
        }'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 236
    Date: Tue, 08 Jan 2013 20:04:01 GMT
    Server: IMGAPI/1.0.0
    workflow-api: http://workflow.coal.joyent.us
    x-request-id: 8b547800-59ce-11e2-b638-4b6ffa4ca56f
    x-response-time: 52
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "image_uuid": "4e88c673-f3ab-4a55-9f5d-b54379cf2d8a",
      "job_uuid": "4c831bba-68ed-4fe8-a54b-a5b5acefd7ac"
    }

<!-- #endif -->

## AddImageFile (PUT /images/:uuid/file)

Add the image file. If the image already has a file, it will be overwritten.
A file can only be added to an image that has not yet been activated. The
typical process is to call this after [CreateImage](#CreateImage), and then
subsequently call [ActivateImage](#ActivateImage) to make the image available
for provisioning, `state == "active"`.

### Inputs

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||account||UUID||No||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
<!-- #ifdef PRIVATE -->
||storage||String||No||-||The type of storage preferred for this image file. Storage can only be specified if the request is being made by an operator. The only two possible values for storage are **local** and **manta**. When the request is made on behalf of a customer then IMGAPI will try to use manta as the storage backend, otherwise default to local storage.||
<!-- #else -->
||storage||String||No||-||The type of storage preferred for this image file. Admin-only.||
<!-- #endif -->
||[compression](#manifest-files)||UUID||Yes||-||The type of compression used for the file content. One of 'none', 'gzip' or 'bzip2'.||
||[sha1](#manifest-files)||SHA-1 Hash||No||-||SHA-1 of the uploaded file to allow the server to check for data corruption.||
||(file content in the body)||binary||Yes||-||The image file content.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This example is using curl's
`-T/--upload-file <file>` option, which results in a PUT.

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/file?compression=bzip2 \
        -T image.bz2
    HTTP/1.1 100 Continue

    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 319
    Date: Tue, 08 Jan 2013 20:17:46 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 773c5b10-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 106
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81",
      "name": "foo",
      "version": "1.0.0",
      "state": "unactivated",
      "disabled": false,
      "public": false,
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm add-file 25ab9ddf-96e8-4157-899d-1dc8be7b9810 -f file.bz2
    100% [=============================]  time 5.6s  eta 0.0s
    Added file "file.bz2" to image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## AddImageIcon (PUT /images/:uuid/icon)

Add the image icon. If the image already has an icon file, it will be overwritten.
Icons must have a maximum file size of 128Kb pixels and be in one of the following
formats: PNG, GIF or JPG.

### Inputs

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||account||UUID||No||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
||[sha1](#manifest-files)||SHA-1 Hash||No||-||SHA-1 of the uploaded icon file to allow the server to check for data corruption.||
<!-- #ifdef PRIVATE -->
||storage||String||No||-||The type of storage preferred for the image icon. Storage can only be specified if the request is being made by an operator. The only two possible values for storage are **local** and **manta**. When the request is made on behalf of a customer then IMGAPI will try to use manta as the storage backend, otherwise default to local storage.||
<!-- #else -->
||storage||String||No||-||The type of storage preferred for the image icon. Admin-only.||
<!-- #endif -->
||(file content in the body)||binary||Yes||-||The icon file content.||

### HTTP Request Headers

||**Header Name**||**Required?**||**Notes**||
||Content-Type||Yes||Content type of the icon file. One of 'image/jpeg', 'image/png' or 'image/gif'.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool (against an SDC's IMGAPI). This example is using curl's
`-T/--upload-file <file>` option, which results in a PUT.

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/icon \
        -H 'content-type: image/png'
        -T icon.png
    HTTP/1.1 100 Continue

    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 319
    Date: Tue, 08 Jan 2013 20:17:46 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 773c5b10-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 106
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "b5c5c13d-ccc0-5a43-9a46-245ff960cd81",
      "name": "foo",
      "version": "1.0.0",
      "state": "unactivated",
      "disabled": false,
      "public": false,
      "type": "zone-dataset",
      "os": "smartos",
      "icon": true,
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 46271847,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm add-icon 25ab9ddf-96e8-4157-899d-1dc8be7b9810 -f icon.png
    100% [=============================]  time 0.4s  eta 0.0s
    Added file "icon.png" to image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## ActivateImage (POST /images/:uuid?action=activate)

Activate the image. This makes the image available for provisioning -- the
`state` field will be "active". The image must already have had a file
uploaded via [AddImageFile](#AddImageFile). Once activated, an image cannot
be "deactivated". However it can be [*disabled*](#DisableImage) temporarily
or [*deleted*](#DeleteImage) permanently.

### Inputs

None.

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf?action=activate -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm activate 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Activated image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## DisableImage (POST /images/:uuid?action=disable)

Disables the image. This makes the image unavailable for provisioning -- the
`state` field will be "disabled".

### Inputs

None.

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf?action=disable -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "disabled",
      "disabled": true,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm disable 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Disabled image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## EnableImage (POST /images/:uuid?action=enable)

Enables the image. This makes the image available for provisioning once again --
the `state` field will be "active".

### Inputs

None.

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf?action=enable -X POST
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": []
    }

CLI tool:

    $ sdc-imgadm enable 25ab9ddf-96e8-4157-899d-1dc8be7b9810
    Enabled image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## AddImageAcl (POST /images/:uuid/acl?action=add)

Adds more UUIDs to the Image ACL. If any of the account UUIDs is already in the
image ACL it gets ignored. For convenience, when the action parameter is not present
it will default to action=add. This means that the **AddImageAcl** action is
valid in either of the two following forms:

    POST /images/:uuid/acl
    POST /images/:uuid/acl?action=add

### Inputs

||**Field**||**Type**||**Default**||**Notes**||
||account||UUID||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
||[acl](#manifest-acl)||Array||-||Access Control List. An array of account UUIDs to give access to a private image. The field is only relevant to private images.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/acl -X POST
        -d '[ "669a0e24-5e8a-11e2-8c11-7c6d6290281a" ]'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": [
        "669a0e24-5e8a-11e2-8c11-7c6d6290281a"
      ]
    }

CLI tool:

    $ sdc-imgadm add-acl 25ab9ddf-96e8-4157-899d-1dc8be7b9810 669a0e24-5e8a-11e2-8c11-7c6d6290281a
    Updated ACL for image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## RemoveImageAcl (POST /images/:uuid/acl?action=remove)

Removes UUIDs from the Image ACL. Any of the account UUIDs that is not in the
image ACL gets ignored. In contrast to [AddImageAcl](#AddImageAcl), RemoveImageAcl
requires the action parameter to be present and to be equal to 'remove'.

### Inputs

||**Field**||**Type**||**Default**||**Notes**||
||account||UUID||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
||[acl](#manifest-acl)||Array||-||Access Control List. An array of account UUIDs to remove access to a private image. The field is only relevant to private images.||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/e70502b0-705e-498e-a810-53a03980eabf/acl?action=remove -X POST
        -d '[ "669a0e24-5e8a-11e2-8c11-7c6d6290281a" ]'
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 356
    Date: Tue, 08 Jan 2013 20:21:17 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f5645880-59d0-11e2-b638-4b6ffa4ca56f
    x-response-time: 110
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "uuid": "e70502b0-705e-498e-a810-53a03980eabf",
      "owner": "930896af-bf8c-48d4-885c-6573a94b1853",
      "name": "foo",
      "version": "1.0.0",
      "state": "active",
      "disabled": false,
      "public": false,
      "published_at": "2013-01-08T20:21:17.932Z",
      "type": "zone-dataset",
      "os": "smartos",
      "files": [
        {
          "sha1": "cd0e0510c4a0799551687901077d7c4c06a4ebd8",
          "size": 42,
          "compression": "bzip2"
        }
      ],
      "acl": [
      ]
    }

CLI tool:

    $ sdc-imgadm remove-acl 25ab9ddf-96e8-4157-899d-1dc8be7b9810 669a0e24-5e8a-11e2-8c11-7c6d6290281a
    Updated ACL for image 25ab9ddf-96e8-4157-899d-1dc8be7b9810


## UpdateImage (POST /images/:uuid?action=update)

Update some fields in the image manifest. Not all fields can be updated. The
inputs section lists every image attribute that can be modified. Note that this
action is a complete replace of the attributes specified in the request and not
a partial update. Any input is optional but at least one attribute must be
updated.

**NOTE** Public images residing on a public mode server cannot be made private.

### Inputs

||**Field**||**Type**||**Default**||**Notes**||
||account||UUID||-||The account UUID on behalf of whom this request is being made. If given and if relevant, authorization will be done for this account. At least one of `account` or `owner` is required. It is expected that all calls originating from a user (e.g. from cloudapi) will provide this parameter.||
||[description](#manifest-description)||String||-||A short description of the image.||
||[homepage](#manifest-homepage)||URL||-||Homepage URL where users can find more information about the image.||
||[eula](#manifest-eula)||URL||-||URL of the End User License Agreement (EULA) for the image.||
||[public](#manifest-public)||Boolean||false||Indicates if this image is publicly available.||
||[type](#manifest-type)||String||-||The image type. One of "zone-dataset" for a ZFS dataset used to create a new SmartOS zone, or "zvol" for a virtual machine image.||
||[os](#manifest-os)||String||-||The OS family this image provides. One of "smartos", "windows", and "linux".||
||[acl](#manifest-acl)||Array||-||Access Control List. An array of account UUIDs given access to a private image. The field is only relevant to private images.||
||[requirements](#manifest-requirements)||Object||-||A set of named requirements for provisioning a VM with this image. See [the requirements docs](#manifest-requirements) above for supported fields.||
||[users](#manifest-users)||Array||-||A list of users for which passwords should be generated for provisioning. This may only make sense for some images. Example: `[{"name": "root"}, {"name": "admin"}]`||
||[billing_tags](#manifest-billing-tags)||Array||-||A list of tags that can be used by operators for additional billing processing.||
||[traits](#manifest-traits)||Object||-||An object that defines a collection of properties that is used by other APIs to evaluate where should customer VMs be placed.||
||[tags](#manifest-tags)||Object||-||An object of key/value pairs that allows clients to categorize images by any given criteria.||
||[inherited_directories](#manifest-inherited-directories)||Array||-||A list of inherited directories (other than the defaults for the brand).||
||[generate_passwords](#manifest-generate-passwords)||Boolean||-||A boolean indicating whether to generate passwords for the users in the "users" field.||
||[nic_driver](#manifest-nic-driver)||String||-||NIC driver used by this VM image. Required if `type==="zvol"`||
||[disk_driver](#manifest-disk-driver)||String||-||Disk driver used by this VM image. Required if `type==="zvol"`||
||[cpu_type](#manifest-cpu-type)||String||-||The QEMU CPU model to use for this VM image. Required if `type==="zvol"`||
||[image_size](#manifest-image-size)||Number||-||The size (in MiB) of this VM image's disk. Required if `type==="zvol"`||

### Returns

The updated image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/f9bbbc9f-d281-be42-9651-72c6be875874?action=update -X POST
        --data-binary '{
            "description": "updated description"
        }'

CLI tool:

    $ sdc-imgadm update f9bbbc9f-d281-be42-9651-72c6be875874 -f data.json
    $ sdc-imgadm update f9bbbc9f-d281-be42-9651-72c6be875874 description='new description'
    $ cat data.json | sdc-imgadm update f9bbbc9f-d281-be42-9651-72c6be875874


<!-- #ifdef PRIVATE -->
## AdminImportImage (POST /images/:uuid?action=import)

Import an image (preserving its `uuid` and `published_at` fields). This is
typically used for importing an image from <https://images.joyent.com>,
Joyent's central repository of vetted SmartOS images.

This may only be used by operators. This is enforced by requiring that
`account=UUID` is NOT provided. All usage of IMGAPI on behalf of end users
is required to use `account=UUID`; operator usage (e.g. from AdminUI) is
not.

This creates an unactivated image. The typical process is to subsequently
call [AddImageFile](#AddImageFile) and then [ActivateImage](#ActivateImage)
to finish with an image available for provisioning.

### Inputs

The request body includes the same fields as for [CreateImage](#CreateImage),
including the SDC6-era backward compat fields, with the following additions
and changes:

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||account||UUID||No\*||-||This must NOT be provided. See the discussion above.||
||uuid||UUID||Yes||-||The existing image UUID.||
||published_at||Date||No||-||The published date/time of the image.||

Query params:

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||action||String||Yes||-||"import"||
||skip_owner_check||Boolean||No||false||Pass in 'true' to skip the check that the image "owner" UUID exists in the user database (in SDC this database is UFDS). Note: The owner check is only done for `mode == "dc"` IMGAPI instances.||


### Returns

The (unactivated) image object.

### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822?action=import \
        -X POST --data-binary @smartos-1.6.3.dsmanifest
    ...

CLI tool. This example uses the '-f FILE' argument, which will handle
AddImageFile and ActivateImage calls after the AdminImportImage.

    $ sdc-imgadm import -m manifest -f file.bz2
    Imported image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699 (base, 1.8.4, state=unactivated)
    100% [=============================]  time 0.6s  eta 0.0s
    Added file "file.bz2" to image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699
    Activated image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699


## AdminImportRemoteImage (POST /images/:uuid?action=import-remote)

Import an image from another IMGAPI repository. This is typically used for
importing an image from <https://images.joyent.com>, but can be used for any
other valid Image repository. It is mainly a convenience method to allow IMGAPI
to execute the five import steps (get manifest, get file, import manifest,
add file, activate image) on the user's behalf.

This may only be used by operators. All usage of IMGAPI on behalf of end users
is required to use `account=UUID`; operator usage (e.g. from AdminUI) is
not.

This creates an active image ready for consumption.

### Inputs

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||uuid||UUID||Yes||-||The existing image UUID.||

Query params:

||**Field**||**Type**||**Required?**||**Default**||**Notes**||
||action||String||Yes||-||"import-remote"||
||source||URL||Yes||-||URL of the source IMGAPI repository||
||skip_owner_check||Boolean||No||false||Pass in 'true' to skip the check that the image "owner" UUID exists in the user database (in SDC this database is UFDS). Note: The owner check is only done for `mode == "dc"` IMGAPI instances.||


### Returns

A job response object with the following fields:

||**Field**||**Type**||**Notes**||
||image_uuid||UUID||UUID of the image being imported||
||job_uuid||UUID||The job UUID. In SDC use `sdc-workflow /jobs/$job_uuid` to inspect.||


### Errors

See [Errors](#errors) section above.

### Example

Raw API tool:

    $ sdc-imgapi /images/01b2c898-945f-11e1-a523-af1afbe22822?action=import-remote&source=https://images.joyent.com
    HTTP/1.1 200 OK
    workflow-api: http://workflow.coal.joyent.us
    content-type: application/json
    content-length: 112
    date: Thu, 25 Jul 2013 05:23:23 GMT
    server: IMGAPI/1.0.3
    x-request-id: 4e71ed70-f4ea-11e2-b255-75716000a01d
    x-response-time: 8307
    x-server-name: ba928081-1e9f-49dc-8900-0239956fda7b

    {
      "image_uuid": "a93fda38-80aa-11e1-b8c1-8b1f33cd9007",
      "job_uuid": "b45be0ae-778a-474e-8e41-9793f09ffde1"
    }

CLI tool:

    $ sdc-imgadm import 84cb7edc-3f22-11e2-8a2a-3f2a7b148699 -S https://images.joyent.com
    Imported image 84cb7edc-3f22-11e2-8a2a-3f2a7b148699 (base, 1.8.4, state=active)
<!-- #endif -->



# Miscellaneous API

<!-- #ifdef PRIVATE -->
## Ping (GET /ping)

A simple ping to check to health of the IMGAPI server. Here "pid" is the PID
of the IMGAPI server process. This is helpful for the test suite.

### Inputs

||**Field**||**Type**||**Description**||
||error||String||Optional. An error code name, e.g. "ResourceNotFound" to simulate an error response.||
||message||String||Optional. The error message to include in the simulated error response. Defaults to "pong".||

### Returns

When not simulating an error response, a "pong" object is returned:

||**Field**||**Type**||**Description**||
||ping||String||"pong"||
||pid||String||The PID of IMGAPI server process. Only for non-"public" mode IMGAPI configurations.||
||version||String||The version of the IMGAPI app.||
||imgapi||Boolean||true||

When simulating an error, the HTTP response code depends on the error type
and the response body is an JSON object with:

||**Field**||**Type**||**Description**||
||code||String||A restify error code, e.g. "ResourceNotFound", "InternalError". ||
||message||String||Error message.||

### Examples

    $ sdc-imgapi /ping
    HTTP/1.1 200 OK
    Content-Type: application/json
    Content-Length: 45
    Date: Tue, 08 Jan 2013 19:52:42 GMT
    Server: IMGAPI/1.0.0
    x-request-id: f6f24850-59cc-11e2-b638-4b6ffa4ca56f
    x-response-time: 0
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "ping": "pong",
      "pid": 23097,
      "version": "1.0.0"
    }

Ping can also be used to simulate error responses from the IMGAPI:

    $ sdc-imgapi /ping?error=ValidationFailed
    HTTP/1.1 422 Unprocessable Entity
    Content-Type: application/json
    Content-Length: 56
    Date: Tue, 08 Jan 2013 19:53:31 GMT
    Server: IMGAPI/1.0.0
    x-request-id: 143dfa30-59cd-11e2-b638-4b6ffa4ca56f
    x-response-time: 0
    x-server-name: 70f0978d-7efa-4c45-8ebf-8cb9e3a887f7
    Connection: keep-alive

    {
      "code": "ValidationFailed",
      "message": "boom",
      "errors": []
    }

<!-- #else -->

## Ping (GET /ping)

A simple ping to check to health of the IMGAPI server.

### Returns

A "pong" object is returned:

||**Field**||**Type**||**Description**||
||ping||String||"pong"||
||version||String||The version of the IMGAPI app.||
||imgapi||Boolean||true||

### Examples

    $ curl -i https://images.joyent.com/ping
    HTTP/1.1 200 OK
    Date: Fri, 22 Feb 2013 23:52:18 GMT
    Content-Type: application/json
    Connection: keep-alive
    Content-Length: 60
    Server: Joyent Image API
    x-request-id: e41046a0-7d4a-11e2-8ad6-7ff4644169eb
    x-response-time: 1
    x-server-name: b908c5b2-ccd9-4f43-b5ff-2997eb6bd682.local

    {
      "ping": "pong",
      "version": "1.0.0",
      "imgapi": true
    }
<!-- #endif -->


<!-- #ifdef PRIVATE -->
## AdminGetState (GET /state)

Return server internal state. For debugging/dev only.

### Inputs

None.

### Returns

A JSON representation of some internal state.

### Example

    $ sdc-imgapi /state
    {
      "cache": {
        ...
      },
      "log": {
        "level": 20
      },
      ...
    }
<!-- #endif -->


<!-- #ifdef PRIVATE -->

# Configuration

Reference docs on configuration vars to imgapi. Default values are in
"etc/defaults.json". Custom values are provided in a JSON file passed in with
the "-f CFG-FILE" command-line option. By default this is
"./etc/imgapi.config.json". Note that given custom values override full
top-level keys in the factory settings. For example: if providing
'ufds', one must provide the whole 'ufds' object.

||**var**||**type**||**default**||**description**||
||port||Number||8080||Port number on which to listen.||
||serverName||String||IMGAPI/$version||Name of the HTTP server. This value is present on every HTTP response in the 'server' header.||
||logLevel||String or Number||debug||Level at which to log. One of the supported Bunyan log levels. This is overridden by the `-d|--debug` switch.||
||maxSockets||Number||100||Maximum number of sockets for external API calls||
||mode||String||public||One of 'public' (default, running as a public server e.g. images.joyent.com), 'private' (a ironically public server that only houses images marked `public=false`), or 'dc' (running as the IMGAPI in an SDC datacenter).||
||ufds.url||String||-||LDAP URL to connect to UFDS. Required if `mode === 'dc'`.||
||ufds.bindDN||String||-||UFDS root dn. Required if `mode === 'dc'`.||
||ufds.bindPassword||String||-||UFDS root dn password. Required if `mode === 'dc'`.||
||auth||Object||-||If in 'public' mode, then auth details are required. 'dc' mode does no auth.||
||auth.type||String||-||One of 'basic' (HTTP Basic Auth) or 'signature' ([HTTP Signature auth](https://github.com/joyent/node-http-signature)).||
||auth.users||Object||-||Required if `auth.type === 'basic'`. A mapping of username to bcrypt-hashed password. Use the `bin/hash-basic-auth-password` tool to create the hash.||
||auth.keys||Object||-||Required if `auth.type === 'signature'`. A mapping of username to an array of ssh public keys.||
||database||Object||-||Database info. The "database" is how the image manifest data is stored.||
||database.type||String||ufds||One of 'ufds' (the default, i.e. use an SDC UFDS directory service) or 'local'. The 'local' type is a quick implementation appropriate only for smallish numbers of images.||
||database.dir||String||-||The base directory for the database `database.type === 'local'`.||
||storage||Object||-||The set of available storage mechanisms for the image *files*. There must be at least one. See the [Image file storage](#image-file-storage) section for discussion.||
||storage.local||Object||-||Object holding config information for "local" disk storage.||
||storage.local.dir||String||-||The base directory in which to store image files for "local" storage.||
||storage.manta||Object||-||Object holding config information for Manta storage.||
||storage.manta.url||String||-||The Manta API URL.||
||storage.manta.insecure||Boolean||false||Ignore SSL certs on the Manta URL.||
||storage.manta.user||String||-||The Manta user under which to store data.||
||storage.manta.key||String||-||Path to the SSH private key file with which to authenticate to Manta.||
||storage.manta.keyId||String||-||The SSH public key ID (signature).||
||wfapi.url||String||-||The Workflow API URL.||
||wfapi.workflows||String||-||Array of workflows to load.||
||wfapi.forceReplace||Boolean||-||Wether to replace all workflows loaded every time the IMGAPI service is started. Ideal for development environments||



# Developer Guide

## Repositories

    node-sdc-clients.git    # Includes imgapi.js node library for using IMGAPI.
    node-imgmanifest.git    # Defines the SmartDataCenter Image manifest spec
                            #   and support for validation and upgrade.
    imgapi-cli.git          # `*-imgadm` tools for common IMGAPI servers,
                            #   e.g. `joyent-imgadm`, `sdc-imgadm`,
                            #   `updates-imgadm` and a framework for tools
                            #   for other IMGAPI servers.
    smartos-live.git        # Holds the SmartOS base `imgadm` tool
                            #   (in src/img). Currently in "imgadm2.git".
    imgapi.git              # The IMGAPI server


# Operator Guide

This section is intended to give necessary information for diagnosing and
dealing with issues with Image API in a SmartDataCenter installation.

There is one IMGAPI service per datacenter. There might actually be more than
one "imgapi" zone for HA. Use this to list the imgapi zones in a DC:

    sdc-vmapi /vms?owner_uuid=$(bash /lib/sdc/config.sh -json | json ufds_admin_uuid) \
        | json -H -c "tags.smartdc_role=='imgapi'"


## Health

An IMGAPI server has a "/ping" endpoint to indicate if it is up

    $ sdc-imgapi /ping

or if there are multiple IMGAPI servers:

    $ for ip in $(bash /lib/sdc/config.sh -json | json imgapi_admin_ips | tr ',' ' '); do \
        echo "# $ip" ; \
        curl -sS http://$ip/ping | json ; \
    done

TODO: sdc-healthcheck, sdc-webinfo


## Logs

||**service/path**||**where**||**format**||**tail -f**||
||imgapi||in each "imgapi" zone||[Bunyan](https://github.com/trentm/node-bunyan)||`` sdc-login imgapi; tail -f `svcs -L imgapi` | bunyan ``||


## Examples

1. Dig into IMGAPI's Manta storage (if this IMGAPI is setup to use Manta):

        HN=stage2    # my SDC headnode login

        # Get one of the Manta LB IPs:
        export MANTA_URL=https://$(ssh $HN "/opt/smartdc/bin/sdc-vmapi /vms?tag.manta_role=loadbalancer | json -H -c 'this.state==\"running\"' 0.nics | json -c 'this.nic_tag==\"external\"' 0.ip" 2>/dev/null)

        # Get a local copy of the admin SSH key being used for Manta access
        # (or add your own to the admin user).
        ZONENAME=$(ssh $HN vmadm lookup -1 alias=imgapi0)
        mkdir -p /var/tmp/$HN
        cd /var/tmp/$HN
        scp $HN:/zones/$ZONENAME/root/root/.ssh/id_rsa* .

        # This would be sufficient for python-manta and mantash:
        #    export MANTA_KEY_ID=`pwd`/id_rsa
        # However, node-manta tools are a little more picky. You need to
        # have your id_rsa in ~/.ssh or in your agent. So we'll do the
        # latter:
        chmod 0600 id_rsa*
        ssh-add `pwd`/id_rsa
        MANTA_KEY_ID=$(ssh-keygen -l -f id_rsa.pub | awk '{print $2}')

        export MANTA_USER=admin
        set | grep MANTA_

        # With mantash from python-manta:
        mantash -k find /admin/stor/imgapi

        # With node-manta tools:
        # TODO: I think node-manta tools don't support a non-default path
        # to the ssh key?


## Configuring IMGAPI for HTTPS

On SmartOS, IMGAPI can be deployed to support HTTPS with the use of Stud
(https://github.com/bumptech/stud) as a SSL/TLS termination proxy. Because of the
way Stud works we need to put an additional reverse proxy between Stud and IMGAPI:
HAProxy. The only caveat here is that the latest version of HAProxy doesn't
fully understand the traffic coming from Stud, so we use a patched version of
the package.

### Prerrequisites and Assumptions

* IMGAPI running on an Image with at least a 2012Q2 release of pkgsrc
* IMGAPI running on port 8080 if using configuration defaults
* Generated certficate file
* gmake

### Installing and Configuring HAProxy

The IMGAPI repository contains the patched copy of HAProxy under the deps/
directory. cd to that directory and proceed to compile HAProxy as follows:

    cd $IMGAPI_REPO/deps/haproxy-1.4.21/
    gmake TARGET=solaris

It's not necessary to move the resulting binary to another location. Now, we need
to configure HAProxy. This repository contains a sample configuration file (on
etc/haproxy.cfg.in) that will make the proxy listen on port 8443 and redirect
its traffic to port 8080.

The final step is to import the HAProxy SMF file in order to run the proxy as a
service. The IMGAPI repository contains a sample service definition file that
can be imported after updating the exec_method tag and config_file values to
reflect the current install setup. With a valid SMF file we can proceed to
import it and start running HAProxy:

    cp $IMGAPI_REPO/smf/manifests/haproxy.xml.in $IMGAPI_REPO/smf/manifests/haproxy.xml
    # --- Replace variables ---
    svccfg import $IMGAPI_REPO/smf/manifests/haproxy.xml
    svcadm enable haproxy:default

### Installing and configuring Stud

Configuring Stud is easier since it doesn't require a custom binary, we use the
version provided by pksrc. Additionally, pkgsrc provides a sample SMF and
configuration file to use for Stud. Begin by installing the package:

    # Install Stud
    pkgin -y in stud-0nb20120827

This package will write a sample configuration file to /opt/local/etc/stud.conf.
For this guide we assume that Stud will terminate and redirect its traffic to a
service listening on port 8443. The only additional value we need to modify
is pem-file, which specifies the location of the SSL certificate to use. After
updating the configuration file we enable the Stud SMF service, since the sample
SMF file was already imported (assuming we are OK with using
/opt/local/etc/stud.conf as the location for our configuration file):

    svcadm enable stud:default

At this point Stud, HAProxy and IMGAPI should all be running correctly. We can
confirm this with the help of the netstat command:

    netstat -f inet -an

    TCP: IPv4
       Local Address        Remote Address    Swind Send-Q Rwind Recv-Q    State
    -------------------- -------------------- ----- ------ ----- ------ -----------
          *.8080               *.*                0      0 128000      0 LISTEN
          *.8443               *.*                0      0 128000      0 LISTEN
    127.0.0.1.8081             *.*                0      0 128000      0 LISTEN
          *.443                *.*                0      0 128000      0 LISTEN


<!-- #endif -->
